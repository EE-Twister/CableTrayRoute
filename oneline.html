<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Simple one-line diagram editor.">
  <title>One-Line Diagram</title>
  <base href="/CableTrayRoute/">
  <link rel="icon" href="./icons/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="./style.css">
  <script src="https://cdn.jsdelivr.net/npm/handlebars@4.7.8/dist/handlebars.min.js"></script>
  <script type="module" src="./dataStore.mjs?v={{COMMIT_SHA}}" defer></script>
  <script type="module" src="./oneline.js?v={{COMMIT_SHA}}" defer></script>
  <script type="module" src="./dist/scenarios.js?v={{COMMIT_SHA}}" defer></script>
</head>
<body class="oneline-page">
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <nav class="top-nav">
    <button id="nav-toggle" class="nav-toggle" aria-label="Toggle navigation" aria-controls="nav-links" aria-expanded="false" title="Toggle navigation">â˜°</button>
    <div id="nav-links" class="nav-links">
      <a href="./index.html">Home</a>
      <a href="./equipmentlist.html">Equipment List</a>
      <a href="./loadlist.html">Load List</a>
      <a href="./cableschedule.html">Cable Schedule</a>
      <a href="./panelschedule.html">Panel Schedule</a>
      <a href="./racewayschedule.html">Raceway Schedule</a>
      <a href="./ductbankroute.html">Ductbank</a>
      <a href="./cabletrayfill.html">Tray Fill</a>
      <a href="./conduitfill.html">Conduit Fill</a>
      <a href="./optimalRoute.html">Optimal Route</a>
      <a href="./oneline.html" class="active" aria-current="page">One-Line</a>
      <button id="settings-btn" class="settings-btn" aria-label="Settings" aria-expanded="false" title="Settings">âš™</button>
    </div>
  </nav>
  <div id="settings-menu" class="settings-menu">
    <label><input type="checkbox" id="dark-toggle"> Dark Mode</label>
    <label><input type="checkbox" id="compact-toggle" aria-label="Enable compact table mode"> Compact Mode</label>
    <label for="unit-select">Units
      <select id="unit-select">
        <option value="imperial">Imperial</option>
        <option value="metric">Metric</option>
      </select>
    </label>
    <button id="help-btn" class="btn" aria-expanded="false" title="Show help">Site Help</button>
    <button id="new-project-btn" class="btn" title="Start a new project">New Project</button>
    <button id="save-project-btn" class="btn" title="Save current project">Save Project</button>
    <button id="load-project-btn" class="btn" title="Load an existing project">Load Project</button>
    <button id="export-project-btn" class="btn" title="Export project data">Export Project</button>
    <button id="import-project-btn" class="btn" title="Import project data">Import Project</button>
    <button id="export-reports-btn" class="btn" title="Export all reports">Export All Reports</button>
    <input type="file" id="import-project-input" accept=".ctr.json" class="hidden-input" title="Select project file">
    <button id="prefix-settings-btn" class="btn" title="Edit label prefixes">Label Prefixes</button>
    <button id="update-defaults-btn" class="btn" title="Update default settings">Update Defaults</button>
  </div>
  <div id="component-library-banner" class="message error hidden">
    Component library failed to load
    <button id="reload-library-btn" class="btn">Reload Library</button>
  </div>
  <div class="container">
    <main id="main-content" class="main-content">
      <header class="page-header">
        <h1>One-Line Diagram</h1>
        <p>Create and link components to schedules.</p>
      </header>
      <section class="card oneline-card">
        <div class="sheet-controls">
          <div class="scenario-controls">
            <div class="scenario-select-group">
              <label for="scenario-select" class="scenario-label">Scenario</label>
              <select id="scenario-select"></select>
            </div>
            <div class="scenario-action-group">
              <button id="scenario-duplicate-btn" type="button" class="btn">Duplicate</button>
              <button id="scenario-diff-btn" type="button" class="btn">Diff</button>
              <button id="revision-btn" type="button" class="btn">Revisions</button>
            </div>
          </div>
          <div id="sheet-tabs" class="sheet-tabs" role="tablist"></div>
          <div class="sheet-action-group">
            <button id="add-sheet-btn" class="icon-button" title="Add Sheet" aria-label="Add Sheet">+</button>
            <button id="rename-sheet-btn" class="icon-button" title="Rename Sheet" aria-label="Rename Sheet">âœŽ</button>
            <button id="delete-sheet-btn" class="icon-button" title="Delete Sheet" aria-label="Delete Sheet">ðŸ—‘</button>
            <button id="diagram-export-btn" type="button" class="icon-button" title="Export Diagram" aria-label="Export Diagram"><img src="./icons/toolbar/export.svg" alt=""></button>
            <input type="file" id="diagram-import-input" accept=".json" class="hidden-input">
            <button id="diagram-import-btn" type="button" class="icon-button" title="Import Diagram" aria-label="Import Diagram"><img src="./icons/toolbar/import.svg" alt=""></button>
            <button id="sample-diagram-btn" type="button" class="btn" title="Load sample diagram">Load Sample</button>
            <button id="diagram-share-btn" type="button" class="btn" title="Share diagram">Share</button>
            <button id="studies-panel-btn" type="button" class="btn" title="Open studies panel">Studies</button>
            <button id="tour-btn" type="button" class="btn" title="Start tour">Tour</button>
            <button id="export-oneline-data-btn" type="button" class="btn" title="Export one-line data and study results">Export One-Line Data</button>
          </div>
        </div>
        <div class="toolbar">
          <div class="toolbar-group" aria-label="Edit">
            <span class="toolbar-group-label">Edit</span>
            <button id="connect-btn" class="icon-button" title="Connect" aria-label="Connect"><img src="./icons/toolbar/connect.svg" alt=""></button>
            <button id="undo-btn" class="icon-button" title="Undo" aria-label="Undo"><img src="./icons/toolbar/undo.svg" alt=""></button>
            <button id="redo-btn" class="icon-button" title="Redo" aria-label="Redo"><img src="./icons/toolbar/redo.svg" alt=""></button>
          </div>
          <div class="toolbar-group" aria-label="Align">
            <span class="toolbar-group-label">Align</span>
            <button id="align-left-btn" class="icon-button" title="Align Left" aria-label="Align Left"><img src="./icons/toolbar/align-left.svg" alt=""></button>
            <button id="align-right-btn" class="icon-button" title="Align Right" aria-label="Align Right"><img src="./icons/toolbar/align-right.svg" alt=""></button>
            <button id="align-top-btn" class="icon-button" title="Align Top" aria-label="Align Top"><img src="./icons/toolbar/align-top.svg" alt=""></button>
            <button id="align-bottom-btn" class="icon-button" title="Align Bottom" aria-label="Align Bottom"><img src="./icons/toolbar/align-bottom.svg" alt=""></button>
            <button id="distribute-h-btn" class="icon-button" title="Distribute Horizontal" aria-label="Distribute Horizontal"><img src="./icons/toolbar/distribute-h.svg" alt=""></button>
            <button id="distribute-v-btn" class="icon-button" title="Distribute Vertical" aria-label="Distribute Vertical"><img src="./icons/toolbar/distribute-v.svg" alt=""></button>
          </div>
          <div class="toolbar-group" aria-label="Files">
            <span class="toolbar-group-label">Files</span>
            <div class="export-group">
              <button id="export-btn" class="icon-button" title="Export" aria-label="Export" aria-haspopup="true" aria-expanded="false"><img src="./icons/toolbar/export.svg" alt=""></button>
              <ul id="export-menu" class="export-menu" role="menu">
                <li data-format="pdf" role="menuitem">Export PDF</li>
                <li data-format="dxf" role="menuitem">Export DXF</li>
                <li data-format="dwg" role="menuitem">Export DWG</li>
              </ul>
            </div>
            <input type="file" id="import-input" accept=".json" class="hidden-input">
            <button id="import-btn" class="icon-button" title="Import" aria-label="Import"><img src="./icons/toolbar/import.svg" alt=""></button>
            <button id="validate-btn" class="icon-button" title="Validate" aria-label="Validate"><img src="./icons/toolbar/validate.svg" alt=""></button>
          </div>
          <div class="grid-controls toolbar-group" aria-label="Grid">
            <span class="toolbar-group-label">Grid</span>
            <label class="icon-button" title="Toggle Grid" aria-label="Toggle Grid">
              <input type="checkbox" id="grid-toggle" class="hidden-input" checked>
              <img src="./icons/toolbar/grid.svg" alt="">
            </label>
            <label class="icon-button" title="Grid size" aria-label="Grid size">
              <img src="./icons/toolbar/grid-size.svg" alt="">
              <input type="number" id="grid-size" value="20" min="1">
            </label>
          </div>
          <div class="toolbar-group" aria-label="Zoom">
            <span class="toolbar-group-label">Zoom</span>
            <div class="zoom-controls">
              <button id="zoom-out-btn" type="button" class="icon-button" title="Zoom out" aria-label="Zoom out">&minus;</button>
              <span id="zoom-display" aria-live="polite">100%</span>
              <button id="zoom-in-btn" type="button" class="icon-button" title="Zoom in" aria-label="Zoom in">+</button>
              <button id="zoom-reset-btn" type="button" class="btn" title="Reset zoom">Reset</button>
            </div>
            <div class="pan-controls" role="group" aria-label="Pan diagram">
              <button id="pan-up-btn" type="button" class="icon-button" title="Pan up" aria-label="Pan up">&#8593;</button>
              <div class="pan-middle-row">
                <button id="pan-left-btn" type="button" class="icon-button" title="Pan left" aria-label="Pan left">&#8592;</button>
                <button id="pan-right-btn" type="button" class="icon-button" title="Pan right" aria-label="Pan right">&#8594;</button>
              </div>
              <button id="pan-down-btn" type="button" class="icon-button" title="Pan down" aria-label="Pan down">&#8595;</button>
            </div>
          </div>
          <div class="toolbar-group" aria-label="View options">
            <span class="toolbar-group-label">View</span>
              <div class="view-group">
                <button id="view-menu-btn" type="button" class="btn" aria-haspopup="dialog" aria-expanded="false">Views</button>
            </div>
          </div>
          <div class="toolbar-group" aria-label="Find devices">
            <span class="toolbar-group-label">Find</span>
            <form id="find-device-form" class="find-device" role="search">
              <input type="search" id="find-device-input" name="device" placeholder="Device tag" aria-label="Device tag" autocomplete="off">
              <button type="submit" class="btn">Go</button>
            </form>
          </div>
        </div>
        <button id="palette-toggle" class="palette-toggle" aria-label="Toggle palette" aria-controls="palette" aria-expanded="false">â˜°</button>
        <div class="workspace">
          <aside id="palette" class="palette">
            <div id="component-buttons">
              <template id="palette-button-template">
                <button draggable="true" data-subtype="" title="Drag to canvas or click to add"></button>
              </template>
              <input type="text" id="palette-search" placeholder="Search" aria-label="Filter components">
              <div class="palette-scroll">
                <div class="palette-card card">
                  <h3>Sources</h3>
                  <details id="sources-section" class="palette-section">
                    <summary><img src="./icons/sources.svg" alt="" class="summary-icon"> Sources</summary>
                    <div id="sources-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="palette-card card">
                  <h3>Equipment</h3>
                  <details id="equipment-section" class="palette-section">
                    <summary><img src="./icons/equipment.svg" alt="" class="summary-icon"> Equipment</summary>
                    <div id="equipment-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="palette-card card">
                  <h3>Protection</h3>
                  <details id="protection-section" class="palette-section">
                    <summary><img src="./icons/components/Breaker.svg" alt="" class="summary-icon"> Protection</summary>
                    <div id="protection-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="palette-card card">
                  <h3>Bus</h3>
                  <details id="bus-section" class="palette-section">
                    <summary><img src="./icons/Bus.svg" alt="" class="summary-icon"> Bus</summary>
                    <div id="bus-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="palette-card card">
                  <h3>Load</h3>
                  <details id="load-section" class="palette-section">
                    <summary><img src="./icons/load.svg" alt="" class="summary-icon"> Load</summary>
                    <div id="load-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="palette-card card">
                  <h3>Cable</h3>
                  <details id="cable-section" class="palette-section">
                    <summary><img src="./icons/oneline.svg" alt="" class="summary-icon"> Cable</summary>
                    <div id="cable-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="palette-card card">
                  <h3>Links</h3>
                  <details id="links-section" class="palette-section">
                    <summary><img src="./icons/links.svg" alt="" class="summary-icon"> Links</summary>
                    <div id="links-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="palette-card card">
                  <h3>Annotations</h3>
                  <details id="annotations-section" class="palette-section">
                    <summary><img src="./icons/annotation.svg" alt="" class="summary-icon"> Annotations</summary>
                    <div id="annotations-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="palette-card card">
                  <h3>Templates</h3>
                  <details id="template-section" class="palette-section">
                    <summary><img src="./icons/oneline.svg" alt="" class="summary-icon"> Templates</summary>
                    <div id="template-buttons" class="section-buttons"></div>
                  </details>
                </div>
                <div class="create-component-footer">
                  <a href="./custom-components.html" class="btn create-component-btn" title="Design a new custom component">Create Component</a>
                </div>
              </div>
            </div>
          </aside>
          <div class="splitter"></div>
          <div class="oneline-editor">
            <div class="oneline-canvas-scroll">
              <svg id="diagram" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse">
                    <path d="M20 0 L0 0 0 20" fill="none" stroke="#ccc" stroke-width="0.5" />
                  </pattern>
                  <marker id="connection-x" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto" markerUnits="strokeWidth">
                    <path d="M0,0 L10,10 M0,10 L10,0" fill="none" stroke="context-stroke" stroke-width="2" />
                  </marker>
                </defs>
                <rect id="grid-bg" width="100%" height="100%" fill="url(#grid)" />
              </svg>
              <div id="voltage-legend" class="voltage-legend"></div>
              <div id="prop-modal" class="prop-modal"><!-- populated dynamically --></div>
              <div id="cable-modal" class="prop-modal"></div>
              <div id="validation-modal" class="prop-modal"></div>
              <div id="defaults-modal" class="prop-modal"></div>
              <ul id="context-menu" class="context-menu">
                <li data-action="edit" data-context="component">Edit Properties</li>
                <li data-action="rename" data-context="component">Rename</li>
                <li data-action="disconnect" data-context="component">Disconnect</li>
                <li data-action="duplicate" data-context="component">Duplicate</li>
                <li data-action="rotate" data-context="component">Rotate</li>
                <li data-action="delete" data-context="component">Delete</li>
                <li data-action="edit" data-context="connection">Edit Connection</li>
                <li data-action="delete" data-context="connection">Delete Connection</li>
                <li data-action="paste" data-context="canvas">Paste</li>
              </ul>
            </div>
          </div>
        </div>
        </section>
    </main>
  </div>
  <aside id="studies-panel" class="studies-panel hidden" aria-label="Studies">
    <div id="studies-resize-handle" class="studies-resize-handle" aria-hidden="true"></div>
    <div class="studies-content">
      <div class="studies-header">
        <h2>Studies</h2>
        <button id="studies-close-btn" class="studies-close-btn" aria-label="Close" title="Close">&times;</button>
      </div>
      <div class="studies-controls">
        <button id="run-loadflow-btn" type="button">Load Flow</button>
        <button id="run-shortcircuit-btn" type="button">Short Circuit</button>
        <button id="run-arcflash-btn" type="button">Arc Flash</button>
        <button id="run-harmonics-btn" type="button">Harmonics</button>
        <button id="run-motorstart-btn" type="button">Motor Start</button>
        <button id="run-reliability-btn" type="button">Reliability</button>
        <button id="study-settings-btn" type="button" class="btn" aria-expanded="false">Settings</button>
        <label class="d-block mt-1"><input type="checkbox" id="toggle-overlays" checked> Show Result Overlays</label>
      </div>
      <form id="study-settings-menu" class="study-settings hidden" aria-label="Study settings">
        <fieldset>
          <legend>Load Flow</legend>
          <label for="study-loadflow-basemva">Base MVA
            <input type="number" id="study-loadflow-basemva" min="1" step="1">
          </label>
          <label for="study-loadflow-iterations">Max Iterations
            <input type="number" id="study-loadflow-iterations" min="1" step="1">
          </label>
          <label class="inline-control">
            <input type="checkbox" id="study-loadflow-balanced">
            <span>Balanced solution</span>
          </label>
        </fieldset>
        <fieldset>
          <legend>Short Circuit</legend>
          <label for="study-shortcircuit-method">Method
            <select id="study-shortcircuit-method">
              <option value="IEC">IEC 60909</option>
              <option value="ANSI">ANSI</option>
            </select>
          </label>
        </fieldset>
      </form>
      <div class="study-results-wrapper">
        <button id="study-results-copy-btn" type="button" class="icon-button study-results-copy-btn" aria-label="Copy study results" title="Copy study results">
          <img src="./icons/toolbar/copy.svg" alt="">
        </button>
        <pre id="study-results" class="study-results"></pre>
      </div>
      <div id="loadflow-results" class="study-results"></div>
    </div>
  </aside>
  <aside id="lint-panel" class="lint-panel hidden" aria-label="Validation issues">
    <div class="lint-header">
      <h2>Fix-it Hints</h2>
      <button id="lint-close-btn" class="lint-close-btn" aria-label="Close" title="Close">&times;</button>
    </div>
    <ul id="lint-list"></ul>
  </aside>
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <ul id="palette-context-menu" class="context-menu" role="menu">
    <li data-action="edit" role="menuitem">Edit Component</li>
  </ul>
  <script type="module" src="./dist/projectManager.js"></script>
</body>
</html>
