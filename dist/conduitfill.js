!function(){"use strict";window.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll(".workflow-grid .workflow-card").forEach(e=>{const t=e.dataset.storageKey,n=e.querySelector(".status");if(!n)return;let o=!1;"racewaySchedule"===t?o=["ductbankSchedule","traySchedule","conduitSchedule"].some(e=>localStorage.getItem(e)):"optimalRoute"===t?o=["cableSchedule","traySchedule"].every(e=>localStorage.getItem(e)):t&&(o=!!localStorage.getItem(t)),o?(e.classList.add("complete"),n.textContent="✓",n.setAttribute("aria-label","Completed")):n.textContent="Incomplete"})});const e="a[href],button:not([disabled]),textarea:not([disabled]),input:not([disabled]),select:not([disabled]),[tabindex]:not([tabindex='-1'])";function t(t,n){if("Tab"!==t.key)return;const o=n.querySelectorAll(e);if(!o.length)return;const r=o[0],d=o[o.length-1];t.shiftKey&&document.activeElement===r?(t.preventDefault(),d.focus()):t.shiftKey||document.activeElement!==d||(t.preventDefault(),r.focus())}document.addEventListener("DOMContentLoaded",function(){document.addEventListener("keydown",e=>{if("ArrowUp"!==e.key&&"ArrowDown"!==e.key)return;const t=e.target;if(!["INPUT","SELECT","TEXTAREA"].includes(t.tagName))return;const n=t.closest("td");if(!n||!n.closest("table"))return;const o=n.parentElement,r=n.cellIndex,d="ArrowUp"===e.key?o.previousElementSibling:o.nextElementSibling;if(!d)return;const a=d.cells[r];if(!a)return;const l=a.querySelector("input, select, textarea");l&&(e.preventDefault(),l.focus(),"function"==typeof l.select&&l.select())})}),window.initSettings=function(){const n=document.getElementById("settings-btn"),o=document.getElementById("settings-menu");if(n&&o){o.setAttribute("role","dialog"),o.setAttribute("aria-modal","true"),o.setAttribute("aria-hidden","true");let r=!1;const d=e=>{"Escape"===e.key?l():t(e,o)},a=()=>{r=!0,o.style.display="flex",o.setAttribute("aria-hidden","false"),n.setAttribute("aria-expanded","true"),document.addEventListener("keydown",d);const t=o.querySelectorAll(e);t.length&&t[0].focus()},l=()=>{r&&(r=!1,o.style.display="none",o.setAttribute("aria-hidden","true"),n.setAttribute("aria-expanded","false"),document.removeEventListener("keydown",d),n.focus())};n.addEventListener("click",()=>{r?l():a()}),document.addEventListener("click",e=>{r&&!o.contains(e.target)&&e.target!==n&&l()})}},window.initDarkMode=function(){const e=document.getElementById("dark-toggle"),t=JSON.parse(localStorage.getItem("ctrSession")||"{}");if(void 0===t.darkMode){const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;t.darkMode=e,localStorage.setItem("ctrSession",JSON.stringify(t))}document.body.classList.toggle("dark-mode",t.darkMode),e&&(e.checked=!!t.darkMode),e&&e.addEventListener("change",()=>{document.body.classList.toggle("dark-mode",e.checked),t.darkMode=e.checked,localStorage.setItem("ctrSession",JSON.stringify(t)),"function"==typeof window.saveSession&&window.saveSession(),"function"==typeof window.saveDuctbankSession&&window.saveDuctbankSession()}),window.addEventListener("storage",t=>{if("ctrSession"===t.key)try{const n=JSON.parse(t.newValue);document.body.classList.toggle("dark-mode",n&&n.darkMode),e&&(e.checked=!(!n||!n.darkMode))}catch{}})},window.initHelpModal=function(n="help-btn",o="help-modal",r){const d=document.getElementById(n),a=document.getElementById(o),l=r?document.getElementById(r):a?a.querySelector(".close-btn"):null;if(d&&a&&l){a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.setAttribute("aria-hidden","true");const n=e=>{"Escape"===e.key?r():t(e,a)},o=()=>{a.style.display="flex",a.setAttribute("aria-hidden","false"),d.setAttribute("aria-expanded","true"),document.addEventListener("keydown",n);const t=a.querySelectorAll(e);t.length&&t[0].focus()},r=()=>{a.style.display="none",a.setAttribute("aria-hidden","true"),d.setAttribute("aria-expanded","false"),document.removeEventListener("keydown",n),d.focus()};d.addEventListener("click",o),l.addEventListener("click",r),a.addEventListener("click",e=>{e.target===a&&r()})}},window.initNavToggle=function(){const e=document.querySelector(".top-nav");if(!e)return;const t=e.querySelector(".nav-toggle");t&&t.addEventListener("click",()=>{e.classList.toggle("open")})},window.checkPrereqs=function(e=[]){const t=e.filter(e=>!localStorage.getItem(e.key));t.length&&document.addEventListener("DOMContentLoaded",()=>{const e=document.createElement("div");e.style.cssText="background:#fee;border:1px solid #f99;padding:10px;margin:10px;",e.innerHTML="Missing required data: "+t.map(e=>`<a href="${e.page}">${e.label}</a>`).join(", ")+".",document.body.prepend(e)})},checkPrereqs([{key:"conduitSchedule",page:"racewayschedule.html",label:"Raceway Schedule"}]);const n={EMT:{"1/2":.304,"3/4":.533,1:.864,"1-1/4":1.496,"1-1/2":2.036,2:3.356,"2-1/2":5.858,3:8.846,"3-1/2":11.545,4:14.753},ENT:{"1/2":.285,"3/4":.508,1:.832,"1-1/4":1.453,"1-1/2":1.986,2:3.291},FMC:{"3/8":.116,"1/2":.317,"3/4":.533,1:.817,"1-1/4":1.277,"1-1/2":1.858,2:3.269,"2-1/2":4.909,3:7.069,"3-1/2":9.621,4:12.566},IMC:{"1/2":.342,"3/4":.586,1:.959,"1-1/4":1.647,"1-1/2":2.225,2:3.63,"2-1/2":5.135,3:7.922,"3-1/2":10.584,4:13.631},"LFNC-A":{"3/8":.192,"1/2":.312,"3/4":.535,1:.854,"1-1/4":1.502,"1-1/2":2.018,2:3.343},"LFNC-B":{"3/8":.192,"1/2":.314,"3/4":.541,1:.873,"1-1/4":1.528,"1-1/2":1.981,2:3.246},LFMC:{"3/8":.192,"1/2":.314,"3/4":.541,1:.873,"1-1/4":1.277,"1-1/2":1.858,2:3.269,"2-1/2":4.881,3:7.475,"3-1/2":9.731,4:12.692},RMC:{"1/2":.314,"3/4":.549,1:.887,"1-1/4":1.526,"1-1/2":2.071,2:3.408,"2-1/2":4.866,3:7.499,"3-1/2":10.01,4:12.882,5:20.212,6:29.158},"PVC Sch 80":{"1/2":.217,"3/4":.409,1:.688,"1-1/4":1.237,"1-1/2":1.711,2:2.874,"2-1/2":4.119,3:6.442,"3-1/2":8.688,4:11.258,5:17.855,6:25.598},"PVC Sch 40":{"1/2":.285,"3/4":.508,1:.832,"1-1/4":1.453,"1-1/2":1.986,2:3.291,"2-1/2":4.695,3:7.268,"3-1/2":9.737,4:12.554,5:19.761,6:28.567},"PVC Type A":{"1/2":.385,"3/4":.65,1:1.084,"1-1/4":1.767,"1-1/2":2.324,2:3.647,"2-1/2":5.453,3:8.194,"3-1/2":10.694,4:13.723},"PVC Type EB":{2:3.874,3:8.709,"3-1/2":11.365,4:14.448,5:22.195,6:31.53}};document.addEventListener("DOMContentLoaded",()=>{initSettings(),initDarkMode(),initHelpModal("help-btn","help-modal","close-help-btn"),initNavToggle();let e=!0;const t=()=>{e=!0},o=()=>{e=!1};window.addEventListener("beforeunload",t=>{e||(t.preventDefault(),t.returnValue="")});const r=document.getElementById("conduitType"),d=document.getElementById("tradeSize"),a=document.querySelector("#cableTable tbody");function l(e){if(e.includes("-")){const[t,n]=e.split("-"),[o,r]=n.split("/");return parseFloat(t)+parseFloat(o)/parseFloat(r)}if(e.includes("/")){const[t,n]=e.split("/");return parseFloat(t)/parseFloat(n)}return parseFloat(e)}function i(){d.innerHTML="";const e=n[r.value]||{};Object.keys(e).sort((e,t)=>l(e)-l(t)).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,d.appendChild(t)})}function c(){const e=document.createElement("tr"),t=document.createElement("td"),n=document.createElement("input");n.type="text",n.style.width="120px",t.appendChild(n),e.appendChild(t);const o=document.createElement("td"),r=document.createElement("select");["Power","Control","Signal"].forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),r.style.width="100px",o.appendChild(r),e.appendChild(o);const d=document.createElement("td"),l=document.createElement("input");l.type="number",l.min="1",l.step="1",l.style.width="60px",d.appendChild(l),e.appendChild(d);const i=document.createElement("td"),s=document.createElement("input");s.type="text",s.setAttribute("list","sizeList"),s.style.width="100px",i.appendChild(s),e.appendChild(i);const u=document.createElement("td"),m=document.createElement("input");m.type="number",m.step="0.01",m.style.width="80px",u.appendChild(m),e.appendChild(u);const p=document.createElement("td"),h=document.createElement("button");h.type="button",h.textContent="⧉",h.className="duplicateBtn",h.addEventListener("click",()=>{const t=c();t.children[0].querySelector("input").value=n.value,t.children[1].querySelector("select").value=r.value,t.children[2].querySelector("input").value=l.value,t.children[3].querySelector("input").value=s.value,t.children[4].querySelector("input").value=m.value,a.insertBefore(t,e.nextSibling)}),p.appendChild(h),e.appendChild(p);const g=document.createElement("td"),y=document.createElement("button");return y.type="button",y.textContent="✖",y.className="removeBtn",y.addEventListener("click",()=>{a.removeChild(e)}),g.appendChild(y),e.appendChild(g),e}document.getElementById("addCableBtn").addEventListener("click",()=>{a.appendChild(c()),o()}),Object.keys(n).forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),i(),document.getElementById("addCableBtn").click(),r.addEventListener("change",e=>{i(),o()});let s=null,u=null;function m(e,t,n,o){const r=t*n,d=2*t*n*.8/(.6*Math.max(1,e.length));return Math.max(o,Math.min(r,d))}document.getElementById("drawBtn").addEventListener("click",()=>{const e=r.value,t=d.value,o=n[e][t],l=Math.sqrt(o/Math.PI),i=Array.from(a.querySelectorAll("tr")),c=[];for(const e of i){const t=e.children[0].querySelector("input").value.trim(),n=parseFloat(e.children[4].querySelector("input").value);if(!t)return void alert("Each cable requires a Tag.");if(isNaN(n))return void alert("Each cable requires an OD.");c.push({tag:t,r:n/2})}if(0===c.length)return void alert("Add at least one cable.");const p=function(e,t){const n=[];function o(e,n){return Math.sqrt(Math.max(0,(t-n)*(t-n)-e*e))}e.sort((e,t)=>t.r-e.r);for(const r of e){let e=null,d=-1/0;const a=t-r.r,l=Math.max(.05,r.r/4);for(let t=-a;t<=a;t+=l){let a=o(t,r.r);for(const e of n){const n=t-e.x;if(Math.abs(n)<e.r+r.r){const t=Math.sqrt((e.r+r.r)*(e.r+r.r)-n*n);a=Math.min(a,e.y-t)}}a>d&&(d=a,e={x:t,y:a})}if(e){let t=o(e.x,r.r);for(const o of n){const n=e.x-o.x;if(Math.abs(n)<o.r+r.r){const e=Math.sqrt((o.r+r.r)*(o.r+r.r)-n*n);t=Math.min(t,o.y-e)}}n.push({x:e.x,y:t,r:r.r,tag:r.tag})}else n.push({x:0,y:0,r:r.r,tag:r.tag})}return n}(c,l),h=c.reduce((e,t)=>e+Math.PI*t.r**2,0)/o*100,g=1===c.length?53:2===c.length?31:40;let y=`<p><strong>Conduit:</strong> ${e} ${t}" (ID ${(2*l).toFixed(2)}")</p>`;y+=`<p><strong>Fill:</strong> ${h.toFixed(1)} % (Allowed ${g}% )</p>`,h>g&&(y+='<p class="warning">WARNING: Fill exceeds allowable limit.</p>');let f=null;if(3===c.length)for(const e of c){const t=l/e.r;if(t>=2.8&&t<=3.2){f=t;break}}null!==f&&(y+=`<p class="warning">WARNING: Jam ratio ${f.toFixed(2)} (between 2.8 and 3.2) for one or more cables.</p>`),document.getElementById("results").innerHTML=y,function(e,t){const n=40,o=2*e*n+20,r=10+e*n;let d=`<svg width="${o}" height="${o}" viewBox="0 0 ${o} ${o}" xmlns="http://www.w3.org/2000/svg">`;d+=`<circle cx="${r}" cy="${r}" r="${e*n}" fill="none" stroke="black" stroke-width="2"/>`,d+=`<text x="${r}" y="${r-e*n+16}" font-size="12" text-anchor="middle">ID: ${(2*e).toFixed(2)}"</text>`,t.forEach(e=>{if(d+=`<circle cx="${r+e.x*n}" cy="${r+e.y*n}" r="${e.r*n}" fill="lightblue" stroke="black" stroke-width="1"/>`,e.tag){let t=m(e.tag,e.r,n,8);t=Math.min(t,e.r*n*.9);const o=r+e.x*n,a=r+e.y*n;d+=`<text x="${o}" y="${a}" font-size="${t}" text-anchor="middle" dominant-baseline="middle">${e.tag}</text>`,d+=`<text x="${o}" y="${a+.8*t}" font-size="${Math.max(6,.7*t)}" text-anchor="middle" dominant-baseline="hanging">${(2*e.r).toFixed(2)}"</text>`}}),d+="</svg>",document.getElementById("svgContainer").innerHTML=d,s=e,u=t}(l,p)}),document.getElementById("expandBtn").addEventListener("click",()=>{if(!u)return void alert("Please draw the conduit first, then expand.");const e=160,t=2*s*e+20,n=10+s*e;let o=`<svg width="${t}" height="${t}" viewBox="0 0 ${t} ${t}" xmlns="http://www.w3.org/2000/svg">`;o+=`<circle cx="${n}" cy="${n}" r="${s*e}" fill="none" stroke="black" stroke-width="2"/>`,o+=`<text x="${n}" y="${n-s*e+20}" font-size="20" text-anchor="middle">ID: ${(2*s).toFixed(2)}"</text>`,u.forEach(t=>{if(o+=`<circle cx="${n+t.x*e}" cy="${n+t.y*e}" r="${t.r*e}" fill="lightblue" stroke="black" stroke-width="1"/>`,t.tag){const r=m(t.tag,t.r,e,16),d=n+t.x*e,a=n+t.y*e;o+=`<text x="${d}" y="${a}" font-size="${r}" text-anchor="middle" dominant-baseline="middle">${t.tag}</text>`,o+=`<text x="${d}" y="${a+.9*r}" font-size="${Math.max(8,.8*r)}" text-anchor="middle" dominant-baseline="hanging">${(2*t.r).toFixed(2)}"</text>`}}),o+="</svg>",document.getElementById("expandedSVG").innerHTML=o,document.getElementById("overlay").style.display="flex"}),document.getElementById("copyBtn").addEventListener("click",()=>{const e=document.getElementById("expandedSVG").querySelector("svg");if(!e)return void alert("No expanded SVG found to copy.");const t=e.outerHTML;navigator.clipboard.writeText(t).then(()=>{alert("SVG markup copied to clipboard!")}).catch(e=>{alert("Error copying SVG: "+e)})}),document.getElementById("printBtn").addEventListener("click",()=>{const e=document.getElementById("expandedSVG").querySelector("svg");if(!e)return void alert("No expanded SVG found to print.");const t=e.outerHTML,n=window.open("","_blank");n.document.write(`<!DOCTYPE html><html><head><title>Print Conduit</title></head><body style="margin:0;">${t}</body></html>`),n.document.close(),n.focus(),setTimeout(()=>{n.print()},200)}),document.getElementById("copyPngBtn").addEventListener("click",()=>{const e=document.getElementById("expandedSVG").querySelector("svg");if(!e)return void alert("No expanded SVG found to copy as PNG.");const t=(new XMLSerializer).serializeToString(e),n=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),o=URL.createObjectURL(n),r=new Image;r.onload=()=>{const t=document.createElement("canvas");t.width=e.getAttribute("width"),t.height=e.getAttribute("height");const n=t.getContext("2d");n.fillStyle="#ffffff",n.fillRect(0,0,t.width,t.height),n.drawImage(r,0,0),t.toBlob(e=>{if(!e)return alert("Failed to create PNG blob."),void URL.revokeObjectURL(o);const t=new ClipboardItem({"image/png":e});navigator.clipboard.write([t]).then(()=>{alert("PNG copied to clipboard!"),URL.revokeObjectURL(o)}).catch(e=>{alert("Error copying PNG: "+e),URL.revokeObjectURL(o)})},"image/png")},r.onerror=()=>{alert("Failed to load SVG for PNG conversion."),URL.revokeObjectURL(o)},r.src=o}),document.getElementById("popupClose").addEventListener("click",()=>{document.getElementById("overlay").style.display="none"}),["conduitType","tradeSize"].forEach(e=>{const t=document.getElementById(e);t&&(t.addEventListener("input",o),t.addEventListener("change",o))}),a.addEventListener("input",o),a.addEventListener("click",e=>{"BUTTON"===e.target.tagName&&o()}),["copyPngBtn","printBtn","copyBtn"].forEach(e=>{const n=document.getElementById(e);n&&n.addEventListener("click",t)});const p=localStorage.getItem("conduitFillData");if(p){try{const{type:e,tradeSize:t,cables:n}=JSON.parse(p);e&&(r.value=e,i()),t&&(d.value=t),Array.isArray(n)&&(a.innerHTML="",n.forEach(e=>{const t=c();t.children[0].querySelector("input").value=e.name||e.tag||"",t.children[1].querySelector("select").value=e.cable_type||"",t.children[2].querySelector("input").value=e.conductors||"",t.children[3].querySelector("input").value=e.conductor_size||"",t.children[4].querySelector("input").value=(e.diameter||e.od||e.OD||0).toFixed(2),a.appendChild(t)})),document.getElementById("drawBtn").click()}catch(e){console.error("Failed to load conduitFillData",e)}localStorage.removeItem("conduitFillData")}})}();
