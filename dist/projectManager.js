function e(e){if("string"==typeof e)try{return t(JSON.parse(e))}catch{return function(e){const t=[],n=[],r=/#\d+=IFC([^;]*?)SEGMENT[^;]*?IFCPOLYLINE\(\(([^)]+)\),\(([^)]+)\)\)/gi;let s,o=0;for(;s=r.exec(e);){const e=s[1]||"",r=s[2].split(",").map(e=>parseFloat(e)),i=s[3].split(",").map(e=>parseFloat(e)),a={id:"SEG-"+o++,start_x:r[0],start_y:r[1],start_z:r[2],end_x:i[0],end_y:i[1],end_z:i[2]};/CABLECARRIER/i.test(e)?t.push(a):n.push(a)}return{trays:t,conduits:n}}(e)}return t(e)}function t(e){if(!e||"object"!=typeof e)return{trays:[],conduits:[]};const t=[],n=[],o=e.trays||e.Trays||e.cableTrays||e.CableTrays||[];for(const e of o)t.push(r(e));const i=e.conduits||e.Conduits||e.cableConduits||e.ConduitSegments||[];for(const e of i)n.push(s(e));return{trays:t,conduits:n}}function n(e){const t=parseFloat(e);return Number.isFinite(t)?t:void 0}function r(e={}){return{id:e.id||e.tag||e.tray_id||e.TrayID||e.name||e.Tag||"",start_x:n(e.start_x??e.sx??e.x1??e.StartX??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.StartY??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.StartZ??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.EndX??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.EndY??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.EndZ??e.end?.z),width:n(e.width??e.w??e.Width??e.size_x),height:n(e.height??e.h??e.Height??e.size_y)}}function s(e={}){return{conduit_id:e.conduit_id||e.id||e.tag||e.ConduitID||"",type:e.type||e.conduit_type||e.Type||"",trade_size:e.trade_size||e.tradeSize||e.size||e.TradeSize||"",start_x:n(e.start_x??e.sx??e.x1??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.end?.z),capacity:n(e.capacity??e.fill)}}const o="CTR_PROJECT_V1",i="ctr_scenarios_v1",a="ctr_current_scenario_v1",c="CTR_SAVED_PROJECTS_V1",u="CTR_CONDUITS",l="authToken",d="authCsrfToken",f="authExpiresAt",y="authUser",p="undefined"!=typeof document&&document.baseURI?new URL("dist/vendor/fast-json-patch.mjs",document.baseURI).href:"undefined"!=typeof location&&location.href?new URL("dist/vendor/fast-json-patch.mjs",location.href).href:"./dist/vendor/fast-json-patch.mjs";function h(){return{name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}}}function m(e={}){const t=e.settings||{session:e.session||e.ctrSession||{},collapsedGroups:e.collapsedGroups||{}};return t.units||(t.units="imperial"),{name:e.name||"",ductbanks:e.ductbanks||e.ductbankSchedule||[],conduits:e.conduits||e.conduitSchedule||[],trays:e.trays||e.traySchedule||[],cables:e.cables||e.cableSchedule||[],settings:t}}let g,b,S,v={name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}};const w=[],j=[];let A=new Set;const k=new Set,E=new Map;let C=!1,L=!1;const x=2621440,O=new Set;let _=["base"],N="base",P=null,T={},J=!1,z=null;const I=new Set;function R(e){const t=ve();if(t){const n=ke(t,e);if(null!=n)return n}return E.has(e)?E.get(e):null}function D(e,t,n={}){const r=Boolean(n&&n.skipLocalStorage);null==t?E.delete(e):E.set(e,t);const s=ve();if(s&&!C&&(!r||null==t))try{null==t?s.removeItem(e):s.setItem(e,t)}catch(t){we("project storage write failed",e,t)}}function F(e){return"string"!=typeof e?"":e.trim()}function q(e){const t=Array.isArray(e)?e.map(F).filter(Boolean):[];return t.length||t.push("base"),[...new Set(t)]}function $(){_=q(_),_.includes(N)||_.push(N),D(i,JSON.stringify(_)),D(a,N)}function M(e,t){return`${e}:${t}`}function G(e,t){return R(M(e,t))}function U(e,t,n,r){D(M(e,t),n,r)}function V(){return[..._]}function B(e){_=q(e),_.includes(N)||_.push(N),$()}function H(e){const t=F(e);t&&(_.includes(t)||(_.push(t),$()))}function K(){return N}function Y(e){const t=F(e)||"base";N=t,_.includes(t)||_.push(t),$()}function Q(e,t,n=N){const r=G(F(n)||N,e);return null==r?t:Ee(r,t)}function W(e,t,n=N){const r=F(n)||N;try{const n=JSON.stringify(t),s=M(r,e);if(n.length>x){if(U(r,e,n,{skipLocalStorage:!0}),r===N&&Te(e,n),!O.has(s)){O.add(s);const e=2.5.toFixed(1);console.warn(`Scenario entry "${s}" exceeds ${e}MB. Data will persist for this tab only; use Save Project to keep a copy.`)}return}U(r,e,n),r===N&&Te(e,n)}catch(t){console.error("scenario write failed",e,t)}}function X(e,t=N){const n=F(t)||N;U(n,e,null),n===N&&Je(e)}function Z(e=N){return function(e){const t=new Set,n=ve();if(n)try{for(let r=0;r<n.length;r++){const s=n.key(r);s&&s.startsWith(e)&&t.add(s.slice(e.length))}}catch(e){console.warn("project storage enumerate failed",e)}for(const n of E.keys())n.startsWith(e)&&t.add(n.slice(e.length));return[...t]}(`${F(e)||N}:`)}function ee(e,t){const n=F(e)||N,r=F(t);if(!r)return;const s=Z(n);for(const e of s){const t=G(n,e);null!=t&&(U(r,e,t),r===N&&Te(e,t))}}const te=["equipment","panels","loads","cables","raceways","oneLine"],ne=new Set(te.filter(e=>"equipment"!==e));class re extends Error{constructor(e,t){super(e),this.name="SavedProjectMigrationError",t&&(this.cause=t)}}function se(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}function oe(e){if(void 0!==e)return JSON.parse(JSON.stringify(e))}function ie(e){return JSON.parse(JSON.stringify(e||{}))}function ae(){const e=new Map,t=new Set(te);for(const n of function(){const e=new Set,t=ve();if(t)try{for(let n=0;n<t.length;n++){const r=t.key(n);r&&e.add(r)}}catch(e){console.warn("project storage enumerate failed",e)}for(const t of E.keys())e.add(t);return[...e]}()){const r=n.indexOf(":");if(r<=0)continue;const s=n.slice(r+1);if(!t.has(s))continue;const o=n.slice(0,r);let i=e.get(o);i||(i={data:{},suffixes:new Set,keys:[]},e.set(o,i)),i.keys.push(n),i.suffixes.add(s);const a=R(n);if(null==a)continue;let c;try{c=JSON.parse(a)}catch(e){throw new re(`Saved project "${o}" could not be migrated because the "${s}" section is corrupted. Clear the saved project from browser storage and save again.`,e)}i.data[s]=c}if(!e.size)return null;const n={},r=[];for(const[t,s]of e){[...s.suffixes].some(e=>ne.has(e))&&(Object.keys(s.data).length&&(n[t]=ie(s.data),r.push(...s.keys)))}return Object.keys(n).length?{records:n,keysToRemove:r}:null}function ce(){if(z)throw z;if(Object.keys(T).length)try{D(c,JSON.stringify(T))}catch(e){const t=e instanceof Error?e:new Error(String(e)),n=t instanceof re?t:new re("Saved projects could not be written to storage.",t);throw z=n,n}else D(c,null)}function ue(){if(!J){J=!0,z=null,I.clear();try{const e=function(){const e=R(c);if(null==e)return{};let t;try{t=JSON.parse(e)}catch(e){throw new re("Saved projects could not be read because the stored data is corrupted. Clear the saved projects entry in browser storage and try again.",e)}if(!se(t))throw new re("Saved projects could not be read because the stored data is in an unexpected format.");return t}(),t=ae();if(t){const n=new Set(Object.keys(e));for(const e of Object.keys(t.records))n.has(e)||I.add(e);T={...t.records,...e},ce();for(const e of t.keysToRemove)D(e,null)}else T=e}catch(e){const t=e instanceof Error?e:new Error(String(e));z=t,T={},console.error("Saved project initialization failed",t)}}}function le(){return ue(),z}function de(){return ue(),z?[]:Object.keys(T).sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}))}function fe(e,t={}){const n="string"==typeof e?e.trim():"";if(!n)return;if(ue(),z)throw z;const r=t&&"object"==typeof t?Object.entries(t):[];if(!r.length)return;const s=se(T[n])?{...T[n]}:{};for(const[e,t]of r){const n=oe(t);void 0===n?delete s[e]:s[e]=n}0===Object.keys(s).length?delete T[n]:T[n]=s,I.delete(n),ce()}function ye(e){const t="string"==typeof e?e.trim():"";if(!t)return null;if(ue(),z)throw z;const n=T[t];return se(n)?ie(n):null}function pe(e){const t="string"==typeof e?e.trim():"";if(t){if(ue(),z)throw z;t in T&&(delete T[t],I.delete(t),ce())}}function he(e){const t="string"==typeof e?e.trim():"";return!!t&&(ue(),!z&&I.has(t))}function me(){const e=v.settings?.session;return e&&"object"==typeof e?JSON.parse(JSON.stringify(e)):{}}function ge(e={}){const t=e&&"object"==typeof e?e:{};try{Te("ctrSession",JSON.stringify(t))}catch(e){console.warn("session save failed",e)}return me()}function be(){const e=R(l),t=R(d),n=R(f);if(!e||!t||!n)return null;const r=Number.parseInt(n,10);if(!Number.isFinite(r))return Se(),null;if(Date.now()>=r)return Se(),null;return{token:e,csrfToken:t,expiresAt:r,user:R(y)||null}}function Se(){D(l,null),D(d,null),D(f,null),D(y,null)}function ve(){try{return"undefined"!=typeof localStorage?localStorage:null}catch{return null}}function we(e,t,n){const r=n??t,s=void 0===n?[e,r]:[e,t,r];console.warn(...s),function(e){if(!e||"object"!=typeof e)return!1;const t=e.name;if("QuotaExceededError"===t||"NS_ERROR_DOM_QUOTA_REACHED"===t)return!0;if(22===e.code||1014===e.code)return!0;if("undefined"!=typeof DOMException&&e instanceof DOMException&&("QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name))return!0;const n="string"==typeof e.message?e.message:"";return n.toLowerCase().includes("quota")||n.toLowerCase().includes("exceeded")}(r)&&(C=!0,L||(L=!0,console.warn("Local storage quota exceeded. Further saves will be kept in memory only for this session.")))}function je(e,t,n,r="project save failed"){if(!e||C)return!1;try{return e.setItem(t,n),!0}catch(e){return we(r,t,e),!1}}function Ae(e=v){return JSON.parse(JSON.stringify(e))}function ke(e,t){try{return e.getItem(t)}catch{return null}}function Ee(e,t){if(null==e)return t;try{return JSON.parse(e)}catch{return t}}function Ce(e){A=new Set(e),A.delete("session"),A.delete("collapsedGroups")}function Le(){const e=Ae();k.forEach(t=>{try{t(e)}catch(e){console.error(e)}})}function xe(e){if(!e||C)return;const t=[["cableSchedule",JSON.stringify(v.cables||[])],["traySchedule",JSON.stringify(v.trays||[])],["conduitSchedule",JSON.stringify(v.conduits||[])],["ductbankSchedule",JSON.stringify(v.ductbanks||[])]];for(const[n,r]of t)if(!je(e,n,r))return;const n=v.settings?.session;if(void 0===n){if(!C)try{e.removeItem("ctrSession")}catch{}}else if(!je(e,"ctrSession",JSON.stringify(n)))return;const r=v.settings?.collapsedGroups;if(void 0===r){if(!C)try{e.removeItem("collapsedGroups")}catch{}}else if(!je(e,"collapsedGroups",JSON.stringify(r)))return;const s=v.settings&&"object"==typeof v.settings?v.settings:{},o=Object.keys(s).filter(e=>"session"!==e&&"collapsedGroups"!==e);for(const t of A)if(!o.includes(t)&&!C)try{e.removeItem(t)}catch{}for(const t of o){const n=s[t];if(!je(e,t,JSON.stringify(n)))return}A=new Set(o)}function Oe({notify:e=!0}={}){const t=ve();if(t&&!C&&(xe(t),!C))try{t.setItem(o,JSON.stringify(v))}catch(e){we("project save failed",e)}e&&Le()}function _e(e){if(g)try{const t=g(v,e);Array.isArray(t)&&t.length&&(w.push(t),j.length=0)}catch(e){console.warn("undo capture failed",e)}}function Ne(){return Ae()}function Pe(e){const t=Ae();v=m(e||{}),_e(t),Oe()}function Te(e,t,n={}){if(!e)return;if(e===o){if(!n.skipLocalStorage){const n=ve();if(n&&!C)try{n.setItem(e,t)}catch(e){we("project save failed",e)}}return}const r=Ae();if("cableSchedule"===e)v.cables=Ee(t,[]);else if("traySchedule"===e)v.trays=Ee(t,[]);else if("conduitSchedule"===e)v.conduits=Ee(t,[]);else if("ductbankSchedule"===e)v.ductbanks=Ee(t,[]);else if("collapsedGroups"===e)v.settings||(v.settings={}),v.settings.collapsedGroups=Ee(t,{});else if("ctrSession"===e)v.settings||(v.settings={}),v.settings.session=Ee(t,{});else{v.settings||(v.settings={});try{v.settings[e]=JSON.parse(t)}catch{v.settings[e]=t}}if(_e(r),!n.skipLocalStorage){je(ve(),e,t)}Oe()}function Je(e,t={}){if(!e)return;if(e===o){if(!t.skipLocalStorage){const t=ve();if(t&&!C)try{t.removeItem(e)}catch{}}return}const n=Ae();if("cableSchedule"===e?v.cables=[]:"traySchedule"===e?v.trays=[]:"conduitSchedule"===e?v.conduits=[]:"ductbankSchedule"===e?v.ductbanks=[]:"collapsedGroups"===e?v.settings&&delete v.settings.collapsedGroups:"ctrSession"===e?v.settings&&delete v.settings.session:v.settings&&delete v.settings[e],_e(n),!t.skipLocalStorage){const t=ve();if(t&&!C)try{t.removeItem(e)}catch{}}Oe()}!function(){const e=ve();if(!e)return v={name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}},void Ce(Object.keys(v.settings||{}));let t;try{t=e.getItem(o)}catch{t=null}if(t)try{return v=m(JSON.parse(t)),void Ce(Object.keys(v.settings||{}))}catch(e){console.warn("Failed to parse stored project",e)}const n=function(e){return{cables:Ee(ke(e,"cableSchedule"),[]),trays:Ee(ke(e,"traySchedule"),[]),conduits:Ee(ke(e,"conduitSchedule"),[]),ductbanks:Ee(ke(e,"ductbankSchedule"),[]),settings:{session:Ee(ke(e,"ctrSession"),{}),collapsedGroups:Ee(ke(e,"collapsedGroups"),{}),conduitFillData:Ee(ke(e,"conduitFillData"),null),trayFillData:Ee(ke(e,"trayFillData"),null),ductbankSession:Ee(ke(e,"ductbankSession"),{})}}}(e);v=m(n),Ce(Object.keys(v.settings||{})),Oe({notify:!1})}(),function(){const e=Ee(R(i),["base"]);_=q(e);const t=R(a),n=F("string"==typeof t?t:"");N=n||_[0]||"base",_.includes(N)||_.push(N),$()}();const ze={PROJECT_KEY:o,defaultProject:h,migrateProject:m,initializeProjectStorage:async function(){await(S||(S=import(p).then(e=>(b=e.applyPatch,g=e.compare,e))),S);const e=ve();"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("beforeunload",()=>{w.length=0,j.length=0}),window.addEventListener("storage",t=>{if(t.key)if(t.key!==o){if(t.key===i){const e=Ee(t.newValue,["base"]);return _=q(e),void(_.includes(N)||_.push(N))}if(t.key===a){const e=F(t.newValue||"");return N=e||_[0]||"base",void(_.includes(N)||_.push(N))}if(t.key===u&&(P=null,t.newValue)){const e=Ee(t.newValue,null);e&&"object"==typeof e&&(P={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]})}}else{if(!t.newValue)return;try{v=m(JSON.parse(t.newValue)),Ce(Object.keys(v.settings||{})),e&&xe(e),Le()}catch(e){console.warn("project sync failed",e)}}})),Le()},getProjectState:Ne,setProjectState:Pe,setProjectKey:Te,removeProjectKey:Je,undoProjectChange:function(){if(!w.length||!b)return;const e=w.pop(),t=Ae();try{const n=b(t,e,!0).newDocument;if(g)try{j.push(g(n,v))}catch{j.push([])}else j.push([]);v=m(n),Oe()}catch(e){console.warn("undo failed",e)}},redoProjectChange:function(){if(!j.length||!b)return;const e=j.pop(),t=Ae();try{const n=b(t,e,!0).newDocument;if(g)try{w.push(g(n,v))}catch{w.push([])}else w.push([]);v=m(n),Oe()}catch(e){console.warn("redo failed",e)}},canUndo:function(){return w.length>0},canRedo:function(){return j.length>0},onProjectChange:function(e){return"function"!=typeof e?()=>{}:(k.add(e),()=>{k.delete(e)})},getScenarioListState:V,setScenarioListState:B,registerScenario:H,getCurrentScenarioNameState:K,setCurrentScenarioNameState:Y,readScenarioValue:Q,writeScenarioValue:W,removeScenarioValue:X,listScenarioKeysState:Z,cloneScenarioStorage:ee,getSavedProjectsError:le,listSavedProjects:de,writeSavedProject:fe,readSavedProject:ye,removeSavedProject:pe,wasSavedProjectMigrated:he,getSessionPreferences:me,setSessionPreferences:ge,updateSessionPreferences:function(e){const t=me(),n="function"==typeof e?e(t):{...t,...e&&"object"==typeof e?e:{}};return ge(n&&"object"==typeof n?n:{})},getConduitCache:function(){if(P)return JSON.parse(JSON.stringify(P));const e=Ee(R(u),null);return e&&"object"==typeof e?(P={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]},JSON.parse(JSON.stringify(P))):(P=null,null)},setConduitCache:function(e){if(!e||"object"!=typeof e)return P=null,D(u,null),null;const t={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]};P={ductbanks:JSON.parse(JSON.stringify(t.ductbanks)),conduits:JSON.parse(JSON.stringify(t.conduits))},D(u,JSON.stringify(P));try{Te("ductbankSchedule",JSON.stringify(t.ductbanks))}catch{}try{Te("conduitSchedule",JSON.stringify(t.conduits))}catch{}return JSON.parse(JSON.stringify(P))},clearConduitCache:function(){P=null,D(u,null)},getAuthContextState:be,setAuthContextState:function({token:e,csrfToken:t,expiresAt:n,user:r}){if(!e||!t)return;const s=Number(n);Number.isFinite(s)&&(D(l,e),D(d,t),D(f,String(s)),D(y,null==r?null:String(r)))},clearAuthContextState:Se};function Ie(){return[...V()]}function Re(e){e&&(H(e),Y(e),Me("scenario",K()))}"undefined"!=typeof globalThis&&(globalThis.projectStorage=ze),H(K());const De={trays:"traySchedule",cables:"cableSchedule",ductbanks:"ductbankSchedule",conduits:"conduitSchedule",panels:"panelSchedule",loads:"loadList",equipment:"equipment",oneLine:"oneLineDiagram",studies:"studyResults",traySchedule:"traySchedule",cableSchedule:"cableSchedule",ductbankSchedule:"ductbankSchedule",conduitSchedule:"conduitSchedule",panelSchedule:"panelSchedule",loadList:"loadList",equipmentList:"equipment",oneLineDiagram:"oneLineDiagram"},Fe={equipmentColumns:"equipmentColumns",collapsedGroups:"collapsedGroups"},qe={...De,...Fe},$e={};function Me(e,t){($e[e]||[]).forEach(e=>{try{e(t)}catch(e){console.error(e)}})}const Ge=new Set([...Object.values(De),...Object.values(Fe)]);function Ue(e,t,n=K()){return Q(e,t,n)}function Ve(e,t,n=K()){try{W(e,t,n),Me(e,t)}catch(t){console.error("Failed to store",e,t)}}"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("storage",e=>{if(!e.key)return;const[t,n]=e.key.split(":");if(n&&t===K()&&Ge.has(n))try{Me(n,e.newValue?JSON.parse(e.newValue):void 0)}catch{}});const Be=()=>Ue(De.trays,[]),He=e=>Ve(De.trays,e),Ke=()=>Ue(De.cables,[]),Ye=e=>Ve(De.cables,e),Qe=e=>{const t=Ke();t.push(e),Ye(t)},We=()=>Ue(De.ductbanks,[]),Xe=e=>Ve(De.ductbanks,e),Ze=()=>Ue(De.conduits,[]),et=e=>Ve(De.conduits,e),tt=e=>{if(e)if(e.tray_id){const t=Be();t.push(e),He(t)}else{const t=Ze();t.push(e),et(t)}},nt=()=>Ue(De.panels,[]);function rt(e){return{id:"",description:"",ref:"",voltage:"",manufacturer:"",model:"",phases:"",notes:"",mainRating:"",circuitCount:42,...e}}const st=e=>Ve(De.panels,e.map(rt)),ot=()=>Ue(De.equipment,[]);function it(e){return{id:"",ref:"",description:"",voltage:"",category:"",subCategory:"",x:"",y:"",z:"",manufacturer:"",model:"",phases:"",notes:"",...e}}const at=e=>Ve(De.equipment,e.map(it)),ct=e=>{const t=ot();t.push(it(e)),at(t)},ut=(e,t)=>{const n=ot();e>=0&&e<n.length&&(n[e]=it({...n[e],...t}),at(n))},lt=e=>{const t=ot();e>=0&&e<t.length&&(t.splice(e,1),at(t))},dt=(e=K())=>{const t=Ue(De.oneLine,{},e);return Array.isArray(t)?{activeSheet:0,sheets:[{name:"Sheet 1",components:t,connections:[]}]}:t&&Array.isArray(t.sheets)?{activeSheet:t.activeSheet||0,sheets:t.sheets.map(e=>({name:e.name,components:Array.isArray(e.components)?e.components:[],connections:Array.isArray(e.connections)?e.connections:[]}))}:{activeSheet:0,sheets:[]}},ft="oneLineRevisions",yt=(e=K())=>Ue(ft,[],e);const pt=(e,t=K())=>{const n=yt(t)[e];return n&&Ve(De.oneLine,{activeSheet:0,sheets:n.sheets},t),n?n.sheets:null},ht=(e,t=K())=>{const n=dt(t);Array.isArray(n.sheets)&&n.sheets.length&&function(e,t=K()){const n=yt(t);n.push({time:Date.now(),sheets:JSON.parse(JSON.stringify(e))}),Ve(ft,n,t)}(n.sheets,t);const r={activeSheet:e.activeSheet||0,sheets:Array.isArray(e.sheets)?e.sheets:[]};Ve(De.oneLine,r,t)},mt=()=>Ue(De.studies,{}),gt=e=>Ve(De.studies,e),bt=()=>{const e=Ue(De.loads,[]),t=e.map(St);return e.some(e=>e&&"object"==typeof e&&!("source"in e))&&Ve(De.loads,t),t};function St(e){const t={...e};return"power"in t&&!("kw"in t)&&(t.kw=t.power,delete t.power),{id:"",ref:"",source:"",tag:"",description:"",quantity:"",voltage:"",loadType:"",duty:"",kw:"",powerFactor:"",loadFactor:"",efficiency:"",demandFactor:"",phases:"",circuit:"",manufacturer:"",model:"",notes:"",...t}}function vt(e){const t=St(e);return Object.values(t).every(e=>""===e)}const wt=e=>{const t=(e.length?e:[{}]).map(St);Ve(De.loads,t)},jt=e=>{const t=bt(),n=St(e);1===t.length&&vt(t[0])&&!vt(n)?t[0]=n:t.push(n),wt(t)},At=(e,t)=>{const n=bt(),r=St(t),s=Math.max(0,Math.min(e,n.length));n.splice(s,0,r),wt(n)},kt=(e,t)=>{const n=bt();e>=0&&e<n.length&&(n[e]=St({...n[e],...t}),wt(n))},Et=e=>{const t=bt();e>=0&&e<t.length&&(t.splice(e,1),wt(t))},Ct=(e,t=null,n)=>Ue(e,t,n),Lt=(e,t,n)=>Ve(e,t,n),xt=(e,t=K())=>{try{X(e,t),Me(e,null)}catch(t){console.error("Failed to remove",e,t)}},Ot=(e=K())=>{try{return Z(e)}catch{return[]}};function _t(e,t=K()){if(e)try{fe(e,{equipment:ot(),panels:nt(),loads:bt(),cables:Ke(),raceways:{trays:Be(),conduits:Ze(),ductbanks:We()},oneLine:dt(t)})}catch(e){console.error("Failed to save project",e)}}function Nt(e,t=K()){if(!e)return!1;try{const n=ye(e);if(!n)return!1;const r=n||{},s=he(e),o=r.equipment,i=r.panels,a=r.loads,c=r.cables,u=r.raceways||{},l=r.oneLine||{};return Array.isArray(o)?at(o):at([]),Array.isArray(i)?st(i):st([]),Array.isArray(a)&&wt(a),Array.isArray(c)?Ye(c):Ye([]),He(Array.isArray(u.trays)?u.trays:[]),et(Array.isArray(u.conduits)?u.conduits:[]),Xe(Array.isArray(u.ductbanks)?u.ductbanks:[]),Array.isArray(l)?ht({activeSheet:0,sheets:l},t):ht(l||{activeSheet:0,sheets:[]},t),s&&_t(e,t),!0}catch(e){return console.error("Failed to load project",e),!1}}function Pt(){const e={ductbanks:We(),conduits:Ze(),trays:Be(),cables:Ke(),panels:nt(),equipment:ot(),loads:bt(),oneLine:dt(),settings:{}},t=new Set([...Object.values(De),"CTR_PROJECT_V1"]);for(const n of Ot())t.has(n)||(e.settings[n]=Ct(n));return{meta:{version:1,scenario:K(),scenarios:Ie()},...e}}function Tt(e){const{meta:t,...n}=e||{};t&&Array.isArray(t.scenarios)&&B(t.scenarios),t&&t.scenario&&Re(t.scenario);let r=n;const{valid:s,missing:o,extra:i}=function(e){const t=["ductbanks","conduits","trays","cables","panels","equipment","loads","settings"],n=["oneLine"],r=[],s=[];if(!e||"object"!=typeof e)return r.push(...t),{valid:!1,missing:r,extra:s};for(const n of t)n in e||r.push(n);for(const r of Object.keys(e))t.includes(r)||n.includes(r)||s.push(r);const o=Array.isArray(e.ductbanks)&&Array.isArray(e.conduits)&&Array.isArray(e.trays)&&Array.isArray(e.cables)&&Array.isArray(e.panels)&&Array.isArray(e.equipment)&&Array.isArray(e.loads)&&e.settings&&"object"==typeof e.settings&&!Array.isArray(e.settings)&&(void 0===e.oneLine||Array.isArray(e.oneLine)||Array.isArray(e.oneLine?.sheets));return{valid:0===r.length&&0===s.length&&o,missing:r,extra:s}}(r);if(!s){const t=[];o.length&&t.push(`Missing fields: ${o.join(", ")}`),i.length&&t.push(`Extra fields: ${i.join(", ")}`);const n=t.join("\n")||"Invalid project data.";if(!("undefined"!=typeof window&&"function"==typeof window.confirm&&window.confirm(`${n}\nRepair & continue?`)))return!1;r={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[],trays:Array.isArray(e.trays)?e.trays:[],cables:Array.isArray(e.cables)?e.cables:[],panels:Array.isArray(e.panels)?e.panels:[],equipment:Array.isArray(e.equipment)?e.equipment:[],loads:Array.isArray(e.loads)?e.loads:[],oneLine:Array.isArray(e.oneLine)?e.oneLine:[],settings:e.settings&&"object"==typeof e.settings?e.settings:{}}}Xe(r.ductbanks),et(r.conduits),He(r.trays),Ye(r.cables),st(Array.isArray(r.panels)?r.panels:[]),at(Array.isArray(r.equipment)?r.equipment:[]),wt(Array.isArray(r.loads)?r.loads:[]),Array.isArray(r.oneLine)?ht({activeSheet:0,sheets:r.oneLine}):r.oneLine&&Array.isArray(r.oneLine.sheets)?ht({activeSheet:r.oneLine.activeSheet||0,sheets:r.oneLine.sheets}):ht({activeSheet:0,sheets:[]});const a=new Set([...Object.values(De),"CTR_PROJECT_V1"]);for(const e of Ot())a.has(e)||r.settings&&e in r.settings||xt(e);if(r.settings)for(const[e,t]of Object.entries(r.settings))Lt(e,t);return!0}"undefined"!=typeof window&&(window.dataStore={STORAGE_KEYS:qe,getTrays:Be,setTrays:He,getCables:Ke,setCables:Ye,addCable:Qe,getDuctbanks:We,setDuctbanks:Xe,getConduits:Ze,setConduits:et,addRaceway:tt,getPanels:nt,setPanels:st,getEquipment:ot,setEquipment:at,addEquipment:ct,updateEquipment:ut,removeEquipment:lt,getLoads:bt,setLoads:wt,addLoad:jt,insertLoad:At,updateLoad:kt,removeLoad:Et,getOneLine:dt,setOneLine:ht,getRevisions:yt,restoreRevision:pt,getStudies:mt,setStudies:gt,getItem:Ct,setItem:Lt,removeItem:xt,listScenarios:Ie,getCurrentScenario:function(){return K()},switchScenario:Re,cloneScenario:function(e,t=K()){e&&(ee(t,e),H(e))},compareStudies:function(e,t){const n=Ue(De.studies,{},e),r=Ue(De.studies,{},t);return{[e]:n,[t]:r}},on:function(e,t){$e[e]||($e[e]=[]),$e[e].push(t)},off:function(e,t){const n=$e[e];if(!n)return;const r=n.indexOf(t);r>=0&&n.splice(r,1)},keys:Ot,exportProject:Pt,importProject:Tt,saveProject:_t,loadProject:Nt,importFromCad:async function(t){let n;if("string"==typeof t)n=t;else{if(!t||"function"!=typeof t.text)throw new Error("Unsupported CAD file");n=await t.text()}const{trays:r=[],conduits:s=[]}=e(n);return Array.isArray(r)&&r.length&&He(r),Array.isArray(s)&&s.length&&et(s),{trays:r,conduits:s}},exportToCad:function(e="json"){const t={trays:Be(),conduits:Ze()};let n="application/json",r="json",s=JSON.stringify(t,null,2);if("csv"===e){const e="id,start_x,start_y,start_z,end_x,end_y,end_z,width,height",o=t.trays.map(e=>[e.id,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.width,e.height].join(",")),i="conduit_id,type,trade_size,start_x,start_y,start_z,end_x,end_y,end_z,capacity",a=t.conduits.map(e=>[e.conduit_id,e.type,e.trade_size,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.capacity].join(","));s=`# trays\n${[e,...o].join("\n")}\n# conduits\n${[i,...a].join("\n")}`,n="text/csv",r="csv"}if("undefined"!=typeof document)try{const e=new Blob([s],{type:n}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=`raceways.${r}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href)}catch(e){console.error("Failed to export CAD data",e)}return s}});function Jt(e){if(!e)return[];const t=e.ownerDocument||("undefined"!=typeof document?document:null);return t?Array.from(e.querySelectorAll("a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex='-1'])")).filter(e=>e.offsetWidth>0||e.offsetHeight>0||e===t.activeElement):[]}let zt=0;function It(e={}){const t="undefined"==typeof document?null:document;if(!t)return Promise.resolve(null);const{title:n="Dialog",description:r="",primaryText:s="OK",secondaryText:o="Cancel",closeOnEscape:i=!0,closeOnBackdrop:a=!0,onSubmit:c,onCancel:u,render:l,initialFocusSelector:d,variant:f,closeLabel:y="Close dialog"}=e;return new Promise(p=>{const h=t.activeElement instanceof HTMLElement?t.activeElement:null,m=t.createElement("div");m.className="modal component-modal",m.style.display="flex",m.setAttribute("role","dialog"),m.setAttribute("aria-modal","true"),zt+=1;const g=e.labelledById||`ctr-modal-title-${zt}`;m.setAttribute("aria-labelledby",g);let b=null;r&&(b=e.describedById||`ctr-modal-description-${zt}`,m.setAttribute("aria-describedby",b));const S=t.createElement("div");S.className="modal-content",f&&(S.dataset.variant=f);const v=t.createElement("button");v.type="button",v.className="close-btn",v.setAttribute("aria-label",y),v.textContent="Ã—";const w=t.createElement("h2");w.id=g,w.className="modal-title",w.textContent=n;const j=t.createElement("div");if(j.className="modal-body",r){const e=t.createElement("p");e.id=b,e.className="modal-description",e.textContent=r,j.appendChild(e)}const A=t.createElement("div");A.className="modal-actions";const k=t.createElement("button");k.type="button",k.className="btn primary-btn",k.textContent=s;let E=null;null!=o&&(E=t.createElement("button"),E.type="button",E.className="btn secondary-btn",E.textContent=o,A.appendChild(E)),A.appendChild(k),S.append(v,w,j,A),m.appendChild(S);const C=new Set;let L=null,x=!1;function O(e,{cancelled:n=!1}={}){x||(x=!0,m.removeEventListener("keydown",J,!0),m.removeEventListener("click",T),v.removeEventListener("click",P),E&&E.removeEventListener("click",P),k.removeEventListener("click",N),C.forEach(e=>e.removeEventListener("submit",_)),t.body.classList.remove("modal-open"),m.remove(),h&&"function"==typeof h.focus&&h.focus(),n&&"function"==typeof u&&u(),p(e))}function _(e){e.preventDefault(),N()}function N(){if("function"==typeof c){const e=c(z);if(!1===e)return;O(e)}else O(!0)}function P(){O(null,{cancelled:!0})}function T(e){a&&e.target===m&&O(null,{cancelled:!0})}function J(e){if(i&&"Escape"===e.key)return e.preventDefault(),void O(null,{cancelled:!0});!function(e,t){if("Tab"!==e.key)return;const n=Jt(t);if(!n.length)return void e.preventDefault();const r=n[0],s=n[n.length-1],o=t.ownerDocument||("undefined"!=typeof document?document:null),i=o?.activeElement;e.shiftKey?i!==r&&t.contains(i)||(e.preventDefault(),s.focus()):i===s&&(e.preventDefault(),r.focus())}(e,S)}const z={close(e){O(e)},cancel(){O(null,{cancelled:!0})},setPrimaryDisabled(e){k.disabled=!!e},setPrimaryText(e){"string"==typeof e&&(k.textContent=e)},focusPrimary(){k.focus()},registerForm(e){e&&!C.has(e)&&(C.add(e),e.addEventListener("submit",_))},setInitialFocus(e){e instanceof HTMLElement&&(L=e)},descriptionId:b,titleId:g,overlay:m,content:S,body:j,primaryBtn:k};if("function"==typeof l){const e=l(j,z);L||(e instanceof HTMLElement?L=e:e&&e.initialFocus instanceof HTMLElement&&(L=e.initialFocus))}else if(e.message){const n=t.createElement("p");n.className="modal-message",n.textContent=e.message,j.appendChild(n)}v.addEventListener("click",P),E&&E.addEventListener("click",P),k.addEventListener("click",N),m.addEventListener("keydown",J,!0),m.addEventListener("click",T),t.body.appendChild(m),t.body.classList.add("modal-open"),setTimeout(function(){let e=L;if(!e&&d&&(e=S.querySelector(d)),!e){const t=Jt(S);e=t.find(e=>e!==v)||t[0]}e&&"function"==typeof e.focus?e.focus():k.focus()},0)})}function Rt(e,t,n={}){return It({title:e,message:t,primaryText:n.confirmText||"Close",secondaryText:null,variant:n.variant,closeLabel:n.closeLabel||"Close dialog"})}function Dt(){return de()}function Ft(e){return"string"==typeof e?e.trim():""}function qt(){const e=Ft(decodeURIComponent(location.hash.slice(1))||"");if(e)return e;if("undefined"!=typeof window){const e=Ft(window.currentProjectId||"");if(e)return e}try{const e=Ft(Ne().name||"");if(e)return e}catch{}return""}function $t(e){const t=Ft(e);if(!t)return"";try{const e=Ne();(e.name||"")!==t&&(e.name=t,Pe(e))}catch(e){console.warn("Project state update failed",e)}return t}function Mt(){Se()}function Gt(){return be()}function Ut(e,t,{allowExisting:n=!0,currentName:r=""}={}){const s=e.trim();if(!s)return"Project name is required.";if(s.includes(":"))return'Project name cannot include the ":" character.';const o=s.toLowerCase(),i=r.trim().toLowerCase();return!n&&t.some(e=>e.toLowerCase()===o&&e.toLowerCase()!==i)?"A project with that name already exists. Choose a different name or use Load Project.":""}function Vt(e){location.hash=encodeURIComponent(e),globalThis.applyProjectHash?.()}async function Bt({title:e,confirmLabel:t,message:n,initialValue:r="",allowExisting:s=!0,currentName:o=""}={}){if("undefined"==typeof document)return"";const i=Dt(),a=`project-name-${Math.random().toString(36).slice(2)}`,c=`${a}-error`;let u,l;const d=await It({title:e||"Project Name",description:n||(s?"Enter a project name. Existing projects with the same name will be overwritten.":"Enter a unique name for the project."),primaryText:t||"Save",onSubmit(){const e=u.value.trim(),t=Ut(e,i,{allowExisting:s,currentName:o});return t?(l.textContent=t,u.setAttribute("aria-invalid","true"),u.focus(),!1):(u.removeAttribute("aria-invalid"),l.textContent="",e)},render(e,t){const n=e.ownerDocument,s=n.createElement("form");s.className="modal-form";const o=n.createElement("label");return o.setAttribute("for",a),o.textContent="Project name",u=n.createElement("input"),u.type="text",u.id=a,u.name="projectName",u.required=!0,u.value=r,u.autocomplete="off",u.spellcheck=!1,t.descriptionId?u.setAttribute("aria-describedby",`${t.descriptionId} ${c}`.trim()):u.setAttribute("aria-describedby",c),u.addEventListener("input",()=>{l.textContent="",u.removeAttribute("aria-invalid"),t.setPrimaryDisabled(!u.value.trim())}),o.appendChild(u),s.appendChild(o),l=n.createElement("p"),l.id=c,l.className="modal-error",l.setAttribute("role","alert"),l.textContent="",s.appendChild(l),t.registerForm(s),t.setPrimaryDisabled(!r.trim()),t.setInitialFocus(u),e.appendChild(s),u}});return"string"==typeof d?d.trim():""}async function Ht(){const e=Ft(await Bt({title:"Create New Project",confirmLabel:"Create",allowExisting:!1,message:"Choose a unique name for the new project."}));if(e){Vt(e),$t(e);try{fe(e,{equipment:[],panels:[],loads:[],cables:[],raceways:{trays:[],conduits:[],ductbanks:[]},oneLine:{activeSheet:0,sheets:[]}})}catch(e){console.error("Failed to initialize new project storage",e)}location.reload()}}async function Kt(e={}){const{skipManual:t=!1}=e||{};if(!t){const e=globalThis.manualSaveProject;if("function"==typeof e){let t;try{t=await e()}catch(e){console.error(e),t=null}if(!1===t)return}}let n=qt();if(!n){let e="";try{e=Ne().name||""}catch{}n=await Bt({title:"Save Project",confirmLabel:"Save",allowExisting:!0,initialValue:e,currentName:e})}if(!n)return;Vt(n),_t(n);const r=le();let s=!1,o=null;try{s=await async function(e){const t=Gt();if(!t)return!1;const n=await fetch(`/projects/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.token}`,"X-CSRF-Token":t.csrfToken},body:JSON.stringify(Pt())});return 401!==n.status&&403!==n.status||Mt(),n.ok}(n)}catch(e){console.error(e),o=e}if(r){const e=r.message||"Saved projects could not be updated. Clear saved data in Settings and try again.",t=s?"The project was uploaded to the server, but the local copy could not be updated.":"The project was not uploaded to the server.";return void await Rt("Save Failed",`${e} ${t}`.trim())}alert(o||!s?`Project "${n}" saved locally. Server sync failed.`:`Project "${n}" successfully saved.`)}async function Yt(){const e=Dt(),t=le();if(t){const e=t.message||"Saved projects could not be read. Clear saved data in Settings and try again.";return void await Rt("Saved Projects Unavailable",e)}const n=await async function(e){if("undefined"==typeof document)return e[0]||"";if(!e.length)return await Rt("No Saved Projects","There are no saved projects to load yet. Save a project first."),"";let t=e[0]||"";const n=`project-select-${Math.random().toString(36).slice(2)}`,r=await It({title:"Load Project",description:"Select a saved project to load.",primaryText:"Load",onSubmit:()=>t||!1,render(r,s){const o=r.ownerDocument,i=o.createElement("form");i.className="modal-form";const a=o.createElement("label");a.setAttribute("for",n),a.textContent="Saved projects";const c=o.createElement("select");return c.id=n,c.name="projectName",c.size=Math.min(6,Math.max(3,e.length)),c.className="modal-select",e.forEach(e=>{const t=o.createElement("option");t.value=e,t.textContent=e,c.appendChild(t)}),s.descriptionId&&c.setAttribute("aria-describedby",s.descriptionId),c.value=t,c.addEventListener("change",()=>{t=c.value,s.setPrimaryDisabled(!t)}),c.addEventListener("dblclick",()=>{c.value&&s.primaryBtn&&s.primaryBtn.click()}),a.appendChild(c),i.appendChild(a),s.registerForm(i),s.setPrimaryDisabled(!t),s.setInitialFocus(c),r.appendChild(i),c}});return"string"==typeof r?r:""}(e);if(!n)return;Vt(n);let r=!1;try{r=await async function(e){const t=Gt();if(!t)return!1;const n=await fetch(`/projects/${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${t.token}`,"X-CSRF-Token":t.csrfToken}});if(401===n.status||403===n.status)return Mt(),!1;if(!n.ok)return!1;const{data:r}=await n.json();return Tt(r),!0}(n)}catch(e){console.error(e)}if(!r){const e=Nt(n),t=le();if(t){const e=t.message||"Saved projects could not be read. Clear saved data in Settings and try again.";return void await Rt("Saved Project Migration Failed",e)}r=e}r?location.reload():await Rt("Project Not Found",`Project "${n}" could not be loaded from local storage.`)}"undefined"!=typeof window&&(window.projectManager={listProjects:Dt,newProject:Ht,renameProject:function(e){const t=Ft(e);if(!t)throw new Error("Project name is required.");const n=qt(),r=Ut(t,Dt(),{allowExisting:!1,currentName:n});if(r)throw new Error(r);if(n&&t!==n)try{const e=ye(n);e&&(fe(t,e),pe(n))}catch(e){console.error("Project rename persistence failed",e)}return Vt(t),$t(t),t},saveProject:Kt,loadProject:Yt},window.addEventListener("DOMContentLoaded",()=>{document.getElementById("new-project-btn")?.addEventListener("click",()=>{Ht().catch(console.error)}),document.getElementById("save-project-btn")?.addEventListener("click",()=>{Kt().catch(console.error)}),document.getElementById("load-project-btn")?.addEventListener("click",()=>{Yt().catch(console.error)});const e=document.getElementById("settings-menu");if(e){const t=document.createElement("button");function n(){t.textContent=Gt()?"Logout":"Login"}n(),t.addEventListener("click",()=>{Gt()?(Mt(),n()):location.href="login.html"}),e.appendChild(t)}}));
