function e(e){if("string"==typeof e)try{return t(JSON.parse(e))}catch{return function(e){const t=[],n=[],r=/#\d+=IFC([^;]*?)SEGMENT[^;]*?IFCPOLYLINE\(\(([^)]+)\),\(([^)]+)\)\)/gi;let s,o=0;for(;s=r.exec(e);){const e=s[1]||"",r=s[2].split(",").map(e=>parseFloat(e)),a=s[3].split(",").map(e=>parseFloat(e)),i={id:"SEG-"+o++,start_x:r[0],start_y:r[1],start_z:r[2],end_x:a[0],end_y:a[1],end_z:a[2]};/CABLECARRIER/i.test(e)?t.push(i):n.push(i)}return{trays:t,conduits:n}}(e)}return t(e)}function t(e){if(!e||"object"!=typeof e)return{trays:[],conduits:[]};const t=[],n=[],o=e.trays||e.Trays||e.cableTrays||e.CableTrays||[];for(const e of o)t.push(r(e));const a=e.conduits||e.Conduits||e.cableConduits||e.ConduitSegments||[];for(const e of a)n.push(s(e));return{trays:t,conduits:n}}function n(e){const t=parseFloat(e);return Number.isFinite(t)?t:void 0}function r(e={}){return{id:e.id||e.tag||e.tray_id||e.TrayID||e.name||e.Tag||"",start_x:n(e.start_x??e.sx??e.x1??e.StartX??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.StartY??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.StartZ??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.EndX??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.EndY??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.EndZ??e.end?.z),width:n(e.width??e.w??e.Width??e.size_x),height:n(e.height??e.h??e.Height??e.size_y)}}function s(e={}){return{conduit_id:e.conduit_id||e.id||e.tag||e.ConduitID||"",type:e.type||e.conduit_type||e.Type||"",trade_size:e.trade_size||e.tradeSize||e.size||e.TradeSize||"",start_x:n(e.start_x??e.sx??e.x1??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.end?.z),capacity:n(e.capacity??e.fill)}}const o="CTR_PROJECT_V1",a="ctr_scenarios_v1",i="ctr_current_scenario_v1",c="CTR_SAVED_PROJECTS_V1",l="CTR_CONDUITS",u="authToken",d="authCsrfToken",f="authExpiresAt",y="authUser",p="undefined"!=typeof document&&document.baseURI?new URL("dist/vendor/fast-json-patch.mjs",document.baseURI).href:"undefined"!=typeof location&&location.href?new URL("dist/vendor/fast-json-patch.mjs",location.href).href:"./dist/vendor/fast-json-patch.mjs";function h(){return{name:"",ductbanks:[],conduits:[],trays:[],cables:[],cableTypicals:[],settings:{session:{},collapsedGroups:{},units:"imperial"}}}function m(e={}){const t=e.settings||{session:e.session||e.ctrSession||{},collapsedGroups:e.collapsedGroups||{}};return t.units||(t.units="imperial"),{name:e.name||"",ductbanks:e.ductbanks||e.ductbankSchedule||[],conduits:e.conduits||e.conduitSchedule||[],trays:e.trays||e.traySchedule||[],cables:e.cables||e.cableSchedule||[],cableTypicals:e.cableTypicals||[],settings:t}}let b,g,S,v={name:"",ductbanks:[],conduits:[],trays:[],cables:[],cableTypicals:[],settings:{session:{},collapsedGroups:{},units:"imperial"}};const w=[],j=[];let A=new Set;const k=new Set,E=new Map;let C=!1,L=!1;const x=2621440,T=new Set;let O=["base"],_="base",N=null,P={},J=!1,z=null;const I=new Set;function R(e){const t=ve();if(t){const n=ke(t,e);if(null!=n)return n}return E.has(e)?E.get(e):null}function D(e,t,n={}){const r=Boolean(n&&n.skipLocalStorage);null==t?E.delete(e):E.set(e,t);const s=ve();if(s&&!C&&(!r||null==t))try{null==t?s.removeItem(e):s.setItem(e,t)}catch(t){we("project storage write failed",e,t)}}function F(e){return"string"!=typeof e?"":e.trim()}function q(e){const t=Array.isArray(e)?e.map(F).filter(Boolean):[];return t.length||t.push("base"),[...new Set(t)]}function $(){O=q(O),O.includes(_)||O.push(_),D(a,JSON.stringify(O)),D(i,_)}function M(e,t){return`${e}:${t}`}function G(e,t){return R(M(e,t))}function U(e,t,n,r){D(M(e,t),n,r)}function V(){return[...O]}function B(e){O=q(e),O.includes(_)||O.push(_),$()}function H(e){const t=F(e);t&&(O.includes(t)||(O.push(t),$()))}function K(){return _}function W(e){const t=F(e)||"base";_=t,O.includes(t)||O.push(t),$()}function Y(e,t,n=_){const r=G(F(n)||_,e);return null==r?t:Ee(r,t)}function Q(e,t,n=_){const r=F(n)||_;try{const n=JSON.stringify(t),s=M(r,e);if(n.length>x){if(U(r,e,n,{skipLocalStorage:!0}),r===_&&Pe(e,n,{skipLocalStorage:!0}),!T.has(s)){T.add(s);const e=2.5.toFixed(1);console.warn(`Scenario entry "${s}" exceeds ${e}MB. Data will persist for this tab only; use Save Project to keep a copy.`)}return}U(r,e,n),r===_&&Pe(e,n)}catch(t){console.error("scenario write failed",e,t)}}function X(e,t=_){const n=F(t)||_;U(n,e,null),n===_&&Je(e)}function Z(e=_){return function(e){const t=new Set,n=ve();if(n)try{for(let r=0;r<n.length;r++){const s=n.key(r);s&&s.startsWith(e)&&t.add(s.slice(e.length))}}catch(e){console.warn("project storage enumerate failed",e)}for(const n of E.keys())n.startsWith(e)&&t.add(n.slice(e.length));return[...t]}(`${F(e)||_}:`)}function ee(e,t){const n=F(e)||_,r=F(t);if(!r)return;const s=Z(n);for(const e of s){const t=G(n,e);null!=t&&(U(r,e,t),r===_&&Pe(e,t))}}const te=["equipment","panels","loads","cables","cableTypicals","raceways","oneLine"],ne=new Set(te.filter(e=>"equipment"!==e));class re extends Error{constructor(e,t){super(e),this.name="SavedProjectMigrationError",t&&(this.cause=t)}}function se(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}function oe(e){if(void 0!==e)return JSON.parse(JSON.stringify(e))}function ae(e){return JSON.parse(JSON.stringify(e||{}))}function ie(){const e=new Map,t=new Set(te);for(const n of function(){const e=new Set,t=ve();if(t)try{for(let n=0;n<t.length;n++){const r=t.key(n);r&&e.add(r)}}catch(e){console.warn("project storage enumerate failed",e)}for(const t of E.keys())e.add(t);return[...e]}()){const r=n.indexOf(":");if(r<=0)continue;const s=n.slice(r+1);if(!t.has(s))continue;const o=n.slice(0,r);let a=e.get(o);a||(a={data:{},suffixes:new Set,keys:[]},e.set(o,a)),a.keys.push(n),a.suffixes.add(s);const i=R(n);if(null==i)continue;let c;try{c=JSON.parse(i)}catch(e){throw new re(`Saved project "${o}" could not be migrated because the "${s}" section is corrupted. Clear the saved project from browser storage and save again.`,e)}a.data[s]=c}if(!e.size)return null;const n={},r=[];for(const[t,s]of e){[...s.suffixes].some(e=>ne.has(e))&&(Object.keys(s.data).length&&(n[t]=ae(s.data),r.push(...s.keys)))}return Object.keys(n).length?{records:n,keysToRemove:r}:null}function ce(){if(z)throw z;if(Object.keys(P).length)try{D(c,JSON.stringify(P))}catch(e){const t=e instanceof Error?e:new Error(String(e)),n=t instanceof re?t:new re("Saved projects could not be written to storage.",t);throw z=n,n}else D(c,null)}function le(){if(!J){J=!0,z=null,I.clear();try{const e=function(){const e=R(c);if(null==e)return{};let t;try{t=JSON.parse(e)}catch(e){throw new re("Saved projects could not be read because the stored data is corrupted. Clear the saved projects entry in browser storage and try again.",e)}if(!se(t))throw new re("Saved projects could not be read because the stored data is in an unexpected format.");return t}(),t=ie();if(t){const n=new Set(Object.keys(e));for(const e of Object.keys(t.records))n.has(e)||I.add(e);P={...t.records,...e},ce();for(const e of t.keysToRemove)D(e,null)}else P=e}catch(e){const t=e instanceof Error?e:new Error(String(e));z=t,P={},console.error("Saved project initialization failed",t)}}}function ue(){return le(),z}function de(){return le(),z?[]:Object.keys(P).sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}))}function fe(e,t={}){const n="string"==typeof e?e.trim():"";if(!n)return;if(le(),z)throw z;const r=t&&"object"==typeof t?Object.entries(t):[];if(!r.length)return;const s=se(P[n])?{...P[n]}:{};for(const[e,t]of r){const n=oe(t);void 0===n?delete s[e]:s[e]=n}0===Object.keys(s).length?delete P[n]:P[n]=s,I.delete(n),ce()}function ye(e){const t="string"==typeof e?e.trim():"";if(!t)return null;if(le(),z)throw z;const n=P[t];return se(n)?ae(n):null}function pe(e){const t="string"==typeof e?e.trim():"";if(t){if(le(),z)throw z;t in P&&(delete P[t],I.delete(t),ce())}}function he(e){const t="string"==typeof e?e.trim():"";return!!t&&(le(),!z&&I.has(t))}function me(){const e=v.settings?.session;return e&&"object"==typeof e?JSON.parse(JSON.stringify(e)):{}}function be(e={}){const t=e&&"object"==typeof e?e:{};try{Pe("ctrSession",JSON.stringify(t))}catch(e){console.warn("session save failed",e)}return me()}function ge(){const e=R(u),t=R(d),n=R(f);if(!e||!t||!n)return null;const r=Number.parseInt(n,10);if(!Number.isFinite(r))return Se(),null;if(Date.now()>=r)return Se(),null;return{token:e,csrfToken:t,expiresAt:r,user:R(y)||null}}function Se(){D(u,null),D(d,null),D(f,null),D(y,null)}function ve(){try{return"undefined"!=typeof localStorage?localStorage:null}catch{return null}}function we(e,t,n){const r=n??t,s=void 0===n?[e,r]:[e,t,r];console.warn(...s),function(e){if(!e||"object"!=typeof e)return!1;const t=e.name;if("QuotaExceededError"===t||"NS_ERROR_DOM_QUOTA_REACHED"===t)return!0;if(22===e.code||1014===e.code)return!0;if("undefined"!=typeof DOMException&&e instanceof DOMException&&("QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name))return!0;const n="string"==typeof e.message?e.message:"";return n.toLowerCase().includes("quota")||n.toLowerCase().includes("exceeded")}(r)&&(C=!0,L||(L=!0,console.warn("Local storage quota exceeded. Further saves will be kept in memory only for this session.")))}function je(e,t,n,r="project save failed"){if(!e||C)return!1;try{return e.setItem(t,n),!0}catch(e){return we(r,t,e),!1}}function Ae(e=v){return JSON.parse(JSON.stringify(e))}function ke(e,t){try{return e.getItem(t)}catch{return null}}function Ee(e,t){if(null==e)return t;try{return JSON.parse(e)}catch{return t}}function Ce(e){A=new Set(e),A.delete("session"),A.delete("collapsedGroups")}function Le(){const e=Ae();k.forEach(t=>{try{t(e)}catch(e){console.error(e)}})}function xe(e){if(!e||C)return;const t=[["cableSchedule",JSON.stringify(v.cables||[])],["traySchedule",JSON.stringify(v.trays||[])],["conduitSchedule",JSON.stringify(v.conduits||[])],["ductbankSchedule",JSON.stringify(v.ductbanks||[])],["cableTypicals",JSON.stringify(v.cableTypicals||[])]];for(const[n,r]of t)if(!je(e,n,r))return;const n=v.settings?.session;if(void 0===n){if(!C)try{e.removeItem("ctrSession")}catch{}}else if(!je(e,"ctrSession",JSON.stringify(n)))return;const r=v.settings?.collapsedGroups;if(void 0===r){if(!C)try{e.removeItem("collapsedGroups")}catch{}}else if(!je(e,"collapsedGroups",JSON.stringify(r)))return;const s=v.settings&&"object"==typeof v.settings?v.settings:{},o=Object.keys(s).filter(e=>"session"!==e&&"collapsedGroups"!==e);for(const t of A)if(!o.includes(t)&&!C)try{e.removeItem(t)}catch{}for(const t of o){const n=s[t];if(!je(e,t,JSON.stringify(n)))return}A=new Set(o)}function Te({notify:e=!0}={}){const t=ve();if(t&&!C&&(xe(t),!C))try{t.setItem(o,JSON.stringify(v))}catch(e){we("project save failed",e)}e&&Le()}function Oe(e){if(b)try{const t=b(v,e);Array.isArray(t)&&t.length&&(w.push(t),j.length=0)}catch(e){console.warn("undo capture failed",e)}}function _e(){return Ae()}function Ne(e){const t=Ae();v=m(e||{}),Oe(t),Te()}function Pe(e,t,n={}){if(!e)return;if(e===o){if(!n.skipLocalStorage){const n=ve();if(n&&!C)try{n.setItem(e,t)}catch(e){we("project save failed",e)}}return}const r=Ae();if("cableSchedule"===e)v.cables=Ee(t,[]);else if("traySchedule"===e)v.trays=Ee(t,[]);else if("conduitSchedule"===e)v.conduits=Ee(t,[]);else if("ductbankSchedule"===e)v.ductbanks=Ee(t,[]);else if("cableTypicals"===e)v.cableTypicals=Ee(t,[]);else if("collapsedGroups"===e)v.settings||(v.settings={}),v.settings.collapsedGroups=Ee(t,{});else if("ctrSession"===e)v.settings||(v.settings={}),v.settings.session=Ee(t,{});else{v.settings||(v.settings={});try{v.settings[e]=JSON.parse(t)}catch{v.settings[e]=t}}if(Oe(r),!n.skipLocalStorage){je(ve(),e,t)}Te()}function Je(e,t={}){if(!e)return;if(e===o){if(!t.skipLocalStorage){const t=ve();if(t&&!C)try{t.removeItem(e)}catch{}}return}const n=Ae();if("cableSchedule"===e?v.cables=[]:"traySchedule"===e?v.trays=[]:"conduitSchedule"===e?v.conduits=[]:"ductbankSchedule"===e?v.ductbanks=[]:"cableTypicals"===e?v.cableTypicals=[]:"collapsedGroups"===e?v.settings&&delete v.settings.collapsedGroups:"ctrSession"===e?v.settings&&delete v.settings.session:v.settings&&delete v.settings[e],Oe(n),!t.skipLocalStorage){const t=ve();if(t&&!C)try{t.removeItem(e)}catch{}}Te()}!function(){const e=ve();if(!e)return v={name:"",ductbanks:[],conduits:[],trays:[],cables:[],cableTypicals:[],settings:{session:{},collapsedGroups:{},units:"imperial"}},void Ce(Object.keys(v.settings||{}));let t;try{t=e.getItem(o)}catch{t=null}if(t)try{return v=m(JSON.parse(t)),void Ce(Object.keys(v.settings||{}))}catch(e){console.warn("Failed to parse stored project",e)}const n=function(e){return{cables:Ee(ke(e,"cableSchedule"),[]),trays:Ee(ke(e,"traySchedule"),[]),conduits:Ee(ke(e,"conduitSchedule"),[]),ductbanks:Ee(ke(e,"ductbankSchedule"),[]),cableTypicals:Ee(ke(e,"cableTypicals"),[]),settings:{session:Ee(ke(e,"ctrSession"),{}),collapsedGroups:Ee(ke(e,"collapsedGroups"),{}),conduitFillData:Ee(ke(e,"conduitFillData"),null),trayFillData:Ee(ke(e,"trayFillData"),null),ductbankSession:Ee(ke(e,"ductbankSession"),{})}}}(e);v=m(n),Ce(Object.keys(v.settings||{})),Te({notify:!1})}(),function(){const e=Ee(R(a),["base"]);O=q(e);const t=R(i),n=F("string"==typeof t?t:"");_=n||O[0]||"base",O.includes(_)||O.push(_),$()}();const ze={PROJECT_KEY:o,defaultProject:h,migrateProject:m,initializeProjectStorage:async function(){await(S||(S=import(p).then(e=>(g=e.applyPatch,b=e.compare,e))),S);const e=ve();"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("beforeunload",()=>{w.length=0,j.length=0}),window.addEventListener("storage",t=>{if(t.key)if(t.key!==o){if(t.key===a){const e=Ee(t.newValue,["base"]);return O=q(e),void(O.includes(_)||O.push(_))}if(t.key===i){const e=F(t.newValue||"");return _=e||O[0]||"base",void(O.includes(_)||O.push(_))}if(t.key===l&&(N=null,t.newValue)){const e=Ee(t.newValue,null);e&&"object"==typeof e&&(N={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]})}}else{if(!t.newValue)return;try{v=m(JSON.parse(t.newValue)),Ce(Object.keys(v.settings||{})),e&&xe(e),Le()}catch(e){console.warn("project sync failed",e)}}})),Le()},getProjectState:_e,setProjectState:Ne,setProjectKey:Pe,removeProjectKey:Je,undoProjectChange:function(){if(!w.length||!g)return;const e=w.pop(),t=Ae();try{const n=g(t,e,!0).newDocument;if(b)try{j.push(b(n,v))}catch{j.push([])}else j.push([]);v=m(n),Te()}catch(e){console.warn("undo failed",e)}},redoProjectChange:function(){if(!j.length||!g)return;const e=j.pop(),t=Ae();try{const n=g(t,e,!0).newDocument;if(b)try{w.push(b(n,v))}catch{w.push([])}else w.push([]);v=m(n),Te()}catch(e){console.warn("redo failed",e)}},canUndo:function(){return w.length>0},canRedo:function(){return j.length>0},onProjectChange:function(e){return"function"!=typeof e?()=>{}:(k.add(e),()=>{k.delete(e)})},getScenarioListState:V,setScenarioListState:B,registerScenario:H,getCurrentScenarioNameState:K,setCurrentScenarioNameState:W,readScenarioValue:Y,writeScenarioValue:Q,removeScenarioValue:X,listScenarioKeysState:Z,cloneScenarioStorage:ee,getSavedProjectsError:ue,listSavedProjects:de,writeSavedProject:fe,readSavedProject:ye,removeSavedProject:pe,wasSavedProjectMigrated:he,getSessionPreferences:me,setSessionPreferences:be,updateSessionPreferences:function(e){const t=me(),n="function"==typeof e?e(t):{...t,...e&&"object"==typeof e?e:{}};return be(n&&"object"==typeof n?n:{})},getConduitCache:function(){if(N)return JSON.parse(JSON.stringify(N));const e=Ee(R(l),null);return e&&"object"==typeof e?(N={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]},JSON.parse(JSON.stringify(N))):(N=null,null)},setConduitCache:function(e){if(!e||"object"!=typeof e)return N=null,D(l,null),null;const t={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]};N={ductbanks:JSON.parse(JSON.stringify(t.ductbanks)),conduits:JSON.parse(JSON.stringify(t.conduits))},D(l,JSON.stringify(N));try{Pe("ductbankSchedule",JSON.stringify(t.ductbanks))}catch{}try{Pe("conduitSchedule",JSON.stringify(t.conduits))}catch{}return JSON.parse(JSON.stringify(N))},clearConduitCache:function(){N=null,D(l,null)},getAuthContextState:ge,setAuthContextState:function({token:e,csrfToken:t,expiresAt:n,user:r}){if(!e||!t)return;const s=Number(n);Number.isFinite(s)&&(D(u,e),D(d,t),D(f,String(s)),D(y,null==r?null:String(r)))},clearAuthContextState:Se};function Ie(){return[...V()]}function Re(e){e&&(H(e),W(e),Me("scenario",K()))}"undefined"!=typeof globalThis&&(globalThis.projectStorage=ze),H(K());const De={trays:"traySchedule",cables:"cableSchedule",cableTypicals:"cableTypicals",ductbanks:"ductbankSchedule",conduits:"conduitSchedule",panels:"panelSchedule",loads:"loadList",equipment:"equipment",oneLine:"oneLineDiagram",studies:"studyResults",traySchedule:"traySchedule",cableSchedule:"cableSchedule",ductbankSchedule:"ductbankSchedule",conduitSchedule:"conduitSchedule",panelSchedule:"panelSchedule",loadList:"loadList",equipmentList:"equipment",oneLineDiagram:"oneLineDiagram"},Fe={equipmentColumns:"equipmentColumns",collapsedGroups:"collapsedGroups",cableSchedulePreset:"cableSchedulePreset",cableTemplates:"cableTemplates"},qe={...De,...Fe},$e={};function Me(e,t){($e[e]||[]).forEach(e=>{try{e(t)}catch(e){console.error(e)}})}const Ge=new Set([...Object.values(De),...Object.values(Fe)]);function Ue(e,t,n=K()){return Y(e,t,n)}function Ve(e,t,n=K()){try{Q(e,t,n),Me(e,t)}catch(t){console.error("Failed to store",e,t)}}"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("storage",e=>{if(!e.key)return;const[t,n]=e.key.split(":");if(n&&t===K()&&Ge.has(n))try{Me(n,e.newValue?JSON.parse(e.newValue):void 0)}catch{}});const Be=()=>Ue(De.trays,[]),He=e=>Ve(De.trays,e),Ke=()=>Ue(De.cables,[]),We=e=>Ve(De.cables,e),Ye=()=>Ue(De.cableTypicals,[]),Qe=e=>Ve(De.cableTypicals,e),Xe=e=>Ve(Fe.cableTemplates,e),Ze=e=>{const t=Ke();t.push(e),We(t)},et=()=>Ue(De.ductbanks,[]),tt=e=>Ve(De.ductbanks,e),nt=()=>Ue(De.conduits,[]),rt=e=>Ve(De.conduits,e),st=e=>{if(e)if(e.tray_id){const t=Be();t.push(e),He(t)}else{const t=nt();t.push(e),rt(t)}},ot=()=>Ue(De.panels,[]);function at(e){return{id:"",description:"",ref:"",voltage:"",manufacturer:"",model:"",phases:"",notes:"",mainRating:"",circuitCount:42,...e}}const it=e=>Ve(De.panels,e.map(at)),ct=()=>Ue(De.equipment,[]);function lt(e){return{id:"",ref:"",description:"",voltage:"",category:"",subCategory:"",x:"",y:"",z:"",manufacturer:"",model:"",phases:"",notes:"",...e}}const ut=e=>Ve(De.equipment,e.map(lt)),dt=e=>{const t=ct();t.push(lt(e)),ut(t)},ft=(e,t)=>{const n=ct();e>=0&&e<n.length&&(n[e]=lt({...n[e],...t}),ut(n))},yt=e=>{const t=ct();e>=0&&e<t.length&&(t.splice(e,1),ut(t))},pt=(e=K())=>{const t=Ue(De.oneLine,{},e);return Array.isArray(t)?{activeSheet:0,sheets:[{name:"Sheet 1",components:t,connections:[]}]}:t&&Array.isArray(t.sheets)?{activeSheet:t.activeSheet||0,sheets:t.sheets.map(e=>({name:e.name,components:Array.isArray(e.components)?e.components:[],connections:Array.isArray(e.connections)?e.connections:[]}))}:{activeSheet:0,sheets:[]}},ht="oneLineRevisions",mt=1572864;const bt=(e=K())=>Ue(ht,[],e);function gt(e,t=K()){const n=bt(t);n.push({time:Date.now(),sheets:JSON.parse(JSON.stringify(e))}),function(e){if(!Array.isArray(e))return[];e.length>10&&e.splice(0,e.length-10);{let t=JSON.stringify(e);if(t.length>mt){for(;e.length>1&&t.length>mt;)e.shift(),t=JSON.stringify(e);t.length>mt&&(e.length=0)}}}(n),Ve(ht,n,t)}const St=(e,t=K())=>{const n=bt(t)[e];return n&&Ve(De.oneLine,{activeSheet:0,sheets:n.sheets},t),n?n.sheets:null},vt=(e,t=K())=>{const n=pt(t);Array.isArray(n.sheets)&&n.sheets.length&&gt(n.sheets,t);const r={activeSheet:e.activeSheet||0,sheets:Array.isArray(e.sheets)?e.sheets:[]};Ve(De.oneLine,r,t)},wt=()=>Ue(De.studies,{}),jt=e=>Ve(De.studies,e),At=()=>{const e=Ue(De.loads,[]),t=e.map(kt);return e.some(e=>e&&"object"==typeof e&&!("source"in e))&&Ve(De.loads,t),t};function kt(e){const t={...e};return"power"in t&&!("kw"in t)&&(t.kw=t.power,delete t.power),{id:"",ref:"",source:"",tag:"",description:"",quantity:"",voltage:"",loadType:"",duty:"",kw:"",powerFactor:"",loadFactor:"",efficiency:"",demandFactor:"",phases:"",circuit:"",manufacturer:"",model:"",notes:"",...t}}function Et(e){const t=kt(e);return Object.values(t).every(e=>""===e)}const Ct=e=>{const t=(e.length?e:[{}]).map(kt);Ve(De.loads,t)},Lt=e=>{const t=At(),n=kt(e);1===t.length&&Et(t[0])&&!Et(n)?t[0]=n:t.push(n),Ct(t)},xt=(e,t)=>{const n=At(),r=kt(t),s=Math.max(0,Math.min(e,n.length));n.splice(s,0,r),Ct(n)},Tt=(e,t)=>{const n=At();e>=0&&e<n.length&&(n[e]=kt({...n[e],...t}),Ct(n))},Ot=e=>{const t=At();e>=0&&e<t.length&&(t.splice(e,1),Ct(t))},_t=(e,t=null,n)=>Ue(e,t,n),Nt=(e,t,n)=>Ve(e,t,n),Pt=(e,t=K())=>{try{X(e,t),Me(e,null)}catch(t){console.error("Failed to remove",e,t)}},Jt=(e=K())=>{try{return Z(e)}catch{return[]}};function zt(e,t=K()){if(e)try{fe(e,{equipment:ct(),panels:ot(),loads:At(),cables:Ke(),cableTypicals:Ye(),cableTemplates:Ue(Fe.cableTemplates,[]),raceways:{trays:Be(),conduits:nt(),ductbanks:et()},oneLine:pt(t)})}catch(e){console.error("Failed to save project",e)}}function It(e,t=K()){if(!e)return!1;try{const n=ye(e);if(!n)return!1;const r=n||{},s=he(e),o=r.equipment,a=r.panels,i=r.loads,c=r.cables,l=r.cableTypicals,u=r.cableTemplates,d=r.raceways||{},f=r.oneLine||{};return Array.isArray(o)?ut(o):ut([]),Array.isArray(a)?it(a):it([]),Array.isArray(i)&&Ct(i),Array.isArray(c)?We(c):We([]),Array.isArray(l)?Qe(l):Qe([]),Array.isArray(u)?Xe(u):Xe([]),He(Array.isArray(d.trays)?d.trays:[]),rt(Array.isArray(d.conduits)?d.conduits:[]),tt(Array.isArray(d.ductbanks)?d.ductbanks:[]),Array.isArray(f)?vt({activeSheet:0,sheets:f},t):vt(f||{activeSheet:0,sheets:[]},t),s&&zt(e,t),!0}catch(e){return console.error("Failed to load project",e),!1}}function Rt(){const e={ductbanks:et(),conduits:nt(),trays:Be(),cables:Ke(),cableTypicals:Ye(),panels:ot(),equipment:ct(),loads:At(),oneLine:pt(),settings:{}},t=new Set([...Object.values(De),"CTR_PROJECT_V1"]);for(const n of Jt())t.has(n)||(e.settings[n]=_t(n));return{meta:{version:1,scenario:K(),scenarios:Ie()},...e}}function Dt(e){const{meta:t,...n}=e||{};t&&Array.isArray(t.scenarios)&&B(t.scenarios),t&&t.scenario&&Re(t.scenario);let r=n;const{valid:s,missing:o,extra:a}=function(e){const t=["ductbanks","conduits","trays","cables","cableTypicals","panels","equipment","loads","settings"],n=["oneLine"],r=[],s=[];if(!e||"object"!=typeof e)return r.push(...t),{valid:!1,missing:r,extra:s};for(const n of t)n in e||r.push(n);for(const r of Object.keys(e))t.includes(r)||n.includes(r)||s.push(r);const o=Array.isArray(e.ductbanks)&&Array.isArray(e.conduits)&&Array.isArray(e.trays)&&Array.isArray(e.cables)&&Array.isArray(e.cableTypicals)&&Array.isArray(e.panels)&&Array.isArray(e.equipment)&&Array.isArray(e.loads)&&e.settings&&"object"==typeof e.settings&&!Array.isArray(e.settings)&&(void 0===e.oneLine||Array.isArray(e.oneLine)||Array.isArray(e.oneLine?.sheets));return{valid:0===r.length&&0===s.length&&o,missing:r,extra:s}}(r);if(!s){const t=[];o.length&&t.push(`Missing fields: ${o.join(", ")}`),a.length&&t.push(`Extra fields: ${a.join(", ")}`);const n=t.join("\n")||"Invalid project data.";if(!("undefined"!=typeof window&&"function"==typeof window.confirm&&window.confirm(`${n}\nRepair & continue?`)))return!1;r={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[],trays:Array.isArray(e.trays)?e.trays:[],cables:Array.isArray(e.cables)?e.cables:[],cableTypicals:Array.isArray(e.cableTypicals)?e.cableTypicals:[],panels:Array.isArray(e.panels)?e.panels:[],equipment:Array.isArray(e.equipment)?e.equipment:[],loads:Array.isArray(e.loads)?e.loads:[],oneLine:Array.isArray(e.oneLine)?e.oneLine:[],settings:e.settings&&"object"==typeof e.settings?e.settings:{}}}tt(r.ductbanks),rt(r.conduits),He(r.trays),We(r.cables),Qe(Array.isArray(r.cableTypicals)?r.cableTypicals:[]),it(Array.isArray(r.panels)?r.panels:[]),ut(Array.isArray(r.equipment)?r.equipment:[]),Ct(Array.isArray(r.loads)?r.loads:[]),Array.isArray(r.oneLine)?vt({activeSheet:0,sheets:r.oneLine}):r.oneLine&&Array.isArray(r.oneLine.sheets)?vt({activeSheet:r.oneLine.activeSheet||0,sheets:r.oneLine.sheets}):vt({activeSheet:0,sheets:[]});const i=new Set([...Object.values(De),"CTR_PROJECT_V1"]);for(const e of Jt())i.has(e)||r.settings&&e in r.settings||Pt(e);if(r.settings)for(const[e,t]of Object.entries(r.settings))Nt(e,t);return!0}"undefined"!=typeof window&&(window.dataStore={STORAGE_KEYS:qe,getTrays:Be,setTrays:He,getCables:Ke,setCables:We,getCableTypicals:Ye,setCableTypicals:Qe,addCable:Ze,getDuctbanks:et,setDuctbanks:tt,getConduits:nt,setConduits:rt,addRaceway:st,getPanels:ot,setPanels:it,getEquipment:ct,setEquipment:ut,addEquipment:dt,updateEquipment:ft,removeEquipment:yt,getLoads:At,setLoads:Ct,addLoad:Lt,insertLoad:xt,updateLoad:Tt,removeLoad:Ot,getOneLine:pt,setOneLine:vt,getRevisions:bt,restoreRevision:St,getStudies:wt,setStudies:jt,getItem:_t,setItem:Nt,removeItem:Pt,listScenarios:Ie,getCurrentScenario:function(){return K()},switchScenario:Re,cloneScenario:function(e,t=K()){e&&(ee(t,e),H(e))},compareStudies:function(e,t){const n=Ue(De.studies,{},e),r=Ue(De.studies,{},t);return{[e]:n,[t]:r}},on:function(e,t){$e[e]||($e[e]=[]),$e[e].push(t)},off:function(e,t){const n=$e[e];if(!n)return;const r=n.indexOf(t);r>=0&&n.splice(r,1)},keys:Jt,exportProject:Rt,importProject:Dt,saveProject:zt,loadProject:It,importFromCad:async function(t){let n;if("string"==typeof t)n=t;else{if(!t||"function"!=typeof t.text)throw new Error("Unsupported CAD file");n=await t.text()}const{trays:r=[],conduits:s=[]}=e(n);return Array.isArray(r)&&r.length&&He(r),Array.isArray(s)&&s.length&&rt(s),{trays:r,conduits:s}},exportToCad:function(e="json"){const t={trays:Be(),conduits:nt()};let n="application/json",r="json",s=JSON.stringify(t,null,2);if("csv"===e){const e="id,start_x,start_y,start_z,end_x,end_y,end_z,width,height",o=t.trays.map(e=>[e.id,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.width,e.height].join(",")),a="conduit_id,type,trade_size,start_x,start_y,start_z,end_x,end_y,end_z,capacity",i=t.conduits.map(e=>[e.conduit_id,e.type,e.trade_size,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.capacity].join(","));s=`# trays\n${[e,...o].join("\n")}\n# conduits\n${[a,...i].join("\n")}`,n="text/csv",r="csv"}if("undefined"!=typeof document)try{const e=new Blob([s],{type:n}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=`raceways.${r}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href)}catch(e){console.error("Failed to export CAD data",e)}return s}});function Ft(e){if(!e)return[];const t=e.ownerDocument||("undefined"!=typeof document?document:null);return t?Array.from(e.querySelectorAll("a[href], button:not([disabled]), textarea:not([disabled]), input:not([disabled]), select:not([disabled]), [tabindex]:not([tabindex='-1'])")).filter(e=>e.offsetWidth>0||e.offsetHeight>0||e===t.activeElement):[]}let qt=0;function $t(e={}){const t="undefined"==typeof document?null:document;if(!t)return Promise.resolve(null);const{title:n="Dialog",description:r="",primaryText:s="OK",secondaryText:o="Cancel",closeOnEscape:a=!0,closeOnBackdrop:i=!0,onSubmit:c,onCancel:l,render:u,initialFocusSelector:d,variant:f,closeLabel:y="Close dialog",resizable:p=!1,defaultWidth:h}=e;return new Promise(m=>{const b=t.activeElement instanceof HTMLElement?t.activeElement:null,g=t.createElement("div");g.className="modal component-modal",g.style.display="flex",g.setAttribute("role","dialog"),g.setAttribute("aria-modal","true"),qt+=1;const S=e.labelledById||`ctr-modal-title-${qt}`;g.setAttribute("aria-labelledby",S);let v=null;r&&(v=e.describedById||`ctr-modal-description-${qt}`,g.setAttribute("aria-describedby",v));const w=t.createElement("div");if(w.className="modal-content",f&&(w.dataset.variant=f),p&&w.classList.add("modal-resizable"),null!=h){const e="number"==typeof h?`${h}px`:String(h);w.style.width=e}const j=t.createElement("button");j.type="button",j.className="close-btn",j.setAttribute("aria-label",y),j.textContent="×";const A=t.createElement("h2");A.id=S,A.className="modal-title",A.textContent=n;const k=t.createElement("div");if(k.className="modal-body",r){const e=t.createElement("p");e.id=v,e.className="modal-description",e.textContent=r,k.appendChild(e)}const E=t.createElement("div");E.className="modal-actions";const C=t.createElement("button");C.type="button",C.className="btn primary-btn",C.textContent=s;let L=null;null!=o&&(L=t.createElement("button"),L.type="button",L.className="btn secondary-btn",L.textContent=o,E.appendChild(L)),E.appendChild(C),w.append(j,A,k,E),g.appendChild(w);const x=new Set;let T=null,O=!1,_=!1;function N(e,{cancelled:n=!1}={}){O||(O=!0,g.removeEventListener("keydown",D,!0),g.removeEventListener("click",R),g.removeEventListener("pointerdown",I),j.removeEventListener("click",z),L&&L.removeEventListener("click",z),C.removeEventListener("click",J),x.forEach(e=>e.removeEventListener("submit",P)),t.body.classList.remove("modal-open"),g.remove(),b&&"function"==typeof b.focus&&b.focus(),n&&"function"==typeof l&&l(),m(e))}function P(e){e.preventDefault(),J()}function J(){if("function"==typeof c){const e=c(F);if(!1===e)return;N(e)}else N(!0)}function z(){N(null,{cancelled:!0})}function I(e){_=e.target===g}function R(e){i&&(e.target===g&&_&&N(null,{cancelled:!0}),_=!1)}function D(e){if(a&&"Escape"===e.key)return e.preventDefault(),void N(null,{cancelled:!0});!function(e,t){if("Tab"!==e.key)return;const n=Ft(t);if(!n.length)return void e.preventDefault();const r=n[0],s=n[n.length-1],o=t.ownerDocument||("undefined"!=typeof document?document:null),a=o?.activeElement;e.shiftKey?a!==r&&t.contains(a)||(e.preventDefault(),s.focus()):a===s&&(e.preventDefault(),r.focus())}(e,w)}const F={close(e){N(e)},cancel(){N(null,{cancelled:!0})},setPrimaryDisabled(e){C.disabled=!!e},setPrimaryText(e){"string"==typeof e&&(C.textContent=e)},focusPrimary(){C.focus()},registerForm(e){e&&!x.has(e)&&(x.add(e),e.addEventListener("submit",P))},setInitialFocus(e){e instanceof HTMLElement&&(T=e)},descriptionId:v,titleId:S,overlay:g,content:w,body:k,primaryBtn:C};if("function"==typeof u){const e=u(k,F);T||(e instanceof HTMLElement?T=e:e&&e.initialFocus instanceof HTMLElement&&(T=e.initialFocus))}else if(e.message){const n=t.createElement("p");n.className="modal-message",n.textContent=e.message,k.appendChild(n)}j.addEventListener("click",z),L&&L.addEventListener("click",z),C.addEventListener("click",J),g.addEventListener("keydown",D,!0),g.addEventListener("pointerdown",I),g.addEventListener("click",R),t.body.appendChild(g),t.body.classList.add("modal-open"),setTimeout(function(){let e=T;if(!e&&d&&(e=w.querySelector(d)),!e){const t=Ft(w);e=t.find(e=>e!==j)||t[0]}e&&"function"==typeof e.focus?e.focus():C.focus()},0)})}function Mt(e,t,n={}){return $t({title:e,message:t,primaryText:n.confirmText||"Close",secondaryText:null,variant:n.variant,closeLabel:n.closeLabel||"Close dialog"})}function Gt(){return de()}function Ut(e){return"string"==typeof e?e.trim():""}function Vt(){const e=Ut(decodeURIComponent(location.hash.slice(1))||"");if(e)return e;if("undefined"!=typeof window){const e=Ut(window.currentProjectId||"");if(e)return e}try{const e=Ut(_e().name||"");if(e)return e}catch{}return""}function Bt(e){const t=Ut(e);if(!t)return"";try{const e=_e();(e.name||"")!==t&&(e.name=t,Ne(e))}catch(e){console.warn("Project state update failed",e)}return t}function Ht(){Se()}function Kt(){return ge()}function Wt(e,t,{allowExisting:n=!0,currentName:r=""}={}){const s=e.trim();if(!s)return"Project name is required.";if(s.includes(":"))return'Project name cannot include the ":" character.';const o=s.toLowerCase(),a=r.trim().toLowerCase();return!n&&t.some(e=>e.toLowerCase()===o&&e.toLowerCase()!==a)?"A project with that name already exists. Choose a different name or use Load Project.":""}function Yt(e){location.hash=encodeURIComponent(e),globalThis.applyProjectHash?.()}async function Qt({title:e,confirmLabel:t,message:n,initialValue:r="",allowExisting:s=!0,currentName:o=""}={}){if("undefined"==typeof document)return"";const a=Gt(),i=`project-name-${Math.random().toString(36).slice(2)}`,c=`${i}-error`;let l,u;const d=await $t({title:e||"Project Name",description:n||(s?"Enter a project name. Existing projects with the same name will be overwritten.":"Enter a unique name for the project."),primaryText:t||"Save",onSubmit(){const e=l.value.trim(),t=Wt(e,a,{allowExisting:s,currentName:o});return t?(u.textContent=t,l.setAttribute("aria-invalid","true"),l.focus(),!1):(l.removeAttribute("aria-invalid"),u.textContent="",e)},render(e,t){const n=e.ownerDocument,s=n.createElement("form");s.className="modal-form";const o=n.createElement("label");return o.setAttribute("for",i),o.textContent="Project name",l=n.createElement("input"),l.type="text",l.id=i,l.name="projectName",l.required=!0,l.value=r,l.autocomplete="off",l.spellcheck=!1,t.descriptionId?l.setAttribute("aria-describedby",`${t.descriptionId} ${c}`.trim()):l.setAttribute("aria-describedby",c),l.addEventListener("input",()=>{u.textContent="",l.removeAttribute("aria-invalid"),t.setPrimaryDisabled(!l.value.trim())}),o.appendChild(l),s.appendChild(o),u=n.createElement("p"),u.id=c,u.className="modal-error",u.setAttribute("role","alert"),u.textContent="",s.appendChild(u),t.registerForm(s),t.setPrimaryDisabled(!r.trim()),t.setInitialFocus(l),e.appendChild(s),l}});return"string"==typeof d?d.trim():""}async function Xt(){const e=Ut(await Qt({title:"Create New Project",confirmLabel:"Create",allowExisting:!1,message:"Choose a unique name for the new project."}));if(e){Yt(e),Bt(e);try{fe(e,{equipment:[],panels:[],loads:[],cables:[],raceways:{trays:[],conduits:[],ductbanks:[]},oneLine:{activeSheet:0,sheets:[]}})}catch(e){console.error("Failed to initialize new project storage",e)}location.reload()}}async function Zt(e={}){const{skipManual:t=!1}=e||{};if(!t){const e=globalThis.manualSaveProject;if("function"==typeof e){let t;try{t=await e()}catch(e){console.error(e),t=null}if(!1===t)return}}let n=Vt();if(!n){let e="";try{e=_e().name||""}catch{}n=await Qt({title:"Save Project",confirmLabel:"Save",allowExisting:!0,initialValue:e,currentName:e})}if(!n)return;Yt(n),zt(n);const r=ue();let s={attempted:!1,ok:!1},o=null;try{s=await async function(e){const t=Kt();if(!t)return{attempted:!1,ok:!1};const n=await fetch(`/projects/${encodeURIComponent(e)}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.token}`,"X-CSRF-Token":t.csrfToken},body:JSON.stringify(Rt())});return 401!==n.status&&403!==n.status||Ht(),{attempted:!0,ok:n.ok}}(n)}catch(e){console.error(e),o=e}const{attempted:a,ok:i}=s;if(r){const e=r.message||"Saved projects could not be updated. Clear saved data in Settings and try again.";let t;return t=a?i?"The project was uploaded to the server, but the local copy could not be updated.":"The project was not uploaded to the server.":"The project was saved locally, but not uploaded to the server.",void await Mt("Save Failed",`${e} ${t}`.trim())}let c;c=o||a&&!i?`Project "${n}" saved locally. Server sync failed.`:a?`Project "${n}" successfully saved.`:`Project "${n}" saved locally.`,alert(c)}async function en(){const e=Gt(),t=ue();if(t){const e=t.message||"Saved projects could not be read. Clear saved data in Settings and try again.";return void await Mt("Saved Projects Unavailable",e)}const n=await async function(e){if("undefined"==typeof document)return e[0]||"";if(!e.length)return await Mt("No Saved Projects","There are no saved projects to load yet. Save a project first."),"";let t=e[0]||"";const n=`project-select-${Math.random().toString(36).slice(2)}`,r=await $t({title:"Load Project",description:"Select a saved project to load.",primaryText:"Load",onSubmit:()=>t||!1,render(r,s){const o=r.ownerDocument,a=o.createElement("form");a.className="modal-form";const i=o.createElement("label");i.setAttribute("for",n),i.textContent="Saved projects";const c=o.createElement("select");return c.id=n,c.name="projectName",c.size=Math.min(6,Math.max(3,e.length)),c.className="modal-select",e.forEach(e=>{const t=o.createElement("option");t.value=e,t.textContent=e,c.appendChild(t)}),s.descriptionId&&c.setAttribute("aria-describedby",s.descriptionId),c.value=t,c.addEventListener("change",()=>{t=c.value,s.setPrimaryDisabled(!t)}),c.addEventListener("dblclick",()=>{c.value&&s.primaryBtn&&s.primaryBtn.click()}),i.appendChild(c),a.appendChild(i),s.registerForm(a),s.setPrimaryDisabled(!t),s.setInitialFocus(c),r.appendChild(a),c}});return"string"==typeof r?r:""}(e);if(!n)return;Yt(n);let r=!1;try{r=await async function(e){const t=Kt();if(!t)return!1;const n=await fetch(`/projects/${encodeURIComponent(e)}`,{headers:{Authorization:`Bearer ${t.token}`,"X-CSRF-Token":t.csrfToken}});if(401===n.status||403===n.status)return Ht(),!1;if(!n.ok)return!1;const{data:r}=await n.json();return Dt(r),!0}(n)}catch(e){console.error(e)}if(!r){const e=It(n),t=ue();if(t){const e=t.message||"Saved projects could not be read. Clear saved data in Settings and try again.";return void await Mt("Saved Project Migration Failed",e)}r=e}r?location.reload():await Mt("Project Not Found",`Project "${n}" could not be loaded from local storage.`)}"undefined"!=typeof window&&(window.projectManager={listProjects:Gt,newProject:Xt,renameProject:function(e){const t=Ut(e);if(!t)throw new Error("Project name is required.");const n=Vt(),r=Wt(t,Gt(),{allowExisting:!1,currentName:n});if(r)throw new Error(r);if(n&&t!==n)try{const e=ye(n);e&&(fe(t,e),pe(n))}catch(e){console.error("Project rename persistence failed",e)}return Yt(t),Bt(t),t},saveProject:Zt,loadProject:en},window.addEventListener("DOMContentLoaded",()=>{document.getElementById("new-project-btn")?.addEventListener("click",()=>{Xt().catch(console.error)}),document.getElementById("save-project-btn")?.addEventListener("click",()=>{Zt().catch(console.error)}),document.getElementById("load-project-btn")?.addEventListener("click",()=>{en().catch(console.error)});const e=document.getElementById("settings-menu");if(e){const t=document.createElement("button");function n(){t.textContent=Kt()?"Logout":"Login"}n(),t.addEventListener("click",()=>{Kt()?(Ht(),n()):location.href="login.html"}),e.appendChild(t)}}));
