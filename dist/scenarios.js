function e(e){if("string"==typeof e)try{return t(JSON.parse(e))}catch{return function(e){const t=[],n=[],s=/#\d+=IFC([^;]*?)SEGMENT[^;]*?IFCPOLYLINE\(\(([^)]+)\),\(([^)]+)\)\)/gi;let r,o=0;for(;r=s.exec(e);){const e=r[1]||"",s=r[2].split(",").map(e=>parseFloat(e)),i=r[3].split(",").map(e=>parseFloat(e)),c={id:"SEG-"+o++,start_x:s[0],start_y:s[1],start_z:s[2],end_x:i[0],end_y:i[1],end_z:i[2]};/CABLECARRIER/i.test(e)?t.push(c):n.push(c)}return{trays:t,conduits:n}}(e)}return t(e)}function t(e){if(!e||"object"!=typeof e)return{trays:[],conduits:[]};const t=[],n=[],o=e.trays||e.Trays||e.cableTrays||e.CableTrays||[];for(const e of o)t.push(s(e));const i=e.conduits||e.Conduits||e.cableConduits||e.ConduitSegments||[];for(const e of i)n.push(r(e));return{trays:t,conduits:n}}function n(e){const t=parseFloat(e);return Number.isFinite(t)?t:void 0}function s(e={}){return{id:e.id||e.tag||e.tray_id||e.TrayID||e.name||e.Tag||"",start_x:n(e.start_x??e.sx??e.x1??e.StartX??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.StartY??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.StartZ??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.EndX??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.EndY??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.EndZ??e.end?.z),width:n(e.width??e.w??e.Width??e.size_x),height:n(e.height??e.h??e.Height??e.size_y)}}function r(e={}){return{conduit_id:e.conduit_id||e.id||e.tag||e.ConduitID||"",type:e.type||e.conduit_type||e.Type||"",trade_size:e.trade_size||e.tradeSize||e.size||e.TradeSize||"",start_x:n(e.start_x??e.sx??e.x1??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.end?.z),capacity:n(e.capacity??e.fill)}}const o="CTR_PROJECT_V1",i="ctr_scenarios_v1",c="ctr_current_scenario_v1",a="CTR_SAVED_PROJECTS_V1",u="CTR_CONDUITS",d="authToken",l="authCsrfToken",f="authExpiresAt",y="authUser",p="undefined"!=typeof document&&document.baseURI?new URL("dist/vendor/fast-json-patch.mjs",document.baseURI).href:"undefined"!=typeof location&&location.href?new URL("dist/vendor/fast-json-patch.mjs",location.href).href:"./dist/vendor/fast-json-patch.mjs";function h(){return{name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}}}function g(e={}){const t=e.settings||{session:e.session||e.ctrSession||{},collapsedGroups:e.collapsedGroups||{}};return t.units||(t.units="imperial"),{name:e.name||"",ductbanks:e.ductbanks||e.ductbankSchedule||[],conduits:e.conduits||e.conduitSchedule||[],trays:e.trays||e.traySchedule||[],cables:e.cables||e.cableSchedule||[],settings:t}}let S,m,b,w={name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}};const A=[],v=[];let k=new Set;const j=new Set,_=new Map;let O=!1,L=!1;const x=2621440,E=new Set;let N=["base"],C="base",J=null,z={},R=!1,T=null;const P=new Set;function I(e){const t=ge();if(t){const n=we(t,e);if(null!=n)return n}return _.has(e)?_.get(e):null}function q(e,t,n={}){const s=Boolean(n&&n.skipLocalStorage);null==t?_.delete(e):_.set(e,t);const r=ge();if(r&&!O&&(!s||null==t))try{null==t?r.removeItem(e):r.setItem(e,t)}catch(t){Se("project storage write failed",e,t)}}function D(e){return"string"!=typeof e?"":e.trim()}function F(e){const t=Array.isArray(e)?e.map(D).filter(Boolean):[];return t.length||t.push("base"),[...new Set(t)]}function G(){N=F(N),N.includes(C)||N.push(C),q(i,JSON.stringify(N)),q(c,C)}function $(e,t){return`${e}:${t}`}function M(e,t){return I($(e,t))}function V(e,t,n,s){q($(e,t),n,s)}function U(){return[...N]}function B(e){N=F(e),N.includes(C)||N.push(C),G()}function K(e){const t=D(e);t&&(N.includes(t)||(N.push(t),G()))}function Y(){return C}function H(e){const t=D(e)||"base";C=t,N.includes(t)||N.push(t),G()}function Q(e,t,n=C){const s=M(D(n)||C,e);return null==s?t:Ae(s,t)}function W(e,t,n=C){const s=D(n)||C;try{const n=JSON.stringify(t),r=$(s,e);if(n.length>x){if(V(s,e,n,{skipLocalStorage:!0}),s===C&&Le(e,n,{skipLocalStorage:!0}),!E.has(r)){E.add(r);const e=2.5.toFixed(1);console.warn(`Scenario entry "${r}" exceeds ${e}MB. Data will persist for this tab only; use Save Project to keep a copy.`)}return}V(s,e,n),s===C&&Le(e,n)}catch(t){console.error("scenario write failed",e,t)}}function X(e,t=C){const n=D(t)||C;V(n,e,null),n===C&&xe(e)}function Z(e=C){return function(e){const t=new Set,n=ge();if(n)try{for(let s=0;s<n.length;s++){const r=n.key(s);r&&r.startsWith(e)&&t.add(r.slice(e.length))}}catch(e){console.warn("project storage enumerate failed",e)}for(const n of _.keys())n.startsWith(e)&&t.add(n.slice(e.length));return[...t]}(`${D(e)||C}:`)}function ee(e,t){const n=D(e)||C,s=D(t);if(!s)return;const r=Z(n);for(const e of r){const t=M(n,e);null!=t&&(V(s,e,t),s===C&&Le(e,t))}}const te=["equipment","panels","loads","cables","raceways","oneLine"],ne=new Set(te.filter(e=>"equipment"!==e));class se extends Error{constructor(e,t){super(e),this.name="SavedProjectMigrationError",t&&(this.cause=t)}}function re(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}function oe(e){if(void 0!==e)return JSON.parse(JSON.stringify(e))}function ie(e){return JSON.parse(JSON.stringify(e||{}))}function ce(){const e=new Map,t=new Set(te);for(const n of function(){const e=new Set,t=ge();if(t)try{for(let n=0;n<t.length;n++){const s=t.key(n);s&&e.add(s)}}catch(e){console.warn("project storage enumerate failed",e)}for(const t of _.keys())e.add(t);return[...e]}()){const s=n.indexOf(":");if(s<=0)continue;const r=n.slice(s+1);if(!t.has(r))continue;const o=n.slice(0,s);let i=e.get(o);i||(i={data:{},suffixes:new Set,keys:[]},e.set(o,i)),i.keys.push(n),i.suffixes.add(r);const c=I(n);if(null==c)continue;let a;try{a=JSON.parse(c)}catch(e){throw new se(`Saved project "${o}" could not be migrated because the "${r}" section is corrupted. Clear the saved project from browser storage and save again.`,e)}i.data[r]=a}if(!e.size)return null;const n={},s=[];for(const[t,r]of e){[...r.suffixes].some(e=>ne.has(e))&&(Object.keys(r.data).length&&(n[t]=ie(r.data),s.push(...r.keys)))}return Object.keys(n).length?{records:n,keysToRemove:s}:null}function ae(){if(T)throw T;if(Object.keys(z).length)try{q(a,JSON.stringify(z))}catch(e){const t=e instanceof Error?e:new Error(String(e)),n=t instanceof se?t:new se("Saved projects could not be written to storage.",t);throw T=n,n}else q(a,null)}function ue(){if(!R){R=!0,T=null,P.clear();try{const e=function(){const e=I(a);if(null==e)return{};let t;try{t=JSON.parse(e)}catch(e){throw new se("Saved projects could not be read because the stored data is corrupted. Clear the saved projects entry in browser storage and try again.",e)}if(!re(t))throw new se("Saved projects could not be read because the stored data is in an unexpected format.");return t}(),t=ce();if(t){const n=new Set(Object.keys(e));for(const e of Object.keys(t.records))n.has(e)||P.add(e);z={...t.records,...e},ae();for(const e of t.keysToRemove)q(e,null)}else z=e}catch(e){const t=e instanceof Error?e:new Error(String(e));T=t,z={},console.error("Saved project initialization failed",t)}}}function de(e,t={}){const n="string"==typeof e?e.trim():"";if(!n)return;if(ue(),T)throw T;const s=t&&"object"==typeof t?Object.entries(t):[];if(!s.length)return;const r=re(z[n])?{...z[n]}:{};for(const[e,t]of s){const n=oe(t);void 0===n?delete r[e]:r[e]=n}0===Object.keys(r).length?delete z[n]:z[n]=r,P.delete(n),ae()}function le(e){const t="string"==typeof e?e.trim():"";if(!t)return null;if(ue(),T)throw T;const n=z[t];return re(n)?ie(n):null}function fe(e){const t="string"==typeof e?e.trim():"";return!!t&&(ue(),!T&&P.has(t))}function ye(){const e=w.settings?.session;return e&&"object"==typeof e?JSON.parse(JSON.stringify(e)):{}}function pe(e={}){const t=e&&"object"==typeof e?e:{};try{Le("ctrSession",JSON.stringify(t))}catch(e){console.warn("session save failed",e)}return ye()}function he(){q(d,null),q(l,null),q(f,null),q(y,null)}function ge(){try{return"undefined"!=typeof localStorage?localStorage:null}catch{return null}}function Se(e,t,n){const s=n??t,r=void 0===n?[e,s]:[e,t,s];console.warn(...r),function(e){if(!e||"object"!=typeof e)return!1;const t=e.name;if("QuotaExceededError"===t||"NS_ERROR_DOM_QUOTA_REACHED"===t)return!0;if(22===e.code||1014===e.code)return!0;if("undefined"!=typeof DOMException&&e instanceof DOMException&&("QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name))return!0;const n="string"==typeof e.message?e.message:"";return n.toLowerCase().includes("quota")||n.toLowerCase().includes("exceeded")}(s)&&(O=!0,L||(L=!0,console.warn("Local storage quota exceeded. Further saves will be kept in memory only for this session.")))}function me(e,t,n,s="project save failed"){if(!e||O)return!1;try{return e.setItem(t,n),!0}catch(e){return Se(s,t,e),!1}}function be(e=w){return JSON.parse(JSON.stringify(e))}function we(e,t){try{return e.getItem(t)}catch{return null}}function Ae(e,t){if(null==e)return t;try{return JSON.parse(e)}catch{return t}}function ve(e){k=new Set(e),k.delete("session"),k.delete("collapsedGroups")}function ke(){const e=be();j.forEach(t=>{try{t(e)}catch(e){console.error(e)}})}function je(e){if(!e||O)return;const t=[["cableSchedule",JSON.stringify(w.cables||[])],["traySchedule",JSON.stringify(w.trays||[])],["conduitSchedule",JSON.stringify(w.conduits||[])],["ductbankSchedule",JSON.stringify(w.ductbanks||[])]];for(const[n,s]of t)if(!me(e,n,s))return;const n=w.settings?.session;if(void 0===n){if(!O)try{e.removeItem("ctrSession")}catch{}}else if(!me(e,"ctrSession",JSON.stringify(n)))return;const s=w.settings?.collapsedGroups;if(void 0===s){if(!O)try{e.removeItem("collapsedGroups")}catch{}}else if(!me(e,"collapsedGroups",JSON.stringify(s)))return;const r=w.settings&&"object"==typeof w.settings?w.settings:{},o=Object.keys(r).filter(e=>"session"!==e&&"collapsedGroups"!==e);for(const t of k)if(!o.includes(t)&&!O)try{e.removeItem(t)}catch{}for(const t of o){const n=r[t];if(!me(e,t,JSON.stringify(n)))return}k=new Set(o)}function _e({notify:e=!0}={}){const t=ge();if(t&&!O&&(je(t),!O))try{t.setItem(o,JSON.stringify(w))}catch(e){Se("project save failed",e)}e&&ke()}function Oe(e){if(S)try{const t=S(w,e);Array.isArray(t)&&t.length&&(A.push(t),v.length=0)}catch(e){console.warn("undo capture failed",e)}}function Le(e,t,n={}){if(!e)return;if(e===o){if(!n.skipLocalStorage){const n=ge();if(n&&!O)try{n.setItem(e,t)}catch(e){Se("project save failed",e)}}return}const s=be();if("cableSchedule"===e)w.cables=Ae(t,[]);else if("traySchedule"===e)w.trays=Ae(t,[]);else if("conduitSchedule"===e)w.conduits=Ae(t,[]);else if("ductbankSchedule"===e)w.ductbanks=Ae(t,[]);else if("collapsedGroups"===e)w.settings||(w.settings={}),w.settings.collapsedGroups=Ae(t,{});else if("ctrSession"===e)w.settings||(w.settings={}),w.settings.session=Ae(t,{});else{w.settings||(w.settings={});try{w.settings[e]=JSON.parse(t)}catch{w.settings[e]=t}}if(Oe(s),!n.skipLocalStorage){me(ge(),e,t)}_e()}function xe(e,t={}){if(!e)return;if(e===o){if(!t.skipLocalStorage){const t=ge();if(t&&!O)try{t.removeItem(e)}catch{}}return}const n=be();if("cableSchedule"===e?w.cables=[]:"traySchedule"===e?w.trays=[]:"conduitSchedule"===e?w.conduits=[]:"ductbankSchedule"===e?w.ductbanks=[]:"collapsedGroups"===e?w.settings&&delete w.settings.collapsedGroups:"ctrSession"===e?w.settings&&delete w.settings.session:w.settings&&delete w.settings[e],Oe(n),!t.skipLocalStorage){const t=ge();if(t&&!O)try{t.removeItem(e)}catch{}}_e()}!function(){const e=ge();if(!e)return w={name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}},void ve(Object.keys(w.settings||{}));let t;try{t=e.getItem(o)}catch{t=null}if(t)try{return w=g(JSON.parse(t)),void ve(Object.keys(w.settings||{}))}catch(e){console.warn("Failed to parse stored project",e)}const n=function(e){return{cables:Ae(we(e,"cableSchedule"),[]),trays:Ae(we(e,"traySchedule"),[]),conduits:Ae(we(e,"conduitSchedule"),[]),ductbanks:Ae(we(e,"ductbankSchedule"),[]),settings:{session:Ae(we(e,"ctrSession"),{}),collapsedGroups:Ae(we(e,"collapsedGroups"),{}),conduitFillData:Ae(we(e,"conduitFillData"),null),trayFillData:Ae(we(e,"trayFillData"),null),ductbankSession:Ae(we(e,"ductbankSession"),{})}}}(e);w=g(n),ve(Object.keys(w.settings||{})),_e({notify:!1})}(),function(){const e=Ae(I(i),["base"]);N=F(e);const t=I(c),n=D("string"==typeof t?t:"");C=n||N[0]||"base",N.includes(C)||N.push(C),G()}();const Ee={PROJECT_KEY:o,defaultProject:h,migrateProject:g,initializeProjectStorage:async function(){await(b||(b=import(p).then(e=>(m=e.applyPatch,S=e.compare,e))),b);const e=ge();"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("beforeunload",()=>{A.length=0,v.length=0}),window.addEventListener("storage",t=>{if(t.key)if(t.key!==o){if(t.key===i){const e=Ae(t.newValue,["base"]);return N=F(e),void(N.includes(C)||N.push(C))}if(t.key===c){const e=D(t.newValue||"");return C=e||N[0]||"base",void(N.includes(C)||N.push(C))}if(t.key===u&&(J=null,t.newValue)){const e=Ae(t.newValue,null);e&&"object"==typeof e&&(J={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]})}}else{if(!t.newValue)return;try{w=g(JSON.parse(t.newValue)),ve(Object.keys(w.settings||{})),e&&je(e),ke()}catch(e){console.warn("project sync failed",e)}}})),ke()},getProjectState:function(){return be()},setProjectState:function(e){const t=be();w=g(e||{}),Oe(t),_e()},setProjectKey:Le,removeProjectKey:xe,undoProjectChange:function(){if(!A.length||!m)return;const e=A.pop(),t=be();try{const n=m(t,e,!0).newDocument;if(S)try{v.push(S(n,w))}catch{v.push([])}else v.push([]);w=g(n),_e()}catch(e){console.warn("undo failed",e)}},redoProjectChange:function(){if(!v.length||!m)return;const e=v.pop(),t=be();try{const n=m(t,e,!0).newDocument;if(S)try{A.push(S(n,w))}catch{A.push([])}else A.push([]);w=g(n),_e()}catch(e){console.warn("redo failed",e)}},canUndo:function(){return A.length>0},canRedo:function(){return v.length>0},onProjectChange:function(e){return"function"!=typeof e?()=>{}:(j.add(e),()=>{j.delete(e)})},getScenarioListState:U,setScenarioListState:B,registerScenario:K,getCurrentScenarioNameState:Y,setCurrentScenarioNameState:H,readScenarioValue:Q,writeScenarioValue:W,removeScenarioValue:X,listScenarioKeysState:Z,cloneScenarioStorage:ee,getSavedProjectsError:function(){return ue(),T},listSavedProjects:function(){return ue(),T?[]:Object.keys(z).sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}))},writeSavedProject:de,readSavedProject:le,removeSavedProject:function(e){const t="string"==typeof e?e.trim():"";if(t){if(ue(),T)throw T;t in z&&(delete z[t],P.delete(t),ae())}},wasSavedProjectMigrated:fe,getSessionPreferences:ye,setSessionPreferences:pe,updateSessionPreferences:function(e){const t=ye(),n="function"==typeof e?e(t):{...t,...e&&"object"==typeof e?e:{}};return pe(n&&"object"==typeof n?n:{})},getConduitCache:function(){if(J)return JSON.parse(JSON.stringify(J));const e=Ae(I(u),null);return e&&"object"==typeof e?(J={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]},JSON.parse(JSON.stringify(J))):(J=null,null)},setConduitCache:function(e){if(!e||"object"!=typeof e)return J=null,q(u,null),null;const t={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]};J={ductbanks:JSON.parse(JSON.stringify(t.ductbanks)),conduits:JSON.parse(JSON.stringify(t.conduits))},q(u,JSON.stringify(J));try{Le("ductbankSchedule",JSON.stringify(t.ductbanks))}catch{}try{Le("conduitSchedule",JSON.stringify(t.conduits))}catch{}return JSON.parse(JSON.stringify(J))},clearConduitCache:function(){J=null,q(u,null)},getAuthContextState:function(){const e=I(d),t=I(l),n=I(f);if(!e||!t||!n)return null;const s=Number.parseInt(n,10);return Number.isFinite(s)?Date.now()>=s?(he(),null):{token:e,csrfToken:t,expiresAt:s,user:I(y)||null}:(he(),null)},setAuthContextState:function({token:e,csrfToken:t,expiresAt:n,user:s}){if(!e||!t)return;const r=Number(n);Number.isFinite(r)&&(q(d,e),q(l,t),q(f,String(r)),q(y,null==s?null:String(s)))},clearAuthContextState:he};function Ne(){return[...U()]}function Ce(){return Y()}function Je(e){e&&(K(e),H(e),qe("scenario",Y()))}function ze(e,t=Y()){e&&(ee(t,e),K(e))}"undefined"!=typeof globalThis&&(globalThis.projectStorage=Ee),K(Y());const Re={trays:"traySchedule",cables:"cableSchedule",ductbanks:"ductbankSchedule",conduits:"conduitSchedule",panels:"panelSchedule",loads:"loadList",equipment:"equipment",oneLine:"oneLineDiagram",studies:"studyResults",traySchedule:"traySchedule",cableSchedule:"cableSchedule",ductbankSchedule:"ductbankSchedule",conduitSchedule:"conduitSchedule",panelSchedule:"panelSchedule",loadList:"loadList",equipmentList:"equipment",oneLineDiagram:"oneLineDiagram"},Te={equipmentColumns:"equipmentColumns",collapsedGroups:"collapsedGroups"},Pe={...Re,...Te},Ie={};function qe(e,t){(Ie[e]||[]).forEach(e=>{try{e(t)}catch(e){console.error(e)}})}const De=new Set([...Object.values(Re),...Object.values(Te)]);function Fe(e,t,n=Y()){return Q(e,t,n)}function Ge(e,t,n=Y()){try{W(e,t,n),qe(e,t)}catch(t){console.error("Failed to store",e,t)}}"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("storage",e=>{if(!e.key)return;const[t,n]=e.key.split(":");if(n&&t===Y()&&De.has(n))try{qe(n,e.newValue?JSON.parse(e.newValue):void 0)}catch{}});const $e=()=>Fe(Re.trays,[]),Me=e=>Ge(Re.trays,e),Ve=()=>Fe(Re.cables,[]),Ue=e=>Ge(Re.cables,e),Be=e=>{const t=Ve();t.push(e),Ue(t)},Ke=()=>Fe(Re.ductbanks,[]),Ye=e=>Ge(Re.ductbanks,e),He=()=>Fe(Re.conduits,[]),Qe=e=>Ge(Re.conduits,e),We=e=>{if(e)if(e.tray_id){const t=$e();t.push(e),Me(t)}else{const t=He();t.push(e),Qe(t)}},Xe=()=>Fe(Re.panels,[]);function Ze(e){return{id:"",description:"",ref:"",voltage:"",manufacturer:"",model:"",phases:"",notes:"",mainRating:"",circuitCount:42,...e}}const et=e=>Ge(Re.panels,e.map(Ze)),tt=()=>Fe(Re.equipment,[]);function nt(e){return{id:"",ref:"",description:"",voltage:"",category:"",subCategory:"",x:"",y:"",z:"",manufacturer:"",model:"",phases:"",notes:"",...e}}const st=e=>Ge(Re.equipment,e.map(nt)),rt=e=>{const t=tt();t.push(nt(e)),st(t)},ot=(e,t)=>{const n=tt();e>=0&&e<n.length&&(n[e]=nt({...n[e],...t}),st(n))},it=e=>{const t=tt();e>=0&&e<t.length&&(t.splice(e,1),st(t))},ct=(e=Y())=>{const t=Fe(Re.oneLine,{},e);return Array.isArray(t)?{activeSheet:0,sheets:[{name:"Sheet 1",components:t,connections:[]}]}:t&&Array.isArray(t.sheets)?{activeSheet:t.activeSheet||0,sheets:t.sheets.map(e=>({name:e.name,components:Array.isArray(e.components)?e.components:[],connections:Array.isArray(e.connections)?e.connections:[]}))}:{activeSheet:0,sheets:[]}},at="oneLineRevisions",ut=(e=Y())=>Fe(at,[],e);const dt=(e,t=Y())=>{const n=ut(t)[e];return n&&Ge(Re.oneLine,{activeSheet:0,sheets:n.sheets},t),n?n.sheets:null},lt=(e,t=Y())=>{const n=ct(t);Array.isArray(n.sheets)&&n.sheets.length&&function(e,t=Y()){const n=ut(t);n.push({time:Date.now(),sheets:JSON.parse(JSON.stringify(e))}),Ge(at,n,t)}(n.sheets,t);const s={activeSheet:e.activeSheet||0,sheets:Array.isArray(e.sheets)?e.sheets:[]};Ge(Re.oneLine,s,t)},ft=()=>Fe(Re.studies,{}),yt=e=>Ge(Re.studies,e),pt=()=>{const e=Fe(Re.loads,[]),t=e.map(ht);return e.some(e=>e&&"object"==typeof e&&!("source"in e))&&Ge(Re.loads,t),t};function ht(e){const t={...e};return"power"in t&&!("kw"in t)&&(t.kw=t.power,delete t.power),{id:"",ref:"",source:"",tag:"",description:"",quantity:"",voltage:"",loadType:"",duty:"",kw:"",powerFactor:"",loadFactor:"",efficiency:"",demandFactor:"",phases:"",circuit:"",manufacturer:"",model:"",notes:"",...t}}function gt(e){const t=ht(e);return Object.values(t).every(e=>""===e)}const St=e=>{const t=(e.length?e:[{}]).map(ht);Ge(Re.loads,t)},mt=e=>{const t=pt(),n=ht(e);1===t.length&&gt(t[0])&&!gt(n)?t[0]=n:t.push(n),St(t)},bt=(e,t)=>{const n=pt(),s=ht(t),r=Math.max(0,Math.min(e,n.length));n.splice(r,0,s),St(n)},wt=(e,t)=>{const n=pt();e>=0&&e<n.length&&(n[e]=ht({...n[e],...t}),St(n))},At=e=>{const t=pt();e>=0&&e<t.length&&(t.splice(e,1),St(t))},vt=(e,t=null,n)=>Fe(e,t,n),kt=(e,t,n)=>Ge(e,t,n),jt=(e,t=Y())=>{try{X(e,t),qe(e,null)}catch(t){console.error("Failed to remove",e,t)}},_t=(e=Y())=>{try{return Z(e)}catch{return[]}};function Ot(e,t=Y()){if(e)try{de(e,{equipment:tt(),panels:Xe(),loads:pt(),cables:Ve(),raceways:{trays:$e(),conduits:He(),ductbanks:Ke()},oneLine:ct(t)})}catch(e){console.error("Failed to save project",e)}}function Lt(e){e.innerHTML="";for(const t of Ne()){const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}e.value=Ce()}"undefined"!=typeof window&&(window.dataStore={STORAGE_KEYS:Pe,getTrays:$e,setTrays:Me,getCables:Ve,setCables:Ue,addCable:Be,getDuctbanks:Ke,setDuctbanks:Ye,getConduits:He,setConduits:Qe,addRaceway:We,getPanels:Xe,setPanels:et,getEquipment:tt,setEquipment:st,addEquipment:rt,updateEquipment:ot,removeEquipment:it,getLoads:pt,setLoads:St,addLoad:mt,insertLoad:bt,updateLoad:wt,removeLoad:At,getOneLine:ct,setOneLine:lt,getRevisions:ut,restoreRevision:dt,getStudies:ft,setStudies:yt,getItem:vt,setItem:kt,removeItem:jt,listScenarios:Ne,getCurrentScenario:Ce,switchScenario:Je,cloneScenario:ze,compareStudies:function(e,t){const n=Fe(Re.studies,{},e),s=Fe(Re.studies,{},t);return{[e]:n,[t]:s}},on:function(e,t){Ie[e]||(Ie[e]=[]),Ie[e].push(t)},off:function(e,t){const n=Ie[e];if(!n)return;const s=n.indexOf(t);s>=0&&n.splice(s,1)},keys:_t,exportProject:function(){const e={ductbanks:Ke(),conduits:He(),trays:$e(),cables:Ve(),panels:Xe(),equipment:tt(),loads:pt(),oneLine:ct(),settings:{}},t=new Set([...Object.values(Re),"CTR_PROJECT_V1"]);for(const n of _t())t.has(n)||(e.settings[n]=vt(n));return{meta:{version:1,scenario:Y(),scenarios:Ne()},...e}},importProject:function(e){const{meta:t,...n}=e||{};t&&Array.isArray(t.scenarios)&&B(t.scenarios),t&&t.scenario&&Je(t.scenario);let s=n;const{valid:r,missing:o,extra:i}=function(e){const t=["ductbanks","conduits","trays","cables","panels","equipment","loads","settings"],n=["oneLine"],s=[],r=[];if(!e||"object"!=typeof e)return s.push(...t),{valid:!1,missing:s,extra:r};for(const n of t)n in e||s.push(n);for(const s of Object.keys(e))t.includes(s)||n.includes(s)||r.push(s);const o=Array.isArray(e.ductbanks)&&Array.isArray(e.conduits)&&Array.isArray(e.trays)&&Array.isArray(e.cables)&&Array.isArray(e.panels)&&Array.isArray(e.equipment)&&Array.isArray(e.loads)&&e.settings&&"object"==typeof e.settings&&!Array.isArray(e.settings)&&(void 0===e.oneLine||Array.isArray(e.oneLine)||Array.isArray(e.oneLine?.sheets));return{valid:0===s.length&&0===r.length&&o,missing:s,extra:r}}(s);if(!r){const t=[];o.length&&t.push(`Missing fields: ${o.join(", ")}`),i.length&&t.push(`Extra fields: ${i.join(", ")}`);const n=t.join("\n")||"Invalid project data.";if("undefined"==typeof window||"function"!=typeof window.confirm||!window.confirm(`${n}\nRepair & continue?`))return!1;s={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[],trays:Array.isArray(e.trays)?e.trays:[],cables:Array.isArray(e.cables)?e.cables:[],panels:Array.isArray(e.panels)?e.panels:[],equipment:Array.isArray(e.equipment)?e.equipment:[],loads:Array.isArray(e.loads)?e.loads:[],oneLine:Array.isArray(e.oneLine)?e.oneLine:[],settings:e.settings&&"object"==typeof e.settings?e.settings:{}}}Ye(s.ductbanks),Qe(s.conduits),Me(s.trays),Ue(s.cables),et(Array.isArray(s.panels)?s.panels:[]),st(Array.isArray(s.equipment)?s.equipment:[]),St(Array.isArray(s.loads)?s.loads:[]),Array.isArray(s.oneLine)?lt({activeSheet:0,sheets:s.oneLine}):s.oneLine&&Array.isArray(s.oneLine.sheets)?lt({activeSheet:s.oneLine.activeSheet||0,sheets:s.oneLine.sheets}):lt({activeSheet:0,sheets:[]});const c=new Set([...Object.values(Re),"CTR_PROJECT_V1"]);for(const e of _t())c.has(e)||s.settings&&e in s.settings||jt(e);if(s.settings)for(const[e,t]of Object.entries(s.settings))kt(e,t);return!0},saveProject:Ot,loadProject:function(e,t=Y()){if(!e)return!1;try{const n=le(e);if(!n)return!1;const s=n||{},r=fe(e),o=s.equipment,i=s.panels,c=s.loads,a=s.cables,u=s.raceways||{},d=s.oneLine||{};return Array.isArray(o)?st(o):st([]),Array.isArray(i)?et(i):et([]),Array.isArray(c)&&St(c),Array.isArray(a)?Ue(a):Ue([]),Me(Array.isArray(u.trays)?u.trays:[]),Qe(Array.isArray(u.conduits)?u.conduits:[]),Ye(Array.isArray(u.ductbanks)?u.ductbanks:[]),Array.isArray(d)?lt({activeSheet:0,sheets:d},t):lt(d||{activeSheet:0,sheets:[]},t),r&&Ot(e,t),!0}catch(e){return console.error("Failed to load project",e),!1}},importFromCad:async function(t){let n;if("string"==typeof t)n=t;else{if(!t||"function"!=typeof t.text)throw new Error("Unsupported CAD file");n=await t.text()}const{trays:s=[],conduits:r=[]}=e(n);return Array.isArray(s)&&s.length&&Me(s),Array.isArray(r)&&r.length&&Qe(r),{trays:s,conduits:r}},exportToCad:function(e="json"){const t={trays:$e(),conduits:He()};let n="application/json",s="json",r=JSON.stringify(t,null,2);if("csv"===e){const e="id,start_x,start_y,start_z,end_x,end_y,end_z,width,height",o=t.trays.map(e=>[e.id,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.width,e.height].join(",")),i="conduit_id,type,trade_size,start_x,start_y,start_z,end_x,end_y,end_z,capacity",c=t.conduits.map(e=>[e.conduit_id,e.type,e.trade_size,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.capacity].join(","));r=`# trays\n${[e,...o].join("\n")}\n# conduits\n${[i,...c].join("\n")}`,n="text/csv",s="csv"}if("undefined"!=typeof document)try{const e=new Blob([r],{type:n}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=`raceways.${s}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href)}catch(e){console.error("Failed to export CAD data",e)}return r}}),document.addEventListener("DOMContentLoaded",function(){!function(){const e=["base","future","emergency"],t=Ne();for(const n of e)t.includes(n)||ze(n)}();const e=document.getElementById("scenario-select");if(!e)return;Lt(e),e.addEventListener("change",e=>{Je(e.target.value),location.reload()});const t=document.getElementById("scenario-duplicate-btn");t?.addEventListener("click",()=>{const t=prompt("New scenario name");t&&(ze(t),Lt(e),e.value=t,Je(t),location.reload())});const n=document.getElementById("scenario-diff-btn");n?.addEventListener("click",()=>{const e=prompt("Compare with which scenario?",Ne().join(", "));e&&function(e,t){const n=document.getElementById("diagram");if(!n)return;n.querySelectorAll(".scenario-diff").forEach(e=>e.classList.remove("scenario-diff"));const{sheets:s}=ct(e),{sheets:r}=ct(t),o=e=>{const t=new Map;for(const n of e)for(const e of n.components||[])t.set(e.id,JSON.stringify(e));return t},i=o(s),c=o(r),a=new Set;for(const[e,t]of i)c.get(e)!==t&&a.add(e);for(const e of c.keys())i.has(e)||a.add(e);a.forEach(e=>{const t=n.querySelector(`g.component[data-id="${e}"]`);t&&t.classList.add("scenario-diff")})}(Ce(),e)});const s=document.getElementById("revision-btn");s?.addEventListener("click",()=>{const e=ut();if(!e.length)return void alert("No revisions");const t=e.map((e,t)=>`${t}: ${new Date(e.time).toLocaleString()}`).join("\n"),n=prompt(`Restore which revision?\n${t}`),s=Number(n);Number.isNaN(s)||(dt(s),location.reload())})});
