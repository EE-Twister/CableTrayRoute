function e(e){if("string"==typeof e)try{return t(JSON.parse(e))}catch{return function(e){const t=[],n=[],s=/#\d+=IFC([^;]*?)SEGMENT[^;]*?IFCPOLYLINE\(\(([^)]+)\),\(([^)]+)\)\)/gi;let r,o=0;for(;r=s.exec(e);){const e=r[1]||"",s=r[2].split(",").map(e=>parseFloat(e)),i=r[3].split(",").map(e=>parseFloat(e)),c={id:"SEG-"+o++,start_x:s[0],start_y:s[1],start_z:s[2],end_x:i[0],end_y:i[1],end_z:i[2]};/CABLECARRIER/i.test(e)?t.push(c):n.push(c)}return{trays:t,conduits:n}}(e)}return t(e)}function t(e){if(!e||"object"!=typeof e)return{trays:[],conduits:[]};const t=[],n=[],o=e.trays||e.Trays||e.cableTrays||e.CableTrays||[];for(const e of o)t.push(s(e));const i=e.conduits||e.Conduits||e.cableConduits||e.ConduitSegments||[];for(const e of i)n.push(r(e));return{trays:t,conduits:n}}function n(e){const t=parseFloat(e);return Number.isFinite(t)?t:void 0}function s(e={}){return{id:e.id||e.tag||e.tray_id||e.TrayID||e.name||e.Tag||"",start_x:n(e.start_x??e.sx??e.x1??e.StartX??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.StartY??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.StartZ??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.EndX??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.EndY??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.EndZ??e.end?.z),width:n(e.width??e.w??e.Width??e.size_x),height:n(e.height??e.h??e.Height??e.size_y)}}function r(e={}){return{conduit_id:e.conduit_id||e.id||e.tag||e.ConduitID||"",type:e.type||e.conduit_type||e.Type||"",trade_size:e.trade_size||e.tradeSize||e.size||e.TradeSize||"",start_x:n(e.start_x??e.sx??e.x1??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.end?.z),capacity:n(e.capacity??e.fill)}}const o="CTR_PROJECT_V1",i="ctr_scenarios_v1",c="ctr_current_scenario_v1",a="CTR_SAVED_PROJECTS_V1",u="CTR_CONDUITS",l="authToken",d="authCsrfToken",f="authExpiresAt",y="authUser",p="undefined"!=typeof document&&document.baseURI?new URL("dist/vendor/fast-json-patch.mjs",document.baseURI).href:"undefined"!=typeof location&&location.href?new URL("dist/vendor/fast-json-patch.mjs",location.href).href:"./dist/vendor/fast-json-patch.mjs";function h(){return{name:"",ductbanks:[],conduits:[],trays:[],cables:[],cableTypicals:[],settings:{session:{},collapsedGroups:{},units:"imperial"}}}function g(e={}){const t=e.settings||{session:e.session||e.ctrSession||{},collapsedGroups:e.collapsedGroups||{}};return t.units||(t.units="imperial"),{name:e.name||"",ductbanks:e.ductbanks||e.ductbankSchedule||[],conduits:e.conduits||e.conduitSchedule||[],trays:e.trays||e.traySchedule||[],cables:e.cables||e.cableSchedule||[],cableTypicals:e.cableTypicals||[],settings:t}}let S,b,m,A={name:"",ductbanks:[],conduits:[],trays:[],cables:[],cableTypicals:[],settings:{session:{},collapsedGroups:{},units:"imperial"}};const w=[],v=[];let k=new Set;const j=new Set,_=new Map;let O=!1,L=!1;const T=2621440,x=new Set;let E=["base"],N="base",C=null,J={},z=!1,R=null;const P=new Set;function I(e){const t=ge();if(t){const n=Ae(t,e);if(null!=n)return n}return _.has(e)?_.get(e):null}function q(e,t,n={}){const s=Boolean(n&&n.skipLocalStorage);null==t?_.delete(e):_.set(e,t);const r=ge();if(r&&!O&&(!s||null==t))try{null==t?r.removeItem(e):r.setItem(e,t)}catch(t){Se("project storage write failed",e,t)}}function D(e){return"string"!=typeof e?"":e.trim()}function F(e){const t=Array.isArray(e)?e.map(D).filter(Boolean):[];return t.length||t.push("base"),[...new Set(t)]}function G(){E=F(E),E.includes(N)||E.push(N),q(i,JSON.stringify(E)),q(c,N)}function $(e,t){return`${e}:${t}`}function M(e,t){return I($(e,t))}function V(e,t,n,s){q($(e,t),n,s)}function U(){return[...E]}function B(e){E=F(e),E.includes(N)||E.push(N),G()}function K(e){const t=D(e);t&&(E.includes(t)||(E.push(t),G()))}function Y(){return N}function H(e){const t=D(e)||"base";N=t,E.includes(t)||E.push(t),G()}function Q(e,t,n=N){const s=M(D(n)||N,e);return null==s?t:we(s,t)}function W(e,t,n=N){const s=D(n)||N;try{const n=JSON.stringify(t),r=$(s,e);if(n.length>T){if(V(s,e,n,{skipLocalStorage:!0}),s===N&&Le(e,n,{skipLocalStorage:!0}),!x.has(r)){x.add(r);const e=2.5.toFixed(1);console.warn(`Scenario entry "${r}" exceeds ${e}MB. Data will persist for this tab only; use Save Project to keep a copy.`)}return}V(s,e,n),s===N&&Le(e,n)}catch(t){console.error("scenario write failed",e,t)}}function X(e,t=N){const n=D(t)||N;V(n,e,null),n===N&&Te(e)}function Z(e=N){return function(e){const t=new Set,n=ge();if(n)try{for(let s=0;s<n.length;s++){const r=n.key(s);r&&r.startsWith(e)&&t.add(r.slice(e.length))}}catch(e){console.warn("project storage enumerate failed",e)}for(const n of _.keys())n.startsWith(e)&&t.add(n.slice(e.length));return[...t]}(`${D(e)||N}:`)}function ee(e,t){const n=D(e)||N,s=D(t);if(!s)return;const r=Z(n);for(const e of r){const t=M(n,e);null!=t&&(V(s,e,t),s===N&&Le(e,t))}}const te=["equipment","panels","loads","cables","cableTypicals","raceways","oneLine"],ne=new Set(te.filter(e=>"equipment"!==e));class se extends Error{constructor(e,t){super(e),this.name="SavedProjectMigrationError",t&&(this.cause=t)}}function re(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}function oe(e){if(void 0!==e)return JSON.parse(JSON.stringify(e))}function ie(e){return JSON.parse(JSON.stringify(e||{}))}function ce(){const e=new Map,t=new Set(te);for(const n of function(){const e=new Set,t=ge();if(t)try{for(let n=0;n<t.length;n++){const s=t.key(n);s&&e.add(s)}}catch(e){console.warn("project storage enumerate failed",e)}for(const t of _.keys())e.add(t);return[...e]}()){const s=n.indexOf(":");if(s<=0)continue;const r=n.slice(s+1);if(!t.has(r))continue;const o=n.slice(0,s);let i=e.get(o);i||(i={data:{},suffixes:new Set,keys:[]},e.set(o,i)),i.keys.push(n),i.suffixes.add(r);const c=I(n);if(null==c)continue;let a;try{a=JSON.parse(c)}catch(e){throw new se(`Saved project "${o}" could not be migrated because the "${r}" section is corrupted. Clear the saved project from browser storage and save again.`,e)}i.data[r]=a}if(!e.size)return null;const n={},s=[];for(const[t,r]of e){[...r.suffixes].some(e=>ne.has(e))&&(Object.keys(r.data).length&&(n[t]=ie(r.data),s.push(...r.keys)))}return Object.keys(n).length?{records:n,keysToRemove:s}:null}function ae(){if(R)throw R;if(Object.keys(J).length)try{q(a,JSON.stringify(J))}catch(e){const t=e instanceof Error?e:new Error(String(e)),n=t instanceof se?t:new se("Saved projects could not be written to storage.",t);throw R=n,n}else q(a,null)}function ue(){if(!z){z=!0,R=null,P.clear();try{const e=function(){const e=I(a);if(null==e)return{};let t;try{t=JSON.parse(e)}catch(e){throw new se("Saved projects could not be read because the stored data is corrupted. Clear the saved projects entry in browser storage and try again.",e)}if(!re(t))throw new se("Saved projects could not be read because the stored data is in an unexpected format.");return t}(),t=ce();if(t){const n=new Set(Object.keys(e));for(const e of Object.keys(t.records))n.has(e)||P.add(e);J={...t.records,...e},ae();for(const e of t.keysToRemove)q(e,null)}else J=e}catch(e){const t=e instanceof Error?e:new Error(String(e));R=t,J={},console.error("Saved project initialization failed",t)}}}function le(e,t={}){const n="string"==typeof e?e.trim():"";if(!n)return;if(ue(),R)throw R;const s=t&&"object"==typeof t?Object.entries(t):[];if(!s.length)return;const r=re(J[n])?{...J[n]}:{};for(const[e,t]of s){const n=oe(t);void 0===n?delete r[e]:r[e]=n}0===Object.keys(r).length?delete J[n]:J[n]=r,P.delete(n),ae()}function de(e){const t="string"==typeof e?e.trim():"";if(!t)return null;if(ue(),R)throw R;const n=J[t];return re(n)?ie(n):null}function fe(e){const t="string"==typeof e?e.trim():"";return!!t&&(ue(),!R&&P.has(t))}function ye(){const e=A.settings?.session;return e&&"object"==typeof e?JSON.parse(JSON.stringify(e)):{}}function pe(e={}){const t=e&&"object"==typeof e?e:{};try{Le("ctrSession",JSON.stringify(t))}catch(e){console.warn("session save failed",e)}return ye()}function he(){q(l,null),q(d,null),q(f,null),q(y,null)}function ge(){try{return"undefined"!=typeof localStorage?localStorage:null}catch{return null}}function Se(e,t,n){const s=n??t,r=void 0===n?[e,s]:[e,t,s];console.warn(...r),function(e){if(!e||"object"!=typeof e)return!1;const t=e.name;if("QuotaExceededError"===t||"NS_ERROR_DOM_QUOTA_REACHED"===t)return!0;if(22===e.code||1014===e.code)return!0;if("undefined"!=typeof DOMException&&e instanceof DOMException&&("QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name))return!0;const n="string"==typeof e.message?e.message:"";return n.toLowerCase().includes("quota")||n.toLowerCase().includes("exceeded")}(s)&&(O=!0,L||(L=!0,console.warn("Local storage quota exceeded. Further saves will be kept in memory only for this session.")))}function be(e,t,n,s="project save failed"){if(!e||O)return!1;try{return e.setItem(t,n),!0}catch(e){return Se(s,t,e),!1}}function me(e=A){return JSON.parse(JSON.stringify(e))}function Ae(e,t){try{return e.getItem(t)}catch{return null}}function we(e,t){if(null==e)return t;try{return JSON.parse(e)}catch{return t}}function ve(e){k=new Set(e),k.delete("session"),k.delete("collapsedGroups")}function ke(){const e=me();j.forEach(t=>{try{t(e)}catch(e){console.error(e)}})}function je(e){if(!e||O)return;const t=[["cableSchedule",JSON.stringify(A.cables||[])],["traySchedule",JSON.stringify(A.trays||[])],["conduitSchedule",JSON.stringify(A.conduits||[])],["ductbankSchedule",JSON.stringify(A.ductbanks||[])],["cableTypicals",JSON.stringify(A.cableTypicals||[])]];for(const[n,s]of t)if(!be(e,n,s))return;const n=A.settings?.session;if(void 0===n){if(!O)try{e.removeItem("ctrSession")}catch{}}else if(!be(e,"ctrSession",JSON.stringify(n)))return;const s=A.settings?.collapsedGroups;if(void 0===s){if(!O)try{e.removeItem("collapsedGroups")}catch{}}else if(!be(e,"collapsedGroups",JSON.stringify(s)))return;const r=A.settings&&"object"==typeof A.settings?A.settings:{},o=Object.keys(r).filter(e=>"session"!==e&&"collapsedGroups"!==e);for(const t of k)if(!o.includes(t)&&!O)try{e.removeItem(t)}catch{}for(const t of o){const n=r[t];if(!be(e,t,JSON.stringify(n)))return}k=new Set(o)}function _e({notify:e=!0}={}){const t=ge();if(t&&!O&&(je(t),!O))try{t.setItem(o,JSON.stringify(A))}catch(e){Se("project save failed",e)}e&&ke()}function Oe(e){if(S)try{const t=S(A,e);Array.isArray(t)&&t.length&&(w.push(t),v.length=0)}catch(e){console.warn("undo capture failed",e)}}function Le(e,t,n={}){if(!e)return;if(e===o){if(!n.skipLocalStorage){const n=ge();if(n&&!O)try{n.setItem(e,t)}catch(e){Se("project save failed",e)}}return}const s=me();if("cableSchedule"===e)A.cables=we(t,[]);else if("traySchedule"===e)A.trays=we(t,[]);else if("conduitSchedule"===e)A.conduits=we(t,[]);else if("ductbankSchedule"===e)A.ductbanks=we(t,[]);else if("cableTypicals"===e)A.cableTypicals=we(t,[]);else if("collapsedGroups"===e)A.settings||(A.settings={}),A.settings.collapsedGroups=we(t,{});else if("ctrSession"===e)A.settings||(A.settings={}),A.settings.session=we(t,{});else{A.settings||(A.settings={});try{A.settings[e]=JSON.parse(t)}catch{A.settings[e]=t}}if(Oe(s),!n.skipLocalStorage){be(ge(),e,t)}_e()}function Te(e,t={}){if(!e)return;if(e===o){if(!t.skipLocalStorage){const t=ge();if(t&&!O)try{t.removeItem(e)}catch{}}return}const n=me();if("cableSchedule"===e?A.cables=[]:"traySchedule"===e?A.trays=[]:"conduitSchedule"===e?A.conduits=[]:"ductbankSchedule"===e?A.ductbanks=[]:"cableTypicals"===e?A.cableTypicals=[]:"collapsedGroups"===e?A.settings&&delete A.settings.collapsedGroups:"ctrSession"===e?A.settings&&delete A.settings.session:A.settings&&delete A.settings[e],Oe(n),!t.skipLocalStorage){const t=ge();if(t&&!O)try{t.removeItem(e)}catch{}}_e()}!function(){const e=ge();if(!e)return A={name:"",ductbanks:[],conduits:[],trays:[],cables:[],cableTypicals:[],settings:{session:{},collapsedGroups:{},units:"imperial"}},void ve(Object.keys(A.settings||{}));let t;try{t=e.getItem(o)}catch{t=null}if(t)try{return A=g(JSON.parse(t)),void ve(Object.keys(A.settings||{}))}catch(e){console.warn("Failed to parse stored project",e)}const n=function(e){return{cables:we(Ae(e,"cableSchedule"),[]),trays:we(Ae(e,"traySchedule"),[]),conduits:we(Ae(e,"conduitSchedule"),[]),ductbanks:we(Ae(e,"ductbankSchedule"),[]),cableTypicals:we(Ae(e,"cableTypicals"),[]),settings:{session:we(Ae(e,"ctrSession"),{}),collapsedGroups:we(Ae(e,"collapsedGroups"),{}),conduitFillData:we(Ae(e,"conduitFillData"),null),trayFillData:we(Ae(e,"trayFillData"),null),ductbankSession:we(Ae(e,"ductbankSession"),{})}}}(e);A=g(n),ve(Object.keys(A.settings||{})),_e({notify:!1})}(),function(){const e=we(I(i),["base"]);E=F(e);const t=I(c),n=D("string"==typeof t?t:"");N=n||E[0]||"base",E.includes(N)||E.push(N),G()}();const xe={PROJECT_KEY:o,defaultProject:h,migrateProject:g,initializeProjectStorage:async function(){await(m||(m=import(p).then(e=>(b=e.applyPatch,S=e.compare,e))),m);const e=ge();"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("beforeunload",()=>{w.length=0,v.length=0}),window.addEventListener("storage",t=>{if(t.key)if(t.key!==o){if(t.key===i){const e=we(t.newValue,["base"]);return E=F(e),void(E.includes(N)||E.push(N))}if(t.key===c){const e=D(t.newValue||"");return N=e||E[0]||"base",void(E.includes(N)||E.push(N))}if(t.key===u&&(C=null,t.newValue)){const e=we(t.newValue,null);e&&"object"==typeof e&&(C={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]})}}else{if(!t.newValue)return;try{A=g(JSON.parse(t.newValue)),ve(Object.keys(A.settings||{})),e&&je(e),ke()}catch(e){console.warn("project sync failed",e)}}})),ke()},getProjectState:function(){return me()},setProjectState:function(e){const t=me();A=g(e||{}),Oe(t),_e()},setProjectKey:Le,removeProjectKey:Te,undoProjectChange:function(){if(!w.length||!b)return;const e=w.pop(),t=me();try{const n=b(t,e,!0).newDocument;if(S)try{v.push(S(n,A))}catch{v.push([])}else v.push([]);A=g(n),_e()}catch(e){console.warn("undo failed",e)}},redoProjectChange:function(){if(!v.length||!b)return;const e=v.pop(),t=me();try{const n=b(t,e,!0).newDocument;if(S)try{w.push(S(n,A))}catch{w.push([])}else w.push([]);A=g(n),_e()}catch(e){console.warn("redo failed",e)}},canUndo:function(){return w.length>0},canRedo:function(){return v.length>0},onProjectChange:function(e){return"function"!=typeof e?()=>{}:(j.add(e),()=>{j.delete(e)})},getScenarioListState:U,setScenarioListState:B,registerScenario:K,getCurrentScenarioNameState:Y,setCurrentScenarioNameState:H,readScenarioValue:Q,writeScenarioValue:W,removeScenarioValue:X,listScenarioKeysState:Z,cloneScenarioStorage:ee,getSavedProjectsError:function(){return ue(),R},listSavedProjects:function(){return ue(),R?[]:Object.keys(J).sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}))},writeSavedProject:le,readSavedProject:de,removeSavedProject:function(e){const t="string"==typeof e?e.trim():"";if(t){if(ue(),R)throw R;t in J&&(delete J[t],P.delete(t),ae())}},wasSavedProjectMigrated:fe,getSessionPreferences:ye,setSessionPreferences:pe,updateSessionPreferences:function(e){const t=ye(),n="function"==typeof e?e(t):{...t,...e&&"object"==typeof e?e:{}};return pe(n&&"object"==typeof n?n:{})},getConduitCache:function(){if(C)return JSON.parse(JSON.stringify(C));const e=we(I(u),null);return e&&"object"==typeof e?(C={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]},JSON.parse(JSON.stringify(C))):(C=null,null)},setConduitCache:function(e){if(!e||"object"!=typeof e)return C=null,q(u,null),null;const t={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]};C={ductbanks:JSON.parse(JSON.stringify(t.ductbanks)),conduits:JSON.parse(JSON.stringify(t.conduits))},q(u,JSON.stringify(C));try{Le("ductbankSchedule",JSON.stringify(t.ductbanks))}catch{}try{Le("conduitSchedule",JSON.stringify(t.conduits))}catch{}return JSON.parse(JSON.stringify(C))},clearConduitCache:function(){C=null,q(u,null)},getAuthContextState:function(){const e=I(l),t=I(d),n=I(f);if(!e||!t||!n)return null;const s=Number.parseInt(n,10);return Number.isFinite(s)?Date.now()>=s?(he(),null):{token:e,csrfToken:t,expiresAt:s,user:I(y)||null}:(he(),null)},setAuthContextState:function({token:e,csrfToken:t,expiresAt:n,user:s}){if(!e||!t)return;const r=Number(n);Number.isFinite(r)&&(q(l,e),q(d,t),q(f,String(r)),q(y,null==s?null:String(s)))},clearAuthContextState:he};function Ee(){return[...U()]}function Ne(){return Y()}function Ce(e){e&&(K(e),H(e),qe("scenario",Y()))}function Je(e,t=Y()){e&&(ee(t,e),K(e))}"undefined"!=typeof globalThis&&(globalThis.projectStorage=xe),K(Y());const ze={trays:"traySchedule",cables:"cableSchedule",cableTypicals:"cableTypicals",ductbanks:"ductbankSchedule",conduits:"conduitSchedule",panels:"panelSchedule",loads:"loadList",equipment:"equipment",oneLine:"oneLineDiagram",studies:"studyResults",traySchedule:"traySchedule",cableSchedule:"cableSchedule",ductbankSchedule:"ductbankSchedule",conduitSchedule:"conduitSchedule",panelSchedule:"panelSchedule",loadList:"loadList",equipmentList:"equipment",oneLineDiagram:"oneLineDiagram"},Re={equipmentColumns:"equipmentColumns",collapsedGroups:"collapsedGroups",cableSchedulePreset:"cableSchedulePreset",cableTemplates:"cableTemplates"},Pe={...ze,...Re},Ie={};function qe(e,t){(Ie[e]||[]).forEach(e=>{try{e(t)}catch(e){console.error(e)}})}const De=new Set([...Object.values(ze),...Object.values(Re)]);function Fe(e,t,n=Y()){return Q(e,t,n)}function Ge(e,t,n=Y()){try{W(e,t,n),qe(e,t)}catch(t){console.error("Failed to store",e,t)}}"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("storage",e=>{if(!e.key)return;const[t,n]=e.key.split(":");if(n&&t===Y()&&De.has(n))try{qe(n,e.newValue?JSON.parse(e.newValue):void 0)}catch{}});const $e=()=>Fe(ze.trays,[]),Me=e=>Ge(ze.trays,e),Ve=()=>Fe(ze.cables,[]),Ue=e=>Ge(ze.cables,e),Be=()=>Fe(ze.cableTypicals,[]),Ke=e=>Ge(ze.cableTypicals,e),Ye=e=>Ge(Re.cableTemplates,e),He=e=>{const t=Ve();t.push(e),Ue(t)},Qe=()=>Fe(ze.ductbanks,[]),We=e=>Ge(ze.ductbanks,e),Xe=()=>Fe(ze.conduits,[]),Ze=e=>Ge(ze.conduits,e),et=e=>{if(e)if(e.tray_id){const t=$e();t.push(e),Me(t)}else{const t=Xe();t.push(e),Ze(t)}},tt=()=>Fe(ze.panels,[]);function nt(e){return{id:"",description:"",ref:"",voltage:"",manufacturer:"",model:"",phases:"",notes:"",mainRating:"",circuitCount:42,...e}}const st=e=>Ge(ze.panels,e.map(nt)),rt=()=>Fe(ze.equipment,[]);function ot(e){return{id:"",ref:"",description:"",voltage:"",category:"",subCategory:"",x:"",y:"",z:"",manufacturer:"",model:"",phases:"",notes:"",...e}}const it=e=>Ge(ze.equipment,e.map(ot)),ct=e=>{const t=rt();t.push(ot(e)),it(t)},at=(e,t)=>{const n=rt();e>=0&&e<n.length&&(n[e]=ot({...n[e],...t}),it(n))},ut=e=>{const t=rt();e>=0&&e<t.length&&(t.splice(e,1),it(t))},lt=(e=Y())=>{const t=Fe(ze.oneLine,{},e);return Array.isArray(t)?{activeSheet:0,sheets:[{name:"Sheet 1",components:t,connections:[]}]}:t&&Array.isArray(t.sheets)?{activeSheet:t.activeSheet||0,sheets:t.sheets.map(e=>({name:e.name,components:Array.isArray(e.components)?e.components:[],connections:Array.isArray(e.connections)?e.connections:[]}))}:{activeSheet:0,sheets:[]}},dt="oneLineRevisions",ft=1572864;const yt=(e=Y())=>Fe(dt,[],e);function pt(e,t=Y()){const n=yt(t);n.push({time:Date.now(),sheets:JSON.parse(JSON.stringify(e))}),function(e){if(!Array.isArray(e))return[];e.length>10&&e.splice(0,e.length-10);{let t=JSON.stringify(e);if(t.length>ft){for(;e.length>1&&t.length>ft;)e.shift(),t=JSON.stringify(e);t.length>ft&&(e.length=0)}}}(n),Ge(dt,n,t)}const ht=(e,t=Y())=>{const n=yt(t)[e];return n&&Ge(ze.oneLine,{activeSheet:0,sheets:n.sheets},t),n?n.sheets:null},gt=(e,t=Y())=>{const n=lt(t);Array.isArray(n.sheets)&&n.sheets.length&&pt(n.sheets,t);const s={activeSheet:e.activeSheet||0,sheets:Array.isArray(e.sheets)?e.sheets:[]};Ge(ze.oneLine,s,t)},St=()=>Fe(ze.studies,{}),bt=e=>Ge(ze.studies,e),mt=()=>{const e=Fe(ze.loads,[]),t=e.map(At);return e.some(e=>e&&"object"==typeof e&&!("source"in e))&&Ge(ze.loads,t),t};function At(e){const t={...e};return"power"in t&&!("kw"in t)&&(t.kw=t.power,delete t.power),{id:"",ref:"",source:"",tag:"",description:"",quantity:"",voltage:"",loadType:"",duty:"",kw:"",powerFactor:"",loadFactor:"",efficiency:"",demandFactor:"",phases:"",circuit:"",manufacturer:"",model:"",notes:"",...t}}function wt(e){const t=At(e);return Object.values(t).every(e=>""===e)}const vt=e=>{const t=(e.length?e:[{}]).map(At);Ge(ze.loads,t)},kt=e=>{const t=mt(),n=At(e);1===t.length&&wt(t[0])&&!wt(n)?t[0]=n:t.push(n),vt(t)},jt=(e,t)=>{const n=mt(),s=At(t),r=Math.max(0,Math.min(e,n.length));n.splice(r,0,s),vt(n)},_t=(e,t)=>{const n=mt();e>=0&&e<n.length&&(n[e]=At({...n[e],...t}),vt(n))},Ot=e=>{const t=mt();e>=0&&e<t.length&&(t.splice(e,1),vt(t))},Lt=(e,t=null,n)=>Fe(e,t,n),Tt=(e,t,n)=>Ge(e,t,n),xt=(e,t=Y())=>{try{X(e,t),qe(e,null)}catch(t){console.error("Failed to remove",e,t)}},Et=(e=Y())=>{try{return Z(e)}catch{return[]}};function Nt(e,t=Y()){if(e)try{le(e,{equipment:rt(),panels:tt(),loads:mt(),cables:Ve(),cableTypicals:Be(),cableTemplates:Fe(Re.cableTemplates,[]),raceways:{trays:$e(),conduits:Xe(),ductbanks:Qe()},oneLine:lt(t)})}catch(e){console.error("Failed to save project",e)}}function Ct(e){e.innerHTML="";for(const t of Ee()){const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}e.value=Ne()}"undefined"!=typeof window&&(window.dataStore={STORAGE_KEYS:Pe,getTrays:$e,setTrays:Me,getCables:Ve,setCables:Ue,getCableTypicals:Be,setCableTypicals:Ke,addCable:He,getDuctbanks:Qe,setDuctbanks:We,getConduits:Xe,setConduits:Ze,addRaceway:et,getPanels:tt,setPanels:st,getEquipment:rt,setEquipment:it,addEquipment:ct,updateEquipment:at,removeEquipment:ut,getLoads:mt,setLoads:vt,addLoad:kt,insertLoad:jt,updateLoad:_t,removeLoad:Ot,getOneLine:lt,setOneLine:gt,getRevisions:yt,restoreRevision:ht,getStudies:St,setStudies:bt,getItem:Lt,setItem:Tt,removeItem:xt,listScenarios:Ee,getCurrentScenario:Ne,switchScenario:Ce,cloneScenario:Je,compareStudies:function(e,t){const n=Fe(ze.studies,{},e),s=Fe(ze.studies,{},t);return{[e]:n,[t]:s}},on:function(e,t){Ie[e]||(Ie[e]=[]),Ie[e].push(t)},off:function(e,t){const n=Ie[e];if(!n)return;const s=n.indexOf(t);s>=0&&n.splice(s,1)},keys:Et,exportProject:function(){const e={ductbanks:Qe(),conduits:Xe(),trays:$e(),cables:Ve(),cableTypicals:Be(),panels:tt(),equipment:rt(),loads:mt(),oneLine:lt(),settings:{}},t=new Set([...Object.values(ze),"CTR_PROJECT_V1"]);for(const n of Et())t.has(n)||(e.settings[n]=Lt(n));return{meta:{version:1,scenario:Y(),scenarios:Ee()},...e}},importProject:function(e){const{meta:t,...n}=e||{};t&&Array.isArray(t.scenarios)&&B(t.scenarios),t&&t.scenario&&Ce(t.scenario);let s=n;const{valid:r,missing:o,extra:i}=function(e){const t=["ductbanks","conduits","trays","cables","cableTypicals","panels","equipment","loads","settings"],n=["oneLine"],s=[],r=[];if(!e||"object"!=typeof e)return s.push(...t),{valid:!1,missing:s,extra:r};for(const n of t)n in e||s.push(n);for(const s of Object.keys(e))t.includes(s)||n.includes(s)||r.push(s);const o=Array.isArray(e.ductbanks)&&Array.isArray(e.conduits)&&Array.isArray(e.trays)&&Array.isArray(e.cables)&&Array.isArray(e.cableTypicals)&&Array.isArray(e.panels)&&Array.isArray(e.equipment)&&Array.isArray(e.loads)&&e.settings&&"object"==typeof e.settings&&!Array.isArray(e.settings)&&(void 0===e.oneLine||Array.isArray(e.oneLine)||Array.isArray(e.oneLine?.sheets));return{valid:0===s.length&&0===r.length&&o,missing:s,extra:r}}(s);if(!r){const t=[];o.length&&t.push(`Missing fields: ${o.join(", ")}`),i.length&&t.push(`Extra fields: ${i.join(", ")}`);const n=t.join("\n")||"Invalid project data.";if("undefined"==typeof window||"function"!=typeof window.confirm||!window.confirm(`${n}\nRepair & continue?`))return!1;s={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[],trays:Array.isArray(e.trays)?e.trays:[],cables:Array.isArray(e.cables)?e.cables:[],cableTypicals:Array.isArray(e.cableTypicals)?e.cableTypicals:[],panels:Array.isArray(e.panels)?e.panels:[],equipment:Array.isArray(e.equipment)?e.equipment:[],loads:Array.isArray(e.loads)?e.loads:[],oneLine:Array.isArray(e.oneLine)?e.oneLine:[],settings:e.settings&&"object"==typeof e.settings?e.settings:{}}}We(s.ductbanks),Ze(s.conduits),Me(s.trays),Ue(s.cables),Ke(Array.isArray(s.cableTypicals)?s.cableTypicals:[]),st(Array.isArray(s.panels)?s.panels:[]),it(Array.isArray(s.equipment)?s.equipment:[]),vt(Array.isArray(s.loads)?s.loads:[]),Array.isArray(s.oneLine)?gt({activeSheet:0,sheets:s.oneLine}):s.oneLine&&Array.isArray(s.oneLine.sheets)?gt({activeSheet:s.oneLine.activeSheet||0,sheets:s.oneLine.sheets}):gt({activeSheet:0,sheets:[]});const c=new Set([...Object.values(ze),"CTR_PROJECT_V1"]);for(const e of Et())c.has(e)||s.settings&&e in s.settings||xt(e);if(s.settings)for(const[e,t]of Object.entries(s.settings))Tt(e,t);return!0},saveProject:Nt,loadProject:function(e,t=Y()){if(!e)return!1;try{const n=de(e);if(!n)return!1;const s=n||{},r=fe(e),o=s.equipment,i=s.panels,c=s.loads,a=s.cables,u=s.cableTypicals,l=s.cableTemplates,d=s.raceways||{},f=s.oneLine||{};return Array.isArray(o)?it(o):it([]),Array.isArray(i)?st(i):st([]),Array.isArray(c)&&vt(c),Array.isArray(a)?Ue(a):Ue([]),Array.isArray(u)?Ke(u):Ke([]),Array.isArray(l)?Ye(l):Ye([]),Me(Array.isArray(d.trays)?d.trays:[]),Ze(Array.isArray(d.conduits)?d.conduits:[]),We(Array.isArray(d.ductbanks)?d.ductbanks:[]),Array.isArray(f)?gt({activeSheet:0,sheets:f},t):gt(f||{activeSheet:0,sheets:[]},t),r&&Nt(e,t),!0}catch(e){return console.error("Failed to load project",e),!1}},importFromCad:async function(t){let n;if("string"==typeof t)n=t;else{if(!t||"function"!=typeof t.text)throw new Error("Unsupported CAD file");n=await t.text()}const{trays:s=[],conduits:r=[]}=e(n);return Array.isArray(s)&&s.length&&Me(s),Array.isArray(r)&&r.length&&Ze(r),{trays:s,conduits:r}},exportToCad:function(e="json"){const t={trays:$e(),conduits:Xe()};let n="application/json",s="json",r=JSON.stringify(t,null,2);if("csv"===e){const e="id,start_x,start_y,start_z,end_x,end_y,end_z,width,height",o=t.trays.map(e=>[e.id,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.width,e.height].join(",")),i="conduit_id,type,trade_size,start_x,start_y,start_z,end_x,end_y,end_z,capacity",c=t.conduits.map(e=>[e.conduit_id,e.type,e.trade_size,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.capacity].join(","));r=`# trays\n${[e,...o].join("\n")}\n# conduits\n${[i,...c].join("\n")}`,n="text/csv",s="csv"}if("undefined"!=typeof document)try{const e=new Blob([r],{type:n}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=`raceways.${s}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href)}catch(e){console.error("Failed to export CAD data",e)}return r}}),document.addEventListener("DOMContentLoaded",function(){!function(){const e=["base","future","emergency"],t=Ee();for(const n of e)t.includes(n)||Je(n)}();const e=document.getElementById("scenario-select");if(!e)return;Ct(e),e.addEventListener("change",e=>{Ce(e.target.value),location.reload()});const t=document.getElementById("scenario-duplicate-btn");t?.addEventListener("click",()=>{const t=prompt("New scenario name");t&&(Je(t),Ct(e),e.value=t,Ce(t),location.reload())});const n=document.getElementById("scenario-diff-btn");n?.addEventListener("click",()=>{const e=prompt("Compare with which scenario?",Ee().join(", "));e&&function(e,t){const n=document.getElementById("diagram");if(!n)return;n.querySelectorAll(".scenario-diff").forEach(e=>e.classList.remove("scenario-diff"));const{sheets:s}=lt(e),{sheets:r}=lt(t),o=e=>{const t=new Map;for(const n of e)for(const e of n.components||[])t.set(e.id,JSON.stringify(e));return t},i=o(s),c=o(r),a=new Set;for(const[e,t]of i)c.get(e)!==t&&a.add(e);for(const e of c.keys())i.has(e)||a.add(e);a.forEach(e=>{const t=n.querySelector(`g.component[data-id="${e}"]`);t&&t.classList.add("scenario-diff")})}(Ne(),e)});const s=document.getElementById("revision-btn");s?.addEventListener("click",()=>{const e=yt();if(!e.length)return void alert("No revisions");const t=e.map((e,t)=>`${t}: ${new Date(e.time).toLocaleString()}`).join("\n"),n=prompt(`Restore which revision?\n${t}`),s=Number(n);Number.isNaN(s)||(ht(s),location.reload())})});
