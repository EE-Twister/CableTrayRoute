function e(e){if("string"==typeof e)try{return t(JSON.parse(e))}catch{return function(e){const t=[],n=[],s=/#\d+=IFC([^;]*?)SEGMENT[^;]*?IFCPOLYLINE\(\(([^)]+)\),\(([^)]+)\)\)/gi;let r,o=0;for(;r=s.exec(e);){const e=r[1]||"",s=r[2].split(",").map(e=>parseFloat(e)),i=r[3].split(",").map(e=>parseFloat(e)),c={id:"SEG-"+o++,start_x:s[0],start_y:s[1],start_z:s[2],end_x:i[0],end_y:i[1],end_z:i[2]};/CABLECARRIER/i.test(e)?t.push(c):n.push(c)}return{trays:t,conduits:n}}(e)}return t(e)}function t(e){if(!e||"object"!=typeof e)return{trays:[],conduits:[]};const t=[],n=[],o=e.trays||e.Trays||e.cableTrays||e.CableTrays||[];for(const e of o)t.push(s(e));const i=e.conduits||e.Conduits||e.cableConduits||e.ConduitSegments||[];for(const e of i)n.push(r(e));return{trays:t,conduits:n}}function n(e){const t=parseFloat(e);return Number.isFinite(t)?t:void 0}function s(e={}){return{id:e.id||e.tag||e.tray_id||e.TrayID||e.name||e.Tag||"",start_x:n(e.start_x??e.sx??e.x1??e.StartX??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.StartY??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.StartZ??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.EndX??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.EndY??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.EndZ??e.end?.z),width:n(e.width??e.w??e.Width??e.size_x),height:n(e.height??e.h??e.Height??e.size_y)}}function r(e={}){return{conduit_id:e.conduit_id||e.id||e.tag||e.ConduitID||"",type:e.type||e.conduit_type||e.Type||"",trade_size:e.trade_size||e.tradeSize||e.size||e.TradeSize||"",start_x:n(e.start_x??e.sx??e.x1??e.start?.x),start_y:n(e.start_y??e.sy??e.y1??e.start?.y),start_z:n(e.start_z??e.sz??e.z1??e.start?.z),end_x:n(e.end_x??e.ex??e.x2??e.end?.x),end_y:n(e.end_y??e.ey??e.y2??e.end?.y),end_z:n(e.end_z??e.ez??e.z2??e.end?.z),capacity:n(e.capacity??e.fill)}}const o="CTR_PROJECT_V1",i="ctr_scenarios_v1",c="ctr_current_scenario_v1",a="CTR_CONDUITS",u="authToken",d="authCsrfToken",l="authExpiresAt",f="authUser",y="undefined"!=typeof document&&document.baseURI?new URL("dist/vendor/fast-json-patch.mjs",document.baseURI).href:"undefined"!=typeof location&&location.href?new URL("dist/vendor/fast-json-patch.mjs",location.href).href:"./dist/vendor/fast-json-patch.mjs";function p(){return{name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}}}function h(e={}){const t=e.settings||{session:e.session||e.ctrSession||{},collapsedGroups:e.collapsedGroups||{}};return t.units||(t.units="imperial"),{name:e.name||"",ductbanks:e.ductbanks||e.ductbankSchedule||[],conduits:e.conduits||e.conduitSchedule||[],trays:e.trays||e.traySchedule||[],cables:e.cables||e.cableSchedule||[],settings:t}}let g,m,S,b={name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}};const A=[],w=[];let v=new Set;const j=new Set,k=new Map;let _=["base"],L="base",O=null;function N(e){const t=Q();if(t){const n=te(t,e);if(null!=n)return n}return k.has(e)?k.get(e):null}function C(e,t){null==t?k.delete(e):k.set(e,t);const n=Q();if(n)try{null==t?n.removeItem(e):n.setItem(e,t)}catch(t){console.warn("project storage write failed",e,t)}}function x(e){const t=new Set,n=Q();if(n)try{for(let s=0;s<n.length;s++){const r=n.key(s);r&&r.startsWith(e)&&t.add(r.slice(e.length))}}catch(e){console.warn("project storage enumerate failed",e)}for(const n of k.keys())n.startsWith(e)&&t.add(n.slice(e.length));return[...t]}function E(e){return"string"!=typeof e?"":e.trim()}function J(e){const t=Array.isArray(e)?e.map(E).filter(Boolean):[];return t.length||t.push("base"),[...new Set(t)]}function z(){_=J(_),_.includes(L)||_.push(L),C(i,JSON.stringify(_)),C(c,L)}function I(e,t){return`${e}:${t}`}function P(e,t){return N(I(e,t))}function R(e,t,n){C(I(e,t),n)}function T(){return[..._]}function q(e){_=J(e),_.includes(L)||_.push(L),z()}function F(e){const t=E(e);t&&(_.includes(t)||(_.push(t),z()))}function G(){return L}function D(e){const t=E(e)||"base";L=t,_.includes(t)||_.push(t),z()}function $(e,t,n=L){const s=P(E(n)||L,e);return null==s?t:ne(s,t)}function V(e,t,n=L){const s=E(n)||L;try{const n=JSON.stringify(t);R(s,e,n),s===L&&ae(e,n)}catch(t){console.error("scenario write failed",e,t)}}function U(e,t=L){const n=E(t)||L;R(n,e,null),n===L&&ue(e)}function B(e=L){return x(`${E(e)||L}:`)}function M(e,t){const n=E(e)||L,s=E(t);if(!s)return;const r=B(n);for(const e of r){const t=P(n,e);null!=t&&(R(s,e,t),s===L&&ae(e,t))}}const K=["equipment","panels","loads","cables","raceways","oneLine"];function Y(e,t={}){const n="string"==typeof e?e.trim():"";if(n)for(const[e,s]of Object.entries(t))try{C(`${n}:${e}`,JSON.stringify(s))}catch(t){console.error("project save failed",e,t)}}function W(e){const t="string"==typeof e?e.trim():"";if(!t)return null;const n=`${t}:`,s={};for(const e of x(n)){const t=N(n+e);null!=t&&(s[e]=ne(t,null))}return s}function H(){const e=b.settings?.session;return e&&"object"==typeof e?JSON.parse(JSON.stringify(e)):{}}function X(e={}){const t=e&&"object"==typeof e?e:{};try{ae("ctrSession",JSON.stringify(t))}catch(e){console.warn("session save failed",e)}return H()}function Z(){C(u,null),C(d,null),C(l,null),C(f,null)}function Q(){try{return"undefined"!=typeof localStorage?localStorage:null}catch{return null}}function ee(e=b){return JSON.parse(JSON.stringify(e))}function te(e,t){try{return e.getItem(t)}catch{return null}}function ne(e,t){if(null==e)return t;try{return JSON.parse(e)}catch{return t}}function se(e){v=new Set(e),v.delete("session"),v.delete("collapsedGroups")}function re(){const e=ee();j.forEach(t=>{try{t(e)}catch(e){console.error(e)}})}function oe(e){if(!e)return;try{e.setItem("cableSchedule",JSON.stringify(b.cables||[]))}catch(e){console.warn("project save failed",e)}try{e.setItem("traySchedule",JSON.stringify(b.trays||[]))}catch(e){console.warn("project save failed",e)}try{e.setItem("conduitSchedule",JSON.stringify(b.conduits||[]))}catch(e){console.warn("project save failed",e)}try{e.setItem("ductbankSchedule",JSON.stringify(b.ductbanks||[]))}catch(e){console.warn("project save failed",e)}const t=b.settings?.session;if(void 0===t)try{e.removeItem("ctrSession")}catch{}else try{e.setItem("ctrSession",JSON.stringify(t))}catch(e){console.warn("project save failed",e)}const n=b.settings?.collapsedGroups;if(void 0===n)try{e.removeItem("collapsedGroups")}catch{}else try{e.setItem("collapsedGroups",JSON.stringify(n))}catch(e){console.warn("project save failed",e)}const s=b.settings&&"object"==typeof b.settings?b.settings:{},r=Object.keys(s).filter(e=>"session"!==e&&"collapsedGroups"!==e);for(const t of v)if(!r.includes(t))try{e.removeItem(t)}catch{}for(const t of r){const n=s[t];try{e.setItem(t,JSON.stringify(n))}catch(e){console.warn("project save failed",t,e)}}v=new Set(r)}function ie({notify:e=!0}={}){const t=Q();if(t){oe(t);try{t.setItem(o,JSON.stringify(b))}catch(e){console.warn("project save failed",e)}}e&&re()}function ce(e){if(g)try{const t=g(b,e);Array.isArray(t)&&t.length&&(A.push(t),w.length=0)}catch(e){console.warn("undo capture failed",e)}}function ae(e,t,n={}){if(!e)return;if(e===o){if(!n.skipLocalStorage){const n=Q();if(n)try{n.setItem(e,t)}catch(e){console.warn("project save failed",e)}}return}const s=ee();if("cableSchedule"===e)b.cables=ne(t,[]);else if("traySchedule"===e)b.trays=ne(t,[]);else if("conduitSchedule"===e)b.conduits=ne(t,[]);else if("ductbankSchedule"===e)b.ductbanks=ne(t,[]);else if("collapsedGroups"===e)b.settings||(b.settings={}),b.settings.collapsedGroups=ne(t,{});else if("ctrSession"===e)b.settings||(b.settings={}),b.settings.session=ne(t,{});else{b.settings||(b.settings={});try{b.settings[e]=JSON.parse(t)}catch{b.settings[e]=t}}if(ce(s),!n.skipLocalStorage){const n=Q();if(n)try{n.setItem(e,t)}catch(e){console.warn("project save failed",e)}}ie()}function ue(e,t={}){if(!e)return;if(e===o){if(!t.skipLocalStorage){const t=Q();if(t)try{t.removeItem(e)}catch{}}return}const n=ee();if("cableSchedule"===e?b.cables=[]:"traySchedule"===e?b.trays=[]:"conduitSchedule"===e?b.conduits=[]:"ductbankSchedule"===e?b.ductbanks=[]:"collapsedGroups"===e?b.settings&&delete b.settings.collapsedGroups:"ctrSession"===e?b.settings&&delete b.settings.session:b.settings&&delete b.settings[e],ce(n),!t.skipLocalStorage){const t=Q();if(t)try{t.removeItem(e)}catch{}}ie()}!function(){const e=Q();if(!e)return b={name:"",ductbanks:[],conduits:[],trays:[],cables:[],settings:{session:{},collapsedGroups:{},units:"imperial"}},void se(Object.keys(b.settings||{}));let t;try{t=e.getItem(o)}catch{t=null}if(t)try{return b=h(JSON.parse(t)),void se(Object.keys(b.settings||{}))}catch(e){console.warn("Failed to parse stored project",e)}const n=function(e){return{cables:ne(te(e,"cableSchedule"),[]),trays:ne(te(e,"traySchedule"),[]),conduits:ne(te(e,"conduitSchedule"),[]),ductbanks:ne(te(e,"ductbankSchedule"),[]),settings:{session:ne(te(e,"ctrSession"),{}),collapsedGroups:ne(te(e,"collapsedGroups"),{}),conduitFillData:ne(te(e,"conduitFillData"),null),trayFillData:ne(te(e,"trayFillData"),null),ductbankSession:ne(te(e,"ductbankSession"),{})}}}(e);b=h(n),se(Object.keys(b.settings||{})),ie({notify:!1})}(),function(){const e=ne(N(i),["base"]);_=J(e);const t=N(c),n=E("string"==typeof t?t:"");L=n||_[0]||"base",_.includes(L)||_.push(L),z()}();const de={PROJECT_KEY:o,defaultProject:p,migrateProject:h,initializeProjectStorage:async function(){await(S||(S=import(y).then(e=>(m=e.applyPatch,g=e.compare,e))),S);const e=Q();"undefined"!=typeof window&&window.addEventListener&&(window.addEventListener("beforeunload",()=>{A.length=0,w.length=0}),window.addEventListener("storage",t=>{if(t.key)if(t.key!==o){if(t.key===i){const e=ne(t.newValue,["base"]);return _=J(e),void(_.includes(L)||_.push(L))}if(t.key===c){const e=E(t.newValue||"");return L=e||_[0]||"base",void(_.includes(L)||_.push(L))}if(t.key===a&&(O=null,t.newValue)){const e=ne(t.newValue,null);e&&"object"==typeof e&&(O={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]})}}else{if(!t.newValue)return;try{b=h(JSON.parse(t.newValue)),se(Object.keys(b.settings||{})),e&&oe(e),re()}catch(e){console.warn("project sync failed",e)}}})),re()},getProjectState:function(){return ee()},setProjectState:function(e){const t=ee();b=h(e||{}),ce(t),ie()},setProjectKey:ae,removeProjectKey:ue,undoProjectChange:function(){if(!A.length||!m)return;const e=A.pop(),t=ee();try{const n=m(t,e,!0).newDocument;if(g)try{w.push(g(n,b))}catch{w.push([])}else w.push([]);b=h(n),ie()}catch(e){console.warn("undo failed",e)}},redoProjectChange:function(){if(!w.length||!m)return;const e=w.pop(),t=ee();try{const n=m(t,e,!0).newDocument;if(g)try{A.push(g(n,b))}catch{A.push([])}else A.push([]);b=h(n),ie()}catch(e){console.warn("redo failed",e)}},canUndo:function(){return A.length>0},canRedo:function(){return w.length>0},onProjectChange:function(e){return"function"!=typeof e?()=>{}:(j.add(e),()=>{j.delete(e)})},getScenarioListState:T,setScenarioListState:q,registerScenario:F,getCurrentScenarioNameState:G,setCurrentScenarioNameState:D,readScenarioValue:$,writeScenarioValue:V,removeScenarioValue:U,listScenarioKeysState:B,cloneScenarioStorage:M,listSavedProjects:function(){const e=new Set,t=new Set(K);for(const n of function(){const e=new Set,t=Q();if(t)try{for(let n=0;n<t.length;n++){const s=t.key(n);s&&e.add(s)}}catch(e){console.warn("project storage enumerate failed",e)}for(const t of k.keys())e.add(t);return[...e]}()){const s=n.indexOf(":");if(s<=0)continue;const r=n.slice(s+1);t.has(r)&&e.add(n.slice(0,s))}return[...e].sort((e,t)=>e.localeCompare(t,void 0,{sensitivity:"base"}))},writeSavedProject:Y,readSavedProject:W,removeSavedProject:function(e){const t="string"==typeof e?e.trim():"";if(!t)return;const n=`${t}:`;for(const e of x(n))C(n+e,null)},getSessionPreferences:H,setSessionPreferences:X,updateSessionPreferences:function(e){const t=H(),n="function"==typeof e?e(t):{...t,...e&&"object"==typeof e?e:{}};return X(n&&"object"==typeof n?n:{})},getConduitCache:function(){if(O)return JSON.parse(JSON.stringify(O));const e=ne(N(a),null);return e&&"object"==typeof e?(O={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]},JSON.parse(JSON.stringify(O))):(O=null,null)},setConduitCache:function(e){if(!e||"object"!=typeof e)return O=null,C(a,null),null;const t={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[]};O={ductbanks:JSON.parse(JSON.stringify(t.ductbanks)),conduits:JSON.parse(JSON.stringify(t.conduits))},C(a,JSON.stringify(O));try{ae("ductbankSchedule",JSON.stringify(t.ductbanks))}catch{}try{ae("conduitSchedule",JSON.stringify(t.conduits))}catch{}return JSON.parse(JSON.stringify(O))},clearConduitCache:function(){O=null,C(a,null)},getAuthContextState:function(){const e=N(u),t=N(d),n=N(l);if(!e||!t||!n)return null;const s=Number.parseInt(n,10);return Number.isFinite(s)?Date.now()>=s?(Z(),null):{token:e,csrfToken:t,expiresAt:s,user:N(f)||null}:(Z(),null)},setAuthContextState:function({token:e,csrfToken:t,expiresAt:n,user:s}){if(!e||!t)return;const r=Number(n);Number.isFinite(r)&&(C(u,e),C(d,t),C(l,String(r)),C(f,null==s?null:String(s)))},clearAuthContextState:Z};function le(){return[...T()]}function fe(){return G()}function ye(e){e&&(F(e),D(e),be("scenario",G()))}function pe(e,t=G()){e&&(M(t,e),F(e))}"undefined"!=typeof globalThis&&(globalThis.projectStorage=de),F(G());const he={trays:"traySchedule",cables:"cableSchedule",ductbanks:"ductbankSchedule",conduits:"conduitSchedule",panels:"panelSchedule",loads:"loadList",equipment:"equipment",oneLine:"oneLineDiagram",studies:"studyResults",traySchedule:"traySchedule",cableSchedule:"cableSchedule",ductbankSchedule:"ductbankSchedule",conduitSchedule:"conduitSchedule",panelSchedule:"panelSchedule",loadList:"loadList",equipmentList:"equipment",oneLineDiagram:"oneLineDiagram"},ge={equipmentColumns:"equipmentColumns",collapsedGroups:"collapsedGroups"},me={...he,...ge},Se={};function be(e,t){(Se[e]||[]).forEach(e=>{try{e(t)}catch(e){console.error(e)}})}const Ae=new Set([...Object.values(he),...Object.values(ge)]);function we(e,t,n=G()){return $(e,t,n)}function ve(e,t,n=G()){try{V(e,t,n),be(e,t)}catch(t){console.error("Failed to store",e,t)}}"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.addEventListener("storage",e=>{if(!e.key)return;const[t,n]=e.key.split(":");if(n&&t===G()&&Ae.has(n))try{be(n,e.newValue?JSON.parse(e.newValue):void 0)}catch{}});const je=()=>we(he.trays,[]),ke=e=>ve(he.trays,e),_e=()=>we(he.cables,[]),Le=e=>ve(he.cables,e),Oe=e=>{const t=_e();t.push(e),Le(t)},Ne=()=>we(he.ductbanks,[]),Ce=e=>ve(he.ductbanks,e),xe=()=>we(he.conduits,[]),Ee=e=>ve(he.conduits,e),Je=e=>{if(e)if(e.tray_id){const t=je();t.push(e),ke(t)}else{const t=xe();t.push(e),Ee(t)}},ze=()=>we(he.panels,[]);function Ie(e){return{id:"",description:"",ref:"",voltage:"",manufacturer:"",model:"",phases:"",notes:"",mainRating:"",circuitCount:42,...e}}const Pe=e=>ve(he.panels,e.map(Ie)),Re=()=>we(he.equipment,[]);function Te(e){return{id:"",ref:"",description:"",voltage:"",category:"",subCategory:"",x:"",y:"",z:"",manufacturer:"",model:"",phases:"",notes:"",...e}}const qe=e=>ve(he.equipment,e.map(Te)),Fe=e=>{const t=Re();t.push(Te(e)),qe(t)},Ge=(e,t)=>{const n=Re();e>=0&&e<n.length&&(n[e]=Te({...n[e],...t}),qe(n))},De=e=>{const t=Re();e>=0&&e<t.length&&(t.splice(e,1),qe(t))},$e=(e=G())=>{const t=we(he.oneLine,{},e);return Array.isArray(t)?{activeSheet:0,sheets:[{name:"Sheet 1",components:t,connections:[]}]}:t&&Array.isArray(t.sheets)?{activeSheet:t.activeSheet||0,sheets:t.sheets.map(e=>({name:e.name,components:Array.isArray(e.components)?e.components:[],connections:Array.isArray(e.connections)?e.connections:[]}))}:{activeSheet:0,sheets:[]}},Ve="oneLineRevisions",Ue=(e=G())=>we(Ve,[],e);const Be=(e,t=G())=>{const n=Ue(t)[e];return n&&ve(he.oneLine,{activeSheet:0,sheets:n.sheets},t),n?n.sheets:null},Me=(e,t=G())=>{const n=$e(t);Array.isArray(n.sheets)&&n.sheets.length&&function(e,t=G()){const n=Ue(t);n.push({time:Date.now(),sheets:JSON.parse(JSON.stringify(e))}),ve(Ve,n,t)}(n.sheets,t);const s={activeSheet:e.activeSheet||0,sheets:Array.isArray(e.sheets)?e.sheets:[]};ve(he.oneLine,s,t)},Ke=()=>we(he.studies,{}),Ye=e=>ve(he.studies,e),We=()=>{const e=we(he.loads,[]),t=e.map(He);return e.some(e=>e&&"object"==typeof e&&!("source"in e))&&ve(he.loads,t),t};function He(e){const t={...e};return"power"in t&&!("kw"in t)&&(t.kw=t.power,delete t.power),{id:"",ref:"",source:"",tag:"",description:"",quantity:"",voltage:"",loadType:"",duty:"",kw:"",powerFactor:"",loadFactor:"",efficiency:"",demandFactor:"",phases:"",circuit:"",manufacturer:"",model:"",notes:"",...t}}function Xe(e){const t=He(e);return Object.values(t).every(e=>""===e)}const Ze=e=>{const t=(e.length?e:[{}]).map(He);ve(he.loads,t)},Qe=e=>{const t=We(),n=He(e);1===t.length&&Xe(t[0])&&!Xe(n)?t[0]=n:t.push(n),Ze(t)},et=(e,t)=>{const n=We(),s=He(t),r=Math.max(0,Math.min(e,n.length));n.splice(r,0,s),Ze(n)},tt=(e,t)=>{const n=We();e>=0&&e<n.length&&(n[e]=He({...n[e],...t}),Ze(n))},nt=e=>{const t=We();e>=0&&e<t.length&&(t.splice(e,1),Ze(t))},st=(e,t=null,n)=>we(e,t,n),rt=(e,t,n)=>ve(e,t,n),ot=(e,t=G())=>{try{U(e,t),be(e,null)}catch(t){console.error("Failed to remove",e,t)}},it=(e=G())=>{try{return B(e)}catch{return[]}};function ct(e){e.innerHTML="";for(const t of le()){const n=document.createElement("option");n.value=t,n.textContent=t,e.appendChild(n)}e.value=fe()}"undefined"!=typeof window&&(window.dataStore={STORAGE_KEYS:me,getTrays:je,setTrays:ke,getCables:_e,setCables:Le,addCable:Oe,getDuctbanks:Ne,setDuctbanks:Ce,getConduits:xe,setConduits:Ee,addRaceway:Je,getPanels:ze,setPanels:Pe,getEquipment:Re,setEquipment:qe,addEquipment:Fe,updateEquipment:Ge,removeEquipment:De,getLoads:We,setLoads:Ze,addLoad:Qe,insertLoad:et,updateLoad:tt,removeLoad:nt,getOneLine:$e,setOneLine:Me,getRevisions:Ue,restoreRevision:Be,getStudies:Ke,setStudies:Ye,getItem:st,setItem:rt,removeItem:ot,listScenarios:le,getCurrentScenario:fe,switchScenario:ye,cloneScenario:pe,compareStudies:function(e,t){const n=we(he.studies,{},e),s=we(he.studies,{},t);return{[e]:n,[t]:s}},on:function(e,t){Se[e]||(Se[e]=[]),Se[e].push(t)},off:function(e,t){const n=Se[e];if(!n)return;const s=n.indexOf(t);s>=0&&n.splice(s,1)},keys:it,exportProject:function(){const e={ductbanks:Ne(),conduits:xe(),trays:je(),cables:_e(),panels:ze(),equipment:Re(),loads:We(),oneLine:$e(),settings:{}},t=new Set([...Object.values(he),"CTR_PROJECT_V1"]);for(const n of it())t.has(n)||(e.settings[n]=st(n));return{meta:{version:1,scenario:G(),scenarios:le()},...e}},importProject:function(e){const{meta:t,...n}=e||{};t&&Array.isArray(t.scenarios)&&q(t.scenarios),t&&t.scenario&&ye(t.scenario);let s=n;const{valid:r,missing:o,extra:i}=function(e){const t=["ductbanks","conduits","trays","cables","panels","equipment","loads","settings"],n=["oneLine"],s=[],r=[];if(!e||"object"!=typeof e)return s.push(...t),{valid:!1,missing:s,extra:r};for(const n of t)n in e||s.push(n);for(const s of Object.keys(e))t.includes(s)||n.includes(s)||r.push(s);const o=Array.isArray(e.ductbanks)&&Array.isArray(e.conduits)&&Array.isArray(e.trays)&&Array.isArray(e.cables)&&Array.isArray(e.panels)&&Array.isArray(e.equipment)&&Array.isArray(e.loads)&&e.settings&&"object"==typeof e.settings&&!Array.isArray(e.settings)&&(void 0===e.oneLine||Array.isArray(e.oneLine)||Array.isArray(e.oneLine?.sheets));return{valid:0===s.length&&0===r.length&&o,missing:s,extra:r}}(s);if(!r){const t=[];o.length&&t.push(`Missing fields: ${o.join(", ")}`),i.length&&t.push(`Extra fields: ${i.join(", ")}`);const n=t.join("\n")||"Invalid project data.";if("undefined"==typeof window||"function"!=typeof window.confirm||!window.confirm(`${n}\nRepair & continue?`))return!1;s={ductbanks:Array.isArray(e.ductbanks)?e.ductbanks:[],conduits:Array.isArray(e.conduits)?e.conduits:[],trays:Array.isArray(e.trays)?e.trays:[],cables:Array.isArray(e.cables)?e.cables:[],panels:Array.isArray(e.panels)?e.panels:[],equipment:Array.isArray(e.equipment)?e.equipment:[],loads:Array.isArray(e.loads)?e.loads:[],oneLine:Array.isArray(e.oneLine)?e.oneLine:[],settings:e.settings&&"object"==typeof e.settings?e.settings:{}}}Ce(s.ductbanks),Ee(s.conduits),ke(s.trays),Le(s.cables),Pe(Array.isArray(s.panels)?s.panels:[]),qe(Array.isArray(s.equipment)?s.equipment:[]),Ze(Array.isArray(s.loads)?s.loads:[]),Array.isArray(s.oneLine)?Me({activeSheet:0,sheets:s.oneLine}):s.oneLine&&Array.isArray(s.oneLine.sheets)?Me({activeSheet:s.oneLine.activeSheet||0,sheets:s.oneLine.sheets}):Me({activeSheet:0,sheets:[]});const c=new Set([...Object.values(he),"CTR_PROJECT_V1"]);for(const e of it())c.has(e)||s.settings&&e in s.settings||ot(e);if(s.settings)for(const[e,t]of Object.entries(s.settings))rt(e,t);return!0},saveProject:function(e,t=G()){if(e)try{Y(e,{equipment:Re(),panels:ze(),loads:We(),cables:_e(),raceways:{trays:je(),conduits:xe(),ductbanks:Ne()},oneLine:$e(t)})}catch(e){console.error("Failed to save project",e)}},loadProject:function(e,t=G()){if(e)try{const n=W(e)||{},s=n.equipment,r=n.panels,o=n.loads,i=n.cables,c=n.raceways||{},a=n.oneLine||{};Array.isArray(s)?qe(s):qe([]),Array.isArray(r)?Pe(r):Pe([]),Array.isArray(o)&&Ze(o),Array.isArray(i)?Le(i):Le([]),ke(Array.isArray(c.trays)?c.trays:[]),Ee(Array.isArray(c.conduits)?c.conduits:[]),Ce(Array.isArray(c.ductbanks)?c.ductbanks:[]),Array.isArray(a)?Me({activeSheet:0,sheets:a},t):Me(a||{activeSheet:0,sheets:[]},t)}catch(e){console.error("Failed to load project",e)}},importFromCad:async function(t){let n;if("string"==typeof t)n=t;else{if(!t||"function"!=typeof t.text)throw new Error("Unsupported CAD file");n=await t.text()}const{trays:s=[],conduits:r=[]}=e(n);return Array.isArray(s)&&s.length&&ke(s),Array.isArray(r)&&r.length&&Ee(r),{trays:s,conduits:r}},exportToCad:function(e="json"){const t={trays:je(),conduits:xe()};let n="application/json",s="json",r=JSON.stringify(t,null,2);if("csv"===e){const e="id,start_x,start_y,start_z,end_x,end_y,end_z,width,height",o=t.trays.map(e=>[e.id,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.width,e.height].join(",")),i="conduit_id,type,trade_size,start_x,start_y,start_z,end_x,end_y,end_z,capacity",c=t.conduits.map(e=>[e.conduit_id,e.type,e.trade_size,e.start_x,e.start_y,e.start_z,e.end_x,e.end_y,e.end_z,e.capacity].join(","));r=`# trays\n${[e,...o].join("\n")}\n# conduits\n${[i,...c].join("\n")}`,n="text/csv",s="csv"}if("undefined"!=typeof document)try{const e=new Blob([r],{type:n}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=`raceways.${s}`,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(t.href)}catch(e){console.error("Failed to export CAD data",e)}return r}}),document.addEventListener("DOMContentLoaded",function(){!function(){const e=["base","future","emergency"],t=le();for(const n of e)t.includes(n)||pe(n)}();const e=document.getElementById("scenario-select");if(!e)return;ct(e),e.addEventListener("change",e=>{ye(e.target.value),location.reload()});const t=document.getElementById("scenario-duplicate-btn");t?.addEventListener("click",()=>{const t=prompt("New scenario name");t&&(pe(t),ct(e),e.value=t,ye(t),location.reload())});const n=document.getElementById("scenario-diff-btn");n?.addEventListener("click",()=>{const e=prompt("Compare with which scenario?",le().join(", "));e&&function(e,t){const n=document.getElementById("diagram");if(!n)return;n.querySelectorAll(".scenario-diff").forEach(e=>e.classList.remove("scenario-diff"));const{sheets:s}=$e(e),{sheets:r}=$e(t),o=e=>{const t=new Map;for(const n of e)for(const e of n.components||[])t.set(e.id,JSON.stringify(e));return t},i=o(s),c=o(r),a=new Set;for(const[e,t]of i)c.get(e)!==t&&a.add(e);for(const e of c.keys())i.has(e)||a.add(e);a.forEach(e=>{const t=n.querySelector(`g.component[data-id="${e}"]`);t&&t.classList.add("scenario-diff")})}(fe(),e)});const s=document.getElementById("revision-btn");s?.addEventListener("click",()=>{const e=Ue();if(!e.length)return void alert("No revisions");const t=e.map((e,t)=>`${t}: ${new Date(e.time).toLocaleString()}`).join("\n"),n=prompt(`Restore which revision?\n${t}`),s=Number(n);Number.isNaN(s)||(Be(s),location.reload())})});
