<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ductbank Route</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:16px;}
body.dark-mode{background:#212529;color:#f8f9fa;}
label{display:inline-block;margin-bottom:4px;font-size:0.9rem;}
input,select{padding:2px 4px;font-size:0.9rem;margin-right:8px;}
body.dark-mode input,body.dark-mode select{background:#343a40;color:#f8f9fa;border:1px solid #495057;}
table{border-collapse:collapse;width:100%;margin-top:8px;}
table,th,td{border:1px solid #999;}
body.dark-mode table,body.dark-mode th,body.dark-mode td{border-color:#495057;}
th,td{padding:4px;text-align:center;font-size:0.85rem;}
th{background:#f0f0f0;}
body.dark-mode th{background:#343a40;color:#f8f9fa;}
body.dark-mode td{background:#2c3034;}
button{padding:4px 8px;margin:4px 2px;cursor:pointer;}
#grid{border:1px solid #aaa;margin-top:12px;}
.removeBtn{background:#e74c3c;color:#fff;border:none;}
.duplicateBtn{background:#95a5a6;color:#fff;border:none;}
#helpOverlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center;z-index:1000;}
#helpPopup{background:#fff;padding:12px;border-radius:8px;max-width:90%;max-height:90%;overflow:auto;position:relative;}
body.dark-mode #helpPopup{background:#2c3034;color:#f8f9fa;}
#helpClose{position:absolute;top:8px;right:8px;background:#e74c3c;color:#fff;border:none;padding:4px 8px;}
</style>
</head>
<body>
<h1>Ductbank Route</h1>
<button id="themeToggle">Toggle Theme</button>
<button id="helpBtn">Help</button>

<fieldset>
 <legend><strong>Ductbank Conduits</strong></legend>
 <input type="file" id="importConduits" accept=".csv"/>
 <button type="button" id="addConduit">Add Conduit</button>
 <button type="button" id="sampleConduits">Load Sample Data</button>
 <table id="conduitTable">
  <thead>
   <tr>
    <th>ID</th>
    <th>Type</th>
    <th>Trade Size</th>
    <th>X</th>
    <th>Y</th>
    <th>Z</th>
    <th>Angle</th>
    <th>Dup</th>
    <th>Del</th>
   </tr>
  </thead>
  <tbody></tbody>
 </table>
</fieldset>

<fieldset>
 <legend><strong>Cables</strong></legend>
 <input type="file" id="importCables" accept=".csv"/>
 <button type="button" id="addCable">Add Cable</button>
 <button type="button" id="sampleCables">Load Sample Data</button>
 <table id="cableTable">
  <thead>
   <tr>
    <th>Tag</th>
    <th>Type</th>
    <th>Diameter (in)</th>
    <th>Cond.</th>
    <th>Size</th>
    <th>Weight</th>
    <th>Start</th>
    <th>End</th>
    <th>Dup</th>
    <th>Del</th>
   </tr>
  </thead>
  <tbody></tbody>
 </table>
</fieldset>

<div style="margin-top:8px;">
  <label>Horiz Spacing (in)<input type="number" id="hSpacing" value="3" style="width:60px;"></label>
  <label>Vert Spacing (in)<input type="number" id="vSpacing" value="4" style="width:60px;"></label>
  <label>Top Clear (in)<input type="number" id="topPad" value="0" style="width:60px;"></label>
  <label>Bottom Clear (in)<input type="number" id="bottomPad" value="0" style="width:60px;"></label>
  <label>Conduits/Row<input type="number" id="perRow" value="4" style="width:60px;"></label>
</div>

<button id="calc">Calculate Fill</button>
<button id="exportBtn">Download Ductbank Data</button>

<svg id="grid" width="500" height="500"></svg>

<div id="helpOverlay">
 <div id="helpPopup">
  <button id="helpClose">Close</button>
  <h2>Ductbank Route Help</h2>
  <p>Use the <strong>Ductbank Conduits</strong> table to define each conduit by ID, type, trade size and its X/Y/Z position. Angle is optional rotation.</p>
  <p>The <strong>Cables</strong> table lists every cable to be pulled. Diameter is the outside diameter in inches. Specify which conduit each cable starts and ends in.</p>
  <p>Click <em>Add Conduit</em> or <em>Add Cable</em> to create rows manually, or use <em>Import&nbsp;CSV</em> to load your own files. <em>Load Sample Data</em> fills the tables with example values.</p>
  <p>After entering data, press <strong>Calculate Fill</strong> to draw the ductbank. Conduits are colored by fill percentage and display individual cable circles. Hover over a conduit to see its fill and cable tags.</p>
  <p>The <strong>Download Ductbank Data</strong> button exports all conduits, cables and fill results to an XLSX file.</p>
  <h3>NEC Fill Rules</h3>
  <p>NEC Chapter&nbsp;9 Table&nbsp;1 limits conduit fill to 53% with one cable, 31% with two cables and 40% with three or more cables. Table&nbsp;4 provides areas for each conduit type and size.</p>
 </div>
</div>

<script>
const SAMPLE_CONDUITS=[
 {conduit_id:"C1",conduit_type:"PVC Sch 40",trade_size:"4",x:0,y:0,z:0,angle:0},
 {conduit_id:"C2",conduit_type:"PVC Sch 40",trade_size:"4",x:2,y:0,z:0,angle:0},
 {conduit_id:"C3",conduit_type:"PVC Sch 40",trade_size:"4",x:4,y:0,z:0,angle:0},
 {conduit_id:"C4",conduit_type:"PVC Sch 40",trade_size:"4",x:6,y:0,z:0,angle:0},
 {conduit_id:"C5",conduit_type:"PVC Sch 40",trade_size:"4",x:0,y:2,z:0,angle:0},
 {conduit_id:"C6",conduit_type:"PVC Sch 40",trade_size:"4",x:2,y:2,z:0,angle:0},
 {conduit_id:"C7",conduit_type:"PVC Sch 40",trade_size:"4",x:4,y:2,z:0,angle:0},
 {conduit_id:"C8",conduit_type:"PVC Sch 40",trade_size:"4",x:6,y:2,z:0,angle:0},
 {conduit_id:"C9",conduit_type:"PVC Sch 40",trade_size:"4",x:0,y:4,z:0,angle:0},
 {conduit_id:"C10",conduit_type:"PVC Sch 40",trade_size:"4",x:2,y:4,z:0,angle:0},
 {conduit_id:"C11",conduit_type:"PVC Sch 40",trade_size:"4",x:4,y:4,z:0,angle:0},
 {conduit_id:"C12",conduit_type:"PVC Sch 40",trade_size:"4",x:6,y:4,z:0,angle:0},
 {conduit_id:"C13",conduit_type:"PVC Sch 40",trade_size:"4",x:0,y:6,z:0,angle:0},
 {conduit_id:"C14",conduit_type:"PVC Sch 40",trade_size:"4",x:2,y:6,z:0,angle:0},
 {conduit_id:"C15",conduit_type:"PVC Sch 40",trade_size:"4",x:4,y:6,z:0,angle:0},
 {conduit_id:"C16",conduit_type:"PVC Sch 40",trade_size:"4",x:6,y:6,z:0,angle:0},
];

const SAMPLE_CABLES=[
 {tag:'CBL1_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C1',end_conduit_id:'C1'},
 {tag:'CBL1_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C1',end_conduit_id:'C1'},
 {tag:'CBL2_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C2',end_conduit_id:'C2'},
 {tag:'CBL2_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C2',end_conduit_id:'C2'},
 {tag:'CBL2_3',cable_type:'Power',diameter:0.75,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C2',end_conduit_id:'C2'},
 {tag:'CBL3_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C3',end_conduit_id:'C3'},
 {tag:'CBL4_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C4',end_conduit_id:'C4'},
 {tag:'CBL4_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C4',end_conduit_id:'C4'},
 {tag:'CBL5_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C5',end_conduit_id:'C5'},
 {tag:'CBL5_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C5',end_conduit_id:'C5'},
 {tag:'CBL5_3',cable_type:'Power',diameter:0.75,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C5',end_conduit_id:'C5'},
 {tag:'CBL6_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C6',end_conduit_id:'C6'},
 {tag:'CBL7_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C7',end_conduit_id:'C7'},
 {tag:'CBL7_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C7',end_conduit_id:'C7'},
 {tag:'CBL8_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C8',end_conduit_id:'C8'},
 {tag:'CBL8_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C8',end_conduit_id:'C8'},
 {tag:'CBL8_3',cable_type:'Power',diameter:0.75,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C8',end_conduit_id:'C8'},
 {tag:'CBL9_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C9',end_conduit_id:'C9'},
 {tag:'CBL10_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C10',end_conduit_id:'C10'},
 {tag:'CBL10_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C10',end_conduit_id:'C10'},
 {tag:'CBL11_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C11',end_conduit_id:'C11'},
 {tag:'CBL11_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C11',end_conduit_id:'C11'},
 {tag:'CBL11_3',cable_type:'Power',diameter:0.75,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C11',end_conduit_id:'C11'},
 {tag:'CBL12_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C12',end_conduit_id:'C12'},
 {tag:'CBL13_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C13',end_conduit_id:'C13'},
 {tag:'CBL13_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C13',end_conduit_id:'C13'},
 {tag:'CBL14_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C14',end_conduit_id:'C14'},
 {tag:'CBL14_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C14',end_conduit_id:'C14'},
 {tag:'CBL14_3',cable_type:'Power',diameter:0.75,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C14',end_conduit_id:'C14'},
 {tag:'CBL15_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C15',end_conduit_id:'C15'},
 {tag:'CBL16_1',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C16',end_conduit_id:'C16'},
 {tag:'CBL16_2',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#2 AWG',weight:5,start_conduit_id:'C16',end_conduit_id:'C16'},
];

const CONDUIT_SPECS={
 "EMT":{"1/2":0.304,"3/4":0.533,"1":0.864,"1-1/4":1.496,"1-1/2":2.036,"2":3.356,"2-1/2":5.858,"3":8.846,"3-1/2":11.545,"4":14.753},
 "RMC":{"1/2":0.314,"3/4":0.549,"1":0.887,"1-1/4":1.526,"1-1/2":2.071,"2":3.408,"2-1/2":4.866,"3":7.499,"3-1/2":10.01,"4":12.882,"5":20.212,"6":29.158},
 "PVC Sch 40":{"1/2":0.285,"3/4":0.508,"1":0.832,"1-1/4":1.453,"1-1/2":1.986,"2":3.291,"2-1/2":4.695,"3":7.268,"3-1/2":9.737,"4":12.554,"5":19.761,"6":28.567}
};

function parseSize(sz){
 if(sz.includes('-')){const[w,f]=sz.split('-');const[n,d]=f.split('/');return parseFloat(w)+parseFloat(n)/parseFloat(d);} 
 if(sz.includes('/')){const[n,d]=sz.split('/');return parseFloat(n)/parseFloat(d);} 
 return parseFloat(sz);
}

function conduitSizeOptions(type){
 const sel=document.createElement('select');
 Object.keys(CONDUIT_SPECS[type]||{}).sort((a,b)=>parseSize(a)-parseSize(b)).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o);});
 return sel;
}

function createButton(text,cls,handler){
 const b=document.createElement('button');b.type='button';b.textContent=text;b.className=cls;b.addEventListener('click',handler);return b;
}

function packCircles(cables,R){
 const placed=[];
 cables.sort((a,b)=>b.r-a.r);
 function yAtBoundary(x,r){return Math.sqrt(Math.max(0,(R-r)*(R-r)-x*x));}
 for(const c of cables){
  let best=null;let bestY=-Infinity;const maxX=R-c.r;const step=Math.max(0.05,c.r/4);
  for(let x=-maxX;x<=maxX;x+=step){
   let y=yAtBoundary(x,c.r);
   for(const p of placed){
     const dx=x-p.x;if(Math.abs(dx)<p.r+c.r){const dy=Math.sqrt((p.r+c.r)*(p.r+c.r)-dx*dx);y=Math.min(y,p.y-dy);}
   }
   if(y>bestY){bestY=y;best={x,y};}
  }
  if(best){
   let y=yAtBoundary(best.x,c.r);
   for(const p of placed){
     const dx=best.x-p.x;if(Math.abs(dx)<p.r+c.r){const dy=Math.sqrt((p.r+c.r)*(p.r+c.r)-dx*dx);y=Math.min(y,p.y-dy);}
   }
   placed.push({x:best.x,y,r:c.r,tag:c.tag});
  }else{
   placed.push({x:0,y:0,r:c.r,tag:c.tag});
  }
 }
 return placed;
}

function addConduitRow(data={}){
 const tr=document.createElement('tr');
 const idTd=document.createElement('td');const idInput=document.createElement('input');idInput.value=data.conduit_id||'';idTd.appendChild(idInput);tr.appendChild(idTd);
 const typeTd=document.createElement('td');const typeSel=document.createElement('select');Object.keys(CONDUIT_SPECS).forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;typeSel.appendChild(o);});typeSel.value=data.conduit_type||Object.keys(CONDUIT_SPECS)[0];typeTd.appendChild(typeSel);tr.appendChild(typeTd);
 const sizeTd=document.createElement('td');let sizeSel=conduitSizeOptions(typeSel.value);sizeTd.appendChild(sizeSel);sizeSel.value=data.trade_size||sizeSel.options[0].value;tr.appendChild(sizeTd);
 typeSel.addEventListener('change',()=>{const old=sizeSel;sizeSel=conduitSizeOptions(typeSel.value);sizeTd.replaceChild(sizeSel,old);});
 ['x','y','z','angle'].forEach(k=>{const td=document.createElement('td');const inp=document.createElement('input');inp.type='number';inp.value=data[k]||0;if(k==='x'||k==='y')inp.readOnly=true;td.appendChild(inp);tr.appendChild(td);});
 const dupTd=document.createElement('td');dupTd.appendChild(createButton('⧉','duplicateBtn',()=>{const cloneData=rowToConduit(tr);addConduitRow(cloneData);}));tr.appendChild(dupTd);
 const delTd=document.createElement('td');delTd.appendChild(createButton('✖','removeBtn',()=>{tr.remove();drawGrid();}));tr.appendChild(delTd);
 document.querySelector('#conduitTable tbody').appendChild(tr);
 autoPlaceConduits();
}

function addCableRow(data={}){
 const tr=document.createElement('tr');
 const cols=['tag','cable_type','diameter','conductors','conductor_size','weight','start_conduit_id','end_conduit_id'];
 cols.forEach((c,i)=>{const td=document.createElement('td');const inp=document.createElement('input');inp.type=(c==='diameter'||c==='weight')?'number':'text';if(c==='conductors')inp.type='number';inp.value=data[c]||'';td.appendChild(inp);tr.appendChild(td);});
 const dupTd=document.createElement('td');dupTd.appendChild(createButton('⧉','duplicateBtn',()=>{const clone=rowToCable(tr);addCableRow(clone);}));tr.appendChild(dupTd);
 const delTd=document.createElement('td');delTd.appendChild(createButton('✖','removeBtn',()=>{tr.remove();drawGrid();}));tr.appendChild(delTd);
 document.querySelector('#cableTable tbody').appendChild(tr);
}

function rowToConduit(tr){
 const [id,type,size,x,y,z,angle]=Array.from(tr.children).slice(0,7).map(td=>td.querySelector('input,select').value);
 return {conduit_id:id,conduit_type:type,trade_size:size,x:parseFloat(x),y:parseFloat(y),z:parseFloat(z),angle:parseFloat(angle)};
}

function rowToCable(tr){
 const vals=Array.from(tr.children).slice(0,8).map(td=>td.querySelector('input').value);
 const [tag,cable_type,diameter,conductors,conductor_size,weight,start_conduit_id,end_conduit_id]=vals;
 return {tag,cable_type,diameter:parseFloat(diameter),conductors:parseInt(conductors||0),conductor_size,weight:parseFloat(weight)||0,start_conduit_id,end_conduit_id};
}

function getAllConduits(){
 return Array.from(document.querySelectorAll('#conduitTable tbody tr')).map(rowToConduit);
}

function getAllCables(){
 return Array.from(document.querySelectorAll('#cableTable tbody tr')).map(rowToCable);
}

function autoPlaceConduits(){
 const rows=document.querySelectorAll('#conduitTable tbody tr');
 const h=parseFloat(document.getElementById('hSpacing').value)||3;
 const v=parseFloat(document.getElementById('vSpacing').value)||4;
 const bottomPad=parseFloat(document.getElementById('bottomPad').value)||0;
 const perRow=parseInt(document.getElementById('perRow').value)||Math.ceil(Math.sqrt(rows.length));

 const numRows=Math.ceil(rows.length/perRow);
 const rowMaxR=new Array(numRows).fill(0);
 for(let r=0;r<numRows;r++){
   for(let c=0;c<perRow;c++){
     const idx=r*perRow+c;
     if(idx>=rows.length)break;
     const tr=rows[idx];
     const type=tr.children[1].querySelector('select').value;
     const size=tr.children[2].querySelector('select').value;
     const Rin=Math.sqrt(CONDUIT_SPECS[type][size]/Math.PI);
     rowMaxR[r]=Math.max(rowMaxR[r],Rin);
   }
 }

 let yCursor=bottomPad;
 for(let r=0;r<numRows;r++){
   let xCursor=0;
   for(let c=0;c<perRow;c++){
     const idx=r*perRow+c;
     if(idx>=rows.length)break;
     const tr=rows[idx];
     const type=tr.children[1].querySelector('select').value;
     const size=tr.children[2].querySelector('select').value;
     const Rin=Math.sqrt(CONDUIT_SPECS[type][size]/Math.PI);
     const cells=tr.querySelectorAll('td');
     const x=cells[3].querySelector('input');
     const y=cells[4].querySelector('input');
     x.value=xCursor;
     y.value=yCursor+(rowMaxR[r]-Rin);
     xCursor+=2*Rin+h;
   }
   yCursor+=2*rowMaxR[r];
   if(r<numRows-1) yCursor+=v;
 }
}

function fillResults(){
 const conduits=getAllConduits();
 const cables=getAllCables();
 const fillMap={};
 conduits.forEach(c=>{fillMap[c.conduit_id]={area:CONDUIT_SPECS[c.conduit_type][c.trade_size],cables:[]};});
 cables.forEach(cb=>{const cid=cb.start_conduit_id;if(fillMap[cid])fillMap[cid].cables.push(cb);});
 Object.values(fillMap).forEach(c=>{c.fillArea=c.cables.reduce((s,cb)=>s+Math.PI*Math.pow(cb.diameter/2,2),0);c.fillPct=(c.fillArea/c.area)*100;});
 return fillMap;
}

function drawGrid(){
 const svg=document.getElementById('grid');
 svg.innerHTML='';
 autoPlaceConduits();
 const conduits=getAllConduits();
 if(conduits.length===0)return;
 const topPad=parseFloat(document.getElementById('topPad').value)||0;
 const bottomPad=parseFloat(document.getElementById('bottomPad').value)||0;
 const scale=40; // pixels per unit
 const fillMap=fillResults();
 let maxX=0,maxY=0;
 conduits.forEach(c=>{
   const Rin=Math.sqrt(CONDUIT_SPECS[c.conduit_type][c.trade_size]/Math.PI);
   maxX=Math.max(maxX,c.x+2*Rin);
   maxY=Math.max(maxY,c.y+2*Rin);
 });
 maxY+=topPad;

 const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
 svg.appendChild(defs);

 const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
 rect.setAttribute('x',10);
 rect.setAttribute('y',10);
 rect.setAttribute('width',maxX*scale);
 rect.setAttribute('height',maxY*scale);
 rect.setAttribute('fill','none');
 rect.setAttribute('stroke','gray');
 rect.setAttribute('stroke-dasharray','4 2');
 svg.appendChild(rect);

 conduits.forEach(c=>{
   const Rin=Math.sqrt(CONDUIT_SPECS[c.conduit_type][c.trade_size]/Math.PI);
   const R=Rin*scale;
   const cx=c.x*scale+R+10;
   const cy=c.y*scale+R+10;
   const data=fillMap[c.conduit_id];
   let color='green';
   if(data){
     const count=data.cables.length;
     const limit=count===1?53:count===2?31:40;
     if(data.fillPct>limit)color='red';else if(data.fillPct>0.8*limit)color='yellow';
   }
   const clip=document.createElementNS('http://www.w3.org/2000/svg','clipPath');
   const clipId=`clip-${c.conduit_id}`;
   clip.setAttribute('id',clipId);
   const clipCircle=document.createElementNS('http://www.w3.org/2000/svg','circle');
   clipCircle.setAttribute('cx',cx);clipCircle.setAttribute('cy',cy);clipCircle.setAttribute('r',R);
   clip.appendChild(clipCircle);
   defs.appendChild(clip);
   if(data){
     const placed=packCircles(data.cables.map(cb=>({tag:cb.tag,r:cb.diameter/2})),Rin);
    placed.forEach(p=>{
       const sc=document.createElementNS('http://www.w3.org/2000/svg','circle');
       sc.setAttribute('cx',cx+p.x*scale);
       sc.setAttribute('cy',cy+p.y*scale);
       sc.setAttribute('r',p.r*scale);
       sc.setAttribute('fill','lightblue');
       sc.setAttribute('stroke','black');
       sc.setAttribute('clip-path',`url(#${clipId})`);
       svg.appendChild(sc);
       if(p.tag){
         const fs=Math.max(6,Math.min(p.r*scale,(2*p.r*scale*0.8)/(p.tag.length*0.6)));
         const text=document.createElementNS('http://www.w3.org/2000/svg','text');
         text.setAttribute('x',cx+p.x*scale);
         text.setAttribute('y',cy+p.y*scale);
         text.setAttribute('font-size',fs);
         text.setAttribute('text-anchor','middle');
         text.setAttribute('dominant-baseline','middle');
         text.setAttribute('clip-path',`url(#${clipId})`);
         text.textContent=p.tag;
         svg.appendChild(text);
         const text2=document.createElementNS('http://www.w3.org/2000/svg','text');
         text2.setAttribute('x',cx+p.x*scale);
         text2.setAttribute('y',cy+p.y*scale+fs*0.8);
         text2.setAttribute('font-size',Math.max(6,fs*0.7));
         text2.setAttribute('text-anchor','middle');
         text2.setAttribute('dominant-baseline','hanging');
         text2.setAttribute('clip-path',`url(#${clipId})`);
         text2.textContent=(2*p.r).toFixed(2)+'"';
         svg.appendChild(text2);
       }
     });
   }
   const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
   circle.setAttribute('cx',cx);circle.setAttribute('cy',cy);circle.setAttribute('r',R);
   circle.setAttribute('fill',color);
   circle.setAttribute('fill-opacity','0.4');
   circle.setAttribute('stroke','black');
   if(data){
     const names=data.cables.map(c=>c.tag).join(', ');
     circle.setAttribute('title',`${c.conduit_id}: ${data.fillPct.toFixed(1)}% - ${names}`);
   }
   svg.appendChild(circle);
  });
 svg.setAttribute('width',maxX*scale+20);
 svg.setAttribute('height',maxY*scale+20);
}

function importCSV(file,callback){
 const reader=new FileReader();
 reader.onload=e=>{const rows=e.target.result.trim().split(/\r?\n/).map(r=>r.split(','));const headers=rows.shift();const objs=rows.map(r=>{const o={};headers.forEach((h,i)=>o[h.trim()]=r[i]);return o;});callback(objs);};
 reader.readAsText(file);
}

document.getElementById('addConduit').addEventListener('click',()=>{addConduitRow();});
document.getElementById('addCable').addEventListener('click',()=>{addCableRow();});
document.getElementById('sampleConduits').addEventListener('click',()=>{
 document.querySelector('#conduitTable tbody').innerHTML='';
 SAMPLE_CONDUITS.forEach(addConduitRow);
 drawGrid();
});
document.getElementById('sampleCables').addEventListener('click',()=>{
 document.querySelector('#cableTable tbody').innerHTML='';
 SAMPLE_CABLES.forEach(addCableRow);
 drawGrid();
});

document.getElementById('importConduits').addEventListener('change',e=>{const f=e.target.files[0];if(f)importCSV(f,data=>{document.querySelector('#conduitTable tbody').innerHTML='';data.forEach(addConduitRow);drawGrid();});});
document.getElementById('importCables').addEventListener('change',e=>{const f=e.target.files[0];if(f)importCSV(f,data=>{document.querySelector('#cableTable tbody').innerHTML='';data.forEach(addCableRow);drawGrid();});});

document.getElementById('calc').addEventListener('click',drawGrid);

document.getElementById('exportBtn').addEventListener('click',()=>{
 const wb=XLSX.utils.book_new();
 const conduits=getAllConduits();
 const cables=getAllCables();
 const fill=fillResults();
 XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(conduits),'conduits');
 XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(cables),'cables');
 const compliance=Object.keys(fill).map(k=>{const f=fill[k];return{conduit_id:k,fill_pct:f.fillPct.toFixed(2),cable_count:f.cables.length};});
 XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(compliance),'fill');
 XLSX.writeFile(wb,'ductbank_data.xlsx');
});

document.getElementById('themeToggle').addEventListener('click',()=>{
 document.body.classList.toggle('dark-mode');
 const session=JSON.parse(localStorage.getItem('ctrSession')||'{}');
 session.darkMode=document.body.classList.contains('dark-mode');
 localStorage.setItem('ctrSession',JSON.stringify(session));
});
const stored=JSON.parse(localStorage.getItem('ctrSession')||'{}');
if(stored.darkMode)document.body.classList.add('dark-mode');

window.addEventListener('storage',e=>{if(e.key==='ctrSession'){const d=JSON.parse(e.newValue);if(d.darkMode)document.body.classList.add('dark-mode');else document.body.classList.remove('dark-mode');}});

document.getElementById('helpBtn').addEventListener('click',()=>{document.getElementById('helpOverlay').style.display='flex';});
document.getElementById('helpClose').addEventListener('click',()=>{document.getElementById('helpOverlay').style.display='none';});
</script>
</body>
</html>
