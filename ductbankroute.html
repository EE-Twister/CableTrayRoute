<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ductbank Route</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/gpu.js@2.10.4/dist/gpu-browser.min.js"></script>
<style>
body{font-family:Arial,sans-serif;margin:16px;}
label{display:inline-block;margin-bottom:4px;font-size:0.9rem;}
input,select{padding:2px 4px;font-size:0.9rem;margin-right:8px;}
body.dark-mode input,body.dark-mode select{background:#343a40;color:#f8f9fa;border:1px solid #495057;}
button{padding:4px 8px;margin:4px 2px;cursor:pointer;}
</style>
</head>
<body>
<header class="page-header">
 <h1>Ductbank Route</h1>
 <button id="settings-btn" class="settings-btn" aria-label="Settings">⚙</button>
 <div id="settings-menu" class="settings-menu">
  <button id="themeToggle">Toggle Theme</button>
  <button id="helpBtn">Help</button>
  <button id="deleteDataBtn">Delete Saved Data</button>
 </div>
</header>
<fieldset>
 <legend><strong>Ductbank Information</strong></legend>
 <label>Ductbank Tag<input type="text" id="ductbankTag" style="margin-left:4px;"></label>
 <label style="margin-left:8px;">Concrete Encasement<input type="checkbox" id="concreteEncasement" style="margin-left:4px;"></label>
 <label style="margin-left:8px;">Ductbank Depth (in)<input type="number" id="ductbankDepth" style="width:60px;"></label>
</fieldset>

<details open>
 <summary><strong>Ductbank Conduits</strong></summary>
 <input type="file" id="importConduits" accept=".csv"/>
 <button type="button" id="addConduit">Add Conduit</button>
 <button type="button" id="sampleConduits">Load Sample Data</button>
 <input type="text" id="conduit-search" class="table-search" placeholder="Filter conduits">
 <table id="conduitTable" class="db-table">
  <thead>
   <tr>
    <th>ID</th>
    <th>Type</th>
    <th>Trade Size</th>
    <th>X</th>
    <th>Y</th>
    <th>Dup</th>
    <th>Del</th>
   </tr>
  </thead>
  <tbody></tbody>
 </table>
 </details>






<details open>
 <summary><strong>Cables</strong></summary>
 <input type="file" id="importCables" accept=".csv"/>
 <button type="button" id="addCable">Add Cable</button>
 <button type="button" id="sampleCables">Load Sample Data</button>
 <input type="text" id="cable-search" class="table-search" placeholder="Filter cables">
 <table id="cableTable" class="db-table">
  <thead>
   <tr>
    <th>Tag</th>
    <th>Type</th>
    <th>Diameter (in)</th>
    <th>Cond.</th>
    <th>Size</th>
    <th>Weight</th>
    <th>Est. Load (A)</th>
    <th>Conduit</th>
    <th>Conductor Material</th>
    <th>Insulation Type</th>
    <th>Voltage Rating</th>
    <th>Shielding / Jacket Type</th>
    <th>Dup</th>
    <th>Del</th>
   </tr>
  </thead>
  <tbody></tbody>
 </table>
 <datalist id="sizeList">
  <option value="#22 AWG"></option>
  <option value="#20 AWG"></option>
  <option value="#18 AWG"></option>
  <option value="#16 AWG"></option>
  <option value="#14 AWG"></option>
  <option value="#12 AWG"></option>
  <option value="#10 AWG"></option>
  <option value="#8 AWG"></option>
  <option value="#6 AWG"></option>
  <option value="#4 AWG"></option>
  <option value="#2 AWG"></option>
  <option value="#1 AWG"></option>
  <option value="1/0 AWG"></option>
  <option value="2/0 AWG"></option>
  <option value="3/0 AWG"></option>
  <option value="4/0 AWG"></option>
  <option value="250 kcmil"></option>
  <option value="350 kcmil"></option>
  <option value="500 kcmil"></option>
  <option value="750 kcmil"></option>
  <option value="1000 kcmil"></option>
 </datalist>
</details>
<fieldset style="margin-top:8px;">
 <legend><strong>Thermal &amp; Environmental Parameters</strong></legend>
 <label>Ambient Earth Temperature (&#176;F)<input type="number" id="earthTemp" style="width:60px;"></label>
 <label style="margin-left:8px;">Ambient Air Temperature (&#176;F)<input type="number" id="airTemp" style="width:60px;"></label>
 <label style="margin-left:8px;">Thermal Resistivity of Soil (&#176;C&#183;cm/W)<input type="number" id="soilResistivity" style="width:60px;"></label>
 <label style="margin-left:8px;">Moisture Content (%)<input type="number" id="moistureContent" min="0" max="100" style="width:60px;"></label>
 <label style="margin-left:8px;">Presence of Adjacent Heat Sources<input type="checkbox" id="heatSources" style="margin-left:4px;"></label>
</fieldset>

<div style="margin-top:8px;">
  <label>Horiz Spacing (in)<input type="number" id="hSpacing" value="3" style="width:60px;"></label>
  <label>Vert Spacing (in)<input type="number" id="vSpacing" value="4" style="width:60px;"></label>
  <label>Top Clear (in)<input type="number" id="topPad" value="0" style="width:60px;"></label>
  <label>Bottom Clear (in)<input type="number" id="bottomPad" value="0" style="width:60px;"></label>
  <label>Left Clear (in)<input type="number" id="leftPad" value="0" style="width:60px;"></label>
  <label>Right Clear (in)<input type="number" id="rightPad" value="0" style="width:60px;"></label>
  <label>Conduits/Row<input type="number" id="perRow" value="4" style="width:60px;"></label>
</div>

<div id="gridContainer" style="position:relative;display:inline-block;">
 <svg id="grid" width="500" height="500"></svg>
 <canvas id="tempCanvas" width="500" height="500" style="position:absolute;top:0;left:0;pointer-events:none;z-index:10;"></canvas>
</div>

<div id="ampacityReport" style="margin-top:8px;"></div>

<div class="db-button-panel">
 <button id="calc">Calculate Fill</button>
 <button id="thermalBtn">Thermal Analysis</button>
 <button id="heatToggleBtn">Toggle Heat Map</button>
 <button id="exportBtn">Download Ductbank Data</button>
 <button id="exportConduitsBtn">Export Ductbank Conduits</button>
 <button id="exportCablesBtn">Export Ductbank Cables</button>
 <button id="exportImgBtn">Export Image</button>
</div>

<div id="helpOverlay">
 <div id="helpPopup">
  <button id="helpClose">Close</button>
  <h2>Ductbank Route Help</h2>
  <p>Use the <strong>Ductbank Conduits</strong> table to define each conduit by ID, type, trade size and its X/Y position.</p>
  <p>The <strong>Cables</strong> table lists every cable to be pulled. Diameter is the outside diameter in inches. Specify which conduit each cable is installed in.</p>
  <p>Click <em>Add Conduit</em> or <em>Add Cable</em> to create rows manually, or use <em>Import&nbsp;CSV</em> to load your own files. <em>Load Sample Data</em> fills the tables with example values.</p>
  <p>After entering data, press <strong>Calculate Fill</strong> to draw the ductbank. Conduits are colored by fill percentage and display individual cable circles. Hover over a conduit to see its fill and cable tags.</p>
  <p>The <strong>Download Ductbank Data</strong> button exports all conduits, cables and fill results to an XLSX file.</p>
  <p><strong>Export Ductbank Conduits</strong> and <strong>Export Ductbank Cables</strong> create CSV files compatible with the import buttons.</p>
  <h3>NEC Fill Rules</h3>
  <p>NEC Chapter&nbsp;9 Table&nbsp;1 limits conduit fill to 53% with one cable, 31% with two cables and 40% with three or more cables. Table&nbsp;4 provides areas for each conduit type and size.</p>
  <h3>Ampacity Calculation</h3>
  <p>Ampacity is estimated using a simplified Neher-McGrath method:</p>
  <pre>I = sqrt(&Delta;T / (R<sub>dc</sub> &times; R<sub>th</sub>))</pre>
  <p>Where &Delta;T = 90&nbsp;&minus; max(T<sub>earth</sub>,T<sub>air</sub>) and R<sub>th</sub> is computed as:</p>
  <pre>R<sub>th</sub> = (&#x3c1;/90) &times; 0.5 &times; N &times; (1 + D/100)
       &times; moistureAdj
       &times; adjCableFactor
       &times; (heatSources ? 1.2 : 1)
       &times; (encased ? 0.8 : 1)
       &times; insulationAdj &times; voltageAdj &times; jacketAdj
       &times; spacingAdj</pre>
  <p>&#x3c1; is the soil resistivity, N is the cables in the conduit, D is ductbank depth (in), <em>moistureAdj</em> reduces resistance for wetter soil, <em>adjCableFactor</em> accounts for heat from neighboring conduits, and <em>spacingAdj</em>=3/spacing. <em>insulationAdj</em>, <em>voltageAdj</em> and <em>jacketAdj</em> adjust for cable construction. The DC resistance R<sub>dc</sub> depends on conductor material and size.</p>
  <h3>Thermal Analysis</h3>
  <p>The <em>Thermal Analysis</em> button overlays a heat map on the drawing. Each conduit center is marked with a yellow dot labeled with the estimated earth temperature in Fahrenheit and the hottest point is highlighted in red.</p>
  <p>Inputs are validated before running the analysis. Ductbank depth is limited to 0–120&nbsp;in, spacing between 1–24&nbsp;in and cable estimated load up to 2000&nbsp;A. Values outside these ranges will be clamped.</p>
</div>
</div>

<script>
let heatVisible=true;
const SAMPLE_CONDUITS=[
 {conduit_id:"C1",conduit_type:"PVC Sch 40",trade_size:"4",x:0,y:0},
 {conduit_id:"C2",conduit_type:"PVC Sch 40",trade_size:"4",x:2,y:0},
 {conduit_id:"C3",conduit_type:"PVC Sch 40",trade_size:"4",x:4,y:0},
 {conduit_id:"C4",conduit_type:"PVC Sch 40",trade_size:"4",x:6,y:0},
 {conduit_id:"C5",conduit_type:"PVC Sch 40",trade_size:"4",x:0,y:2},
 {conduit_id:"C6",conduit_type:"PVC Sch 40",trade_size:"4",x:2,y:2},
 {conduit_id:"C7",conduit_type:"PVC Sch 40",trade_size:"4",x:4,y:2},
 {conduit_id:"C8",conduit_type:"PVC Sch 40",trade_size:"4",x:6,y:2},
 {conduit_id:"C9",conduit_type:"PVC Sch 40",trade_size:"4",x:0,y:4},
 {conduit_id:"C10",conduit_type:"PVC Sch 40",trade_size:"4",x:2,y:4},
 {conduit_id:"C11",conduit_type:"PVC Sch 40",trade_size:"4",x:4,y:4},
 {conduit_id:"C12",conduit_type:"PVC Sch 40",trade_size:"4",x:6,y:4},
 {conduit_id:"C13",conduit_type:"PVC Sch 40",trade_size:"4",x:0,y:6},
 {conduit_id:"C14",conduit_type:"PVC Sch 40",trade_size:"4",x:2,y:6},
 {conduit_id:"C15",conduit_type:"PVC Sch 40",trade_size:"4",x:4,y:6},
 {conduit_id:"C16",conduit_type:"PVC Sch 40",trade_size:"4",x:6,y:6},
];

const SAMPLE_CABLES=[
 {tag:'CBL01',cable_type:'Power',diameter:1.8,conductors:3,conductor_size:'#500 kcmil',weight:6.0,conduit_id:'C1'},
 {tag:'CBL02',cable_type:'Control',diameter:0.5,conductors:4,conductor_size:'#14 AWG',weight:0.8,conduit_id:'C1'},
 {tag:'CBL03',cable_type:'Signal',diameter:0.4,conductors:1,conductor_size:'#18 AWG',weight:0.5,conduit_id:'C2'},
 {tag:'CBL04',cable_type:'Power',diameter:1.2,conductors:3,conductor_size:'#2 AWG',weight:3.0,conduit_id:'C2'},
 {tag:'CBL05',cable_type:'Power',diameter:1.5,conductors:3,conductor_size:'#4/0 AWG',weight:5.0,conduit_id:'C3'},
 {tag:'CBL06',cable_type:'Control',diameter:0.6,conductors:8,conductor_size:'#12 AWG',weight:1.2,conduit_id:'C3'},
 {tag:'CBL07',cable_type:'Signal',diameter:0.4,conductors:2,conductor_size:'#16 AWG',weight:0.6,conduit_id:'C4'},
 {tag:'CBL08',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#1/0 AWG',weight:3.2,conduit_id:'C4'},
 {tag:'CBL09',cable_type:'Control',diameter:0.7,conductors:4,conductor_size:'#10 AWG',weight:1.5,conduit_id:'C5'},
 {tag:'CBL10',cable_type:'Signal',diameter:0.3,conductors:1,conductor_size:'#22 AWG',weight:0.2,conduit_id:'C5'},
 {tag:'CBL11',cable_type:'Power',diameter:1.4,conductors:3,conductor_size:'#1/0 AWG',weight:4.2,conduit_id:'C5'},
 {tag:'CBL12',cable_type:'Power',diameter:1.1,conductors:3,conductor_size:'#2 AWG',weight:3.5,conduit_id:'C6'},
 {tag:'CBL13',cable_type:'Control',diameter:0.5,conductors:6,conductor_size:'#14 AWG',weight:1.0,conduit_id:'C6'},
 {tag:'CBL14',cable_type:'Signal',diameter:0.35,conductors:2,conductor_size:'#18 AWG',weight:0.3,conduit_id:'C7'},
 {tag:'CBL15',cable_type:'Power',diameter:0.9,conductors:3,conductor_size:'#4 AWG',weight:2.8,conduit_id:'C7'},
 {tag:'CBL16',cable_type:'Signal',diameter:0.6,conductors:2,conductor_size:'#16 AWG',weight:0.7,conduit_id:'C8'},
 {tag:'CBL17',cable_type:'Control',diameter:0.8,conductors:8,conductor_size:'#12 AWG',weight:1.8,conduit_id:'C8'},
 {tag:'CBL18',cable_type:'Power',diameter:1.3,conductors:3,conductor_size:'#1/0 AWG',weight:4.8,conduit_id:'C9'},
 {tag:'CBL19',cable_type:'Signal',diameter:0.4,conductors:1,conductor_size:'#20 AWG',weight:0.3,conduit_id:'C9'},
 {tag:'CBL20',cable_type:'Control',diameter:0.6,conductors:8,conductor_size:'#16 AWG',weight:1.2,conduit_id:'C10'},
 {tag:'CBL21',cable_type:'Power',diameter:1.2,conductors:3,conductor_size:'#2 AWG',weight:3.6,conduit_id:'C10'},
 {tag:'CBL22',cable_type:'Control',diameter:0.5,conductors:4,conductor_size:'#14 AWG',weight:0.9,conduit_id:'C11'},
 {tag:'CBL23',cable_type:'Signal',diameter:0.3,conductors:1,conductor_size:'#22 AWG',weight:0.2,conduit_id:'C11'},
 {tag:'CBL24',cable_type:'Power',diameter:1.0,conductors:3,conductor_size:'#1 AWG',weight:3.0,conduit_id:'C12'},
 {tag:'CBL25',cable_type:'Control',diameter:0.6,conductors:6,conductor_size:'#12 AWG',weight:1.1,conduit_id:'C12'},
 {tag:'CBL26',cable_type:'Power',diameter:1.1,conductors:3,conductor_size:'#2 AWG',weight:3.5,conduit_id:'C13'},
 {tag:'CBL27',cable_type:'Signal',diameter:0.4,conductors:2,conductor_size:'#18 AWG',weight:0.4,conduit_id:'C13'},
 {tag:'CBL28',cable_type:'Control',diameter:0.7,conductors:4,conductor_size:'#14 AWG',weight:1.3,conduit_id:'C14'},
 {tag:'CBL29',cable_type:'Power',diameter:1.3,conductors:3,conductor_size:'#1/0 AWG',weight:4.0,conduit_id:'C15'},
 {tag:'CBL30',cable_type:'Signal',diameter:0.5,conductors:1,conductor_size:'#16 AWG',weight:0.6,conduit_id:'C16'},
];

// add additional cable properties for sample data
SAMPLE_CABLES.forEach(c=>{
 c.conductor_material='Copper';
 c.insulation_type='THHN';
 c.voltage_rating='600V';
 c.shielding_jacket='';
 c.est_load=250;
});

const CONDUIT_SPECS={
 "EMT":{"1/2":0.304,"3/4":0.533,"1":0.864,"1-1/4":1.496,"1-1/2":2.036,"2":3.356,"2-1/2":5.858,"3":8.846,"3-1/2":11.545,"4":14.753},
 "RMC":{"1/2":0.314,"3/4":0.549,"1":0.887,"1-1/4":1.526,"1-1/2":2.071,"2":3.408,"2-1/2":4.866,"3":7.499,"3-1/2":10.01,"4":12.882,"5":20.212,"6":29.158},
 "PVC Sch 40":{"1/2":0.285,"3/4":0.508,"1":0.832,"1-1/4":1.453,"1-1/2":1.986,"2":3.291,"2-1/2":4.695,"3":7.268,"3-1/2":9.737,"4":12.554,"5":19.761,"6":28.567}
};

const INSULATION_TEMP_LIMIT={
  THHN:90,
  XLPE:90,
  PVC:75,
  XHHW:90
};

function fToC(f){
  return (f-32)/1.8;
}

function neherMcGrathTemp(power, Rth, ambient, k, r){
  const r0 = 0.05; // reference radius in meters
  const radial = Math.log(Math.max(r, r0)/r0)/(2*Math.PI*k);
  return ambient + power*(Rth + radial);
}

function runNeherMcGrathTests(){
  const t = neherMcGrathTemp(10, 0.5, 20, 1, 0.5);
  console.assert(Math.abs(t-28.7)<0.5, 'neherMcGrathTemp basic test');
  console.log('neherMcGrathTemp(10W,0.5m,Rth=0.5,k=1) ->', t.toFixed(2),'°C');
}
runNeherMcGrathTests();

function parseSize(sz){
 if(sz.includes('-')){const[w,f]=sz.split('-');const[n,d]=f.split('/');return parseFloat(w)+parseFloat(n)/parseFloat(d);} 
 if(sz.includes('/')){const[n,d]=sz.split('/');return parseFloat(n)/parseFloat(d);} 
 return parseFloat(sz);
}

function conduitSizeOptions(type){
 const sel=document.createElement('select');
 Object.keys(CONDUIT_SPECS[type]||{}).sort((a,b)=>parseSize(a)-parseSize(b)).forEach(s=>{const o=document.createElement('option');o.value=s;o.textContent=s;sel.appendChild(o);});
 return sel;
}

function createButton(text,cls,handler){
 const b=document.createElement('button');b.type='button';b.textContent=text;b.className=cls;b.addEventListener('click',handler);return b;
}

function filterTable(table, query){
 const q = query.toLowerCase();
 table.querySelectorAll('tbody tr').forEach(row => {
   let text = row.textContent.toLowerCase();
   row.querySelectorAll('input').forEach(inp => {
     text += ' ' + (inp.value || '').toLowerCase();
   });
   row.style.display = text.includes(q) ? '' : 'none';
 });
}

function packCircles(cables,R){
 const placed=[];
 cables.sort((a,b)=>b.r-a.r);
 function yAtBoundary(x,r){return Math.sqrt(Math.max(0,(R-r)*(R-r)-x*x));}
 for(const c of cables){
  let best=null;let bestY=-Infinity;const maxX=R-c.r;const step=Math.max(0.05,c.r/4);
  for(let x=-maxX;x<=maxX;x+=step){
   let y=yAtBoundary(x,c.r);
   for(const p of placed){
     const dx=x-p.x;if(Math.abs(dx)<p.r+c.r){const dy=Math.sqrt((p.r+c.r)*(p.r+c.r)-dx*dx);y=Math.min(y,p.y-dy);}
   }
   if(y>bestY){bestY=y;best={x,y};}
  }
  if(best){
   let y=yAtBoundary(best.x,c.r);
   for(const p of placed){
     const dx=best.x-p.x;if(Math.abs(dx)<p.r+c.r){const dy=Math.sqrt((p.r+c.r)*(p.r+c.r)-dx*dx);y=Math.min(y,p.y-dy);}
   }
   placed.push({x:best.x,y,r:c.r,tag:c.tag});
  }else{
   placed.push({x:0,y:0,r:c.r,tag:c.tag});
  }
 }
 return placed;
}

function addConduitRow(data={}){
 const tr=document.createElement('tr');
 const idTd=document.createElement('td');const idInput=document.createElement('input');idInput.value=data.conduit_id||'';idTd.appendChild(idInput);tr.appendChild(idTd);
 const typeTd=document.createElement('td');const typeSel=document.createElement('select');Object.keys(CONDUIT_SPECS).forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;typeSel.appendChild(o);});typeSel.value=data.conduit_type||Object.keys(CONDUIT_SPECS)[0];typeTd.appendChild(typeSel);tr.appendChild(typeTd);
 const sizeTd=document.createElement('td');let sizeSel=conduitSizeOptions(typeSel.value);sizeTd.appendChild(sizeSel);sizeSel.value=data.trade_size||sizeSel.options[0].value;tr.appendChild(sizeTd);
 typeSel.addEventListener('change',()=>{const old=sizeSel;sizeSel=conduitSizeOptions(typeSel.value);sizeTd.replaceChild(sizeSel,old);});
 ['x','y'].forEach(k=>{const td=document.createElement('td');const inp=document.createElement('input');inp.type='number';inp.value=data[k]||0;if(k==='x'||k==='y')inp.readOnly=true;td.appendChild(inp);tr.appendChild(td);});
 const dupTd=document.createElement('td');dupTd.appendChild(createButton('⧉','duplicateBtn',()=>{const cloneData=rowToConduit(tr);addConduitRow(cloneData);}));tr.appendChild(dupTd);
 const delTd=document.createElement('td');delTd.appendChild(createButton('✖','removeBtn',()=>{tr.remove();drawGrid();
 updateAmpacityReport();saveDuctbankSession();}));tr.appendChild(delTd);
 document.querySelector('#conduitTable tbody').appendChild(tr);
 autoPlaceConduits();
 saveDuctbankSession();
}

function addCableRow(data={}){
 const tr=document.createElement('tr');
 const cols=['tag','cable_type','diameter','conductors','conductor_size','weight','est_load','conduit_id','conductor_material','insulation_type','voltage_rating','shielding_jacket'];
 const selectOptions={
  cable_type:['Power','Control','Signal'],
  conductor_material:['Copper','Aluminum'],
  insulation_type:['THHN','XLPE','PVC'],
  shielding_jacket:['','Lead','Copper Tape']
 };
 cols.forEach(c=>{
  const td=document.createElement('td');
  let inp;
  if(selectOptions[c]){
    inp=document.createElement('select');
    selectOptions[c].forEach(opt=>{
      const o=document.createElement('option');
      o.value=opt;
      o.textContent=opt||'None';
      inp.appendChild(o);
    });
  }else{
    inp=document.createElement('input');
    if(c==='diameter'||c==='weight'||c==='est_load') inp.type='number';
    else if(c==='conductors') inp.type='number';
    else inp.type='text';
    if(c==='conductor_size') inp.setAttribute('list','sizeList');
  }
  inp.value=data[c]||'';
  td.appendChild(inp);
  tr.appendChild(td);
 });
 const dupTd=document.createElement('td');dupTd.appendChild(createButton('⧉','duplicateBtn',()=>{const clone=rowToCable(tr);addCableRow(clone);}));tr.appendChild(dupTd);
 const delTd=document.createElement('td');delTd.appendChild(createButton('✖','removeBtn',()=>{tr.remove();drawGrid();updateAmpacityReport();saveDuctbankSession();}));tr.appendChild(delTd);
 document.querySelector('#cableTable tbody').appendChild(tr);
 drawGrid();
 updateAmpacityReport();
 saveDuctbankSession();
}

function rowToConduit(tr){
 const [id,type,size,x,y]=Array.from(tr.children).slice(0,5).map(td=>td.querySelector('input,select').value);
 return {conduit_id:id,conduit_type:type,trade_size:size,x:parseFloat(x),y:parseFloat(y)};
}

function rowToCable(tr){
 const vals=Array.from(tr.children).slice(0,12).map(td=>{
  const el=td.querySelector('input,select');
  return el?el.value:'';
 });
 const [tag,cable_type,diameter,conductors,conductor_size,weight,est_load,conduit_id,conductor_material,insulation_type,voltage_rating,shielding_jacket]=vals;
  return {
   tag,
   cable_type,
   diameter:parseFloat(diameter),
   conductors:parseInt(conductors||0),
   conductor_size,
   weight:parseFloat(weight)||0,
   est_load:parseFloat(est_load)||0,
   conduit_id,
   conductor_material,
   insulation_type,
   voltage_rating,
   shielding_jacket
  };
}

function getAllConduits(){
 return Array.from(document.querySelectorAll('#conduitTable tbody tr')).map(rowToConduit);
}

function getAllCables(){
 return Array.from(document.querySelectorAll('#cableTable tbody tr')).map(rowToCable);
}

function saveDuctbankSession(){
 const session={
  ductbankTag:document.getElementById('ductbankTag').value,
  concreteEncasement:document.getElementById('concreteEncasement').checked,
  ductbankDepth:document.getElementById('ductbankDepth').value,
  earthTemp:document.getElementById('earthTemp').value,
  airTemp:document.getElementById('airTemp').value,
  soilResistivity:document.getElementById('soilResistivity').value,
  moistureContent:document.getElementById('moistureContent').value,
  heatSources:document.getElementById('heatSources').checked,
  hSpacing:document.getElementById('hSpacing').value,
  vSpacing:document.getElementById('vSpacing').value,
  topPad:document.getElementById('topPad').value,
  bottomPad:document.getElementById('bottomPad').value,
  leftPad:document.getElementById('leftPad').value,
  rightPad:document.getElementById('rightPad').value,
  perRow:document.getElementById('perRow').value,
  conduits:getAllConduits(),
  cables:getAllCables(),
  darkMode:document.body.classList.contains('dark-mode')
 };
 try{localStorage.setItem('ductbankSession',JSON.stringify(session));}catch(e){console.error('save session failed',e);}
}

function loadDuctbankSession(){
 const stored=localStorage.getItem('ductbankSession');
 if(!stored) return;
 try{
  const s=JSON.parse(stored);
  if(s.ductbankTag!==undefined)document.getElementById('ductbankTag').value=s.ductbankTag;
  if(s.concreteEncasement!==undefined)document.getElementById('concreteEncasement').checked=s.concreteEncasement;
  if(s.ductbankDepth!==undefined)document.getElementById('ductbankDepth').value=s.ductbankDepth;
  if(s.earthTemp!==undefined)document.getElementById('earthTemp').value=s.earthTemp;
  if(s.airTemp!==undefined)document.getElementById('airTemp').value=s.airTemp;
  if(s.soilResistivity!==undefined)document.getElementById('soilResistivity').value=s.soilResistivity;
  if(s.moistureContent!==undefined)document.getElementById('moistureContent').value=s.moistureContent;
  if(s.heatSources!==undefined)document.getElementById('heatSources').checked=s.heatSources;
  if(s.hSpacing!==undefined)document.getElementById('hSpacing').value=s.hSpacing;
  if(s.vSpacing!==undefined)document.getElementById('vSpacing').value=s.vSpacing;
  if(s.topPad!==undefined)document.getElementById('topPad').value=s.topPad;
  if(s.bottomPad!==undefined)document.getElementById('bottomPad').value=s.bottomPad;
  if(s.leftPad!==undefined)document.getElementById('leftPad').value=s.leftPad;
  if(s.rightPad!==undefined)document.getElementById('rightPad').value=s.rightPad;
  if(s.perRow!==undefined)document.getElementById('perRow').value=s.perRow;
  if(Array.isArray(s.conduits)){
    document.querySelector('#conduitTable tbody').innerHTML='';
    s.conduits.forEach(addConduitRow);
  }
  if(Array.isArray(s.cables)){
    document.querySelector('#cableTable tbody').innerHTML='';
    s.cables.forEach(addCableRow);
  }
  if(s.darkMode){document.body.classList.add('dark-mode');}
  else{document.body.classList.remove('dark-mode');}
  drawGrid();
  updateAmpacityReport();
 }catch(e){console.error('load session failed',e);}
}

function autoPlaceConduits(){
 const rows=document.querySelectorAll('#conduitTable tbody tr');
 const h=parseFloat(document.getElementById('hSpacing').value)||3;
 const v=parseFloat(document.getElementById('vSpacing').value)||4;
 const bottomPad=parseFloat(document.getElementById('bottomPad').value)||0;
 const leftPad=parseFloat(document.getElementById('leftPad').value)||0;
 const perRow=parseInt(document.getElementById('perRow').value)||Math.ceil(Math.sqrt(rows.length));

 const numRows=Math.ceil(rows.length/perRow);
 const rowMaxR=new Array(numRows).fill(0);
 const colMaxR=new Array(perRow).fill(0);
 for(let r=0;r<numRows;r++){
   for(let c=0;c<perRow;c++){
     const idx=r*perRow+c;
     if(idx>=rows.length)break;
     const tr=rows[idx];
     const type=tr.children[1].querySelector('select').value;
     const size=tr.children[2].querySelector('select').value;
     const Rin=Math.sqrt(CONDUIT_SPECS[type][size]/Math.PI);
     rowMaxR[r]=Math.max(rowMaxR[r],Rin);
     colMaxR[c]=Math.max(colMaxR[c],Rin);
   }
 }

 let yCursor=bottomPad;
 for(let r=0;r<numRows;r++){
   let xCursor=leftPad;
   for(let c=0;c<perRow;c++){
     const idx=r*perRow+c;
     if(idx>=rows.length)break;
     const tr=rows[idx];
     const type=tr.children[1].querySelector('select').value;
     const size=tr.children[2].querySelector('select').value;
     const Rin=Math.sqrt(CONDUIT_SPECS[type][size]/Math.PI);
     const cells=tr.querySelectorAll('td');
     const x=cells[3].querySelector('input');
     const y=cells[4].querySelector('input');
     x.value=xCursor+(colMaxR[c]-Rin);
     y.value=yCursor+(rowMaxR[r]-Rin);
     xCursor+=2*colMaxR[c]+h;
   }
   yCursor+=2*rowMaxR[r];
   if(r<numRows-1) yCursor+=v;
 }
}

function fillResults(){
 const conduits=getAllConduits();
 const cables=getAllCables();
 const fillMap={};
 conduits.forEach(c=>{fillMap[c.conduit_id]={area:CONDUIT_SPECS[c.conduit_type][c.trade_size],cables:[]};});
 cables.forEach(cb=>{const cid=cb.conduit_id;if(fillMap[cid])fillMap[cid].cables.push(cb);});
 Object.values(fillMap).forEach(c=>{c.fillArea=c.cables.reduce((s,cb)=>s+Math.PI*Math.pow(cb.diameter/2,2),0);c.fillPct=(c.fillArea/c.area)*100;});
 return fillMap;
}

const AWG_AREA={"18":1624,"16":2583,"14":4107,"12":6530,"10":10380,"8":16510,"6":26240,"4":41740,"3":52620,"2":66360,"1":83690,"1/0":105600,"2/0":133100,"3/0":167800,"4/0":211600};

const BASE_RESISTIVITY={cu:0.017241,al:0.028264}; // ohm-mm^2/m @20C
const TEMP_COEFF={cu:0.00393,al:0.00403};
const RESISTANCE_TABLE={cu:{},al:{}};
for(const sz in AWG_AREA){
  const areaMM2=AWG_AREA[sz]*0.0005067;
  RESISTANCE_TABLE.cu[sz]=BASE_RESISTIVITY.cu/areaMM2;
  RESISTANCE_TABLE.al[sz]=BASE_RESISTIVITY.al/areaMM2;
}

function dcResistance(size,material,temp=20){
  const key=size?size.toString().trim():'';
  const mat=material&&material.toLowerCase().includes('al')?'al':'cu';
  let base=RESISTANCE_TABLE[mat][key];
  if(base===undefined){
    const areaCM=sizeToArea(size);
    if(!areaCM)return 0;
    const areaMM2=areaCM*0.0005067;
    base=BASE_RESISTIVITY[mat]/areaMM2;
  }
  return base*(1+TEMP_COEFF[mat]*(temp-20));
}

function sizeToArea(size){
 if(!size)return 0;
 const s=size.toString().trim();
 if(/kcmil/i.test(s))return parseFloat(s)*1000;
 const m=s.match(/#?(\d+(?:\/0)?)/);
 if(!m)return 0;
 return AWG_AREA[m[1]]||0;
}

function estimateAmpacity(cable,params,count=1,total=0){
 const areaCM=sizeToArea(cable.conductor_size);
 if(!areaCM)return {ampacity:0};
 const Rdc=dcResistance(cable.conductor_size,cable.conductor_material,90);
 const spacing=(params.hSpacing+params.vSpacing)/2||3;
 const spacingAdj=3/spacing; // tighter spacing -> higher thermal resistance
 let Rth=(params.soilResistivity||90)/90*0.5;
 const moistAdj=1-Math.min(params.moistureContent||0,100)/200;
 Rth*=moistAdj;
 if(total>count)Rth*=(1+(total-count)*0.05);
 if(params.heatSources)Rth*=1.2;
 Rth*=spacingAdj;
 if(params.concreteEncasement)Rth*=0.8;
 Rth*=(1+(params.ductbankDepth||0)/100);

 const ins=(cable.insulation_type||'').toUpperCase();
 if(ins.includes('XLPE'))Rth*=0.95;else if(ins.includes('PVC'))Rth*=1.05;
 const volt=parseFloat(cable.voltage_rating)||600;
 if(volt>2000)Rth*=1.1;else if(volt<600)Rth*=0.95;
 if(cable.shielding_jacket)Rth*=1.05;

 Rth*=count;
 const amb=Math.max(params.earthTemp||20,
                   isNaN(params.airTemp)?-Infinity:params.airTemp);
 const dT=90-amb;
 const ampacity=Math.sqrt(dT/(Rdc*Rth));
 return {ampacity};
}

function updateAmpacityReport(){
 const earthF=parseFloat(document.getElementById('earthTemp').value);
 const airF=parseFloat(document.getElementById('airTemp').value);
 const params={
  earthTemp:isNaN(earthF)?20:fToC(earthF),
  airTemp:isNaN(airF)?NaN:fToC(airF),
  soilResistivity:parseFloat(document.getElementById('soilResistivity').value)||90,
  moistureContent:parseFloat(document.getElementById('moistureContent').value)||0,
  heatSources:document.getElementById('heatSources').checked,
  hSpacing:parseFloat(document.getElementById('hSpacing').value)||3,
  vSpacing:parseFloat(document.getElementById('vSpacing').value)||4,
  concreteEncasement:document.getElementById('concreteEncasement').checked,
  ductbankDepth:parseFloat(document.getElementById('ductbankDepth').value)||0
 };
 const cables=getAllCables();
 const total=cables.length;
 const countMap={};
 cables.forEach(c=>{countMap[c.conduit_id]=(countMap[c.conduit_id]||0)+1;});
 const rows=cables.map(c=>{
  const res=estimateAmpacity(c,params,countMap[c.conduit_id],total);
  const neher=isFinite(res.ampacity)?res.ampacity.toFixed(0):'N/A';
  const finite=window.finiteAmpacity?window.finiteAmpacity[c.tag]||'N/A':'N/A';
  const overObj=window.conduitOverLimit&&window.conduitOverLimit[c.conduit_id];
  const over=overObj&&overObj.over;
  return `<tr><td>${c.tag}</td><td>${neher}</td><td>${finite}</td><td>${over?'Yes':''}</td></tr>`;
 }).join('');
 document.getElementById('ampacityReport').innerHTML=
   `<h3>Ampacity Estimates</h3><table><thead><tr><th>Cable</th><th>Ampacity (A) - Neher McGrath</th><th>Ampacity (A) - Finite Element</th><th>Over Limit</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function drawGrid(){
 const svg=document.getElementById('grid');
 const heat=document.getElementById('tempCanvas');
 if(heat){const ctx=heat.getContext('2d');ctx.clearRect(0,0,heat.width,heat.height);} 
 svg.innerHTML='';
 autoPlaceConduits();
 const conduits=getAllConduits();
 if(conduits.length===0)return;
 const topPad=parseFloat(document.getElementById('topPad').value)||0;
 const bottomPad=parseFloat(document.getElementById('bottomPad').value)||0;
 const leftPad=parseFloat(document.getElementById('leftPad').value)||0;
 const rightPad=parseFloat(document.getElementById('rightPad').value)||0;
 const margin=20;
 const scale=40; // pixels per unit
 const fillMap=fillResults();
let maxX=0,maxY=0;
conduits.forEach(c=>{
  const Rin=Math.sqrt(CONDUIT_SPECS[c.conduit_type][c.trade_size]/Math.PI);
  maxX=Math.max(maxX,c.x+2*Rin);
  maxY=Math.max(maxY,c.y+2*Rin);
});
maxY+=topPad;
 maxX+=rightPad;

 const defs=document.createElementNS('http://www.w3.org/2000/svg','defs');
 svg.appendChild(defs);

 const rect=document.createElementNS('http://www.w3.org/2000/svg','rect');
 rect.setAttribute('x',margin);
 rect.setAttribute('y',margin);
 rect.setAttribute('width',maxX*scale);
 rect.setAttribute('height',maxY*scale);
 rect.setAttribute('fill','none');
 rect.setAttribute('stroke','gray');
 rect.setAttribute('stroke-dasharray','4 2');
svg.appendChild(rect);

 // overall dimension lines
 const widthY=margin+maxY*scale+15;
 const wStart=margin, wEnd=margin+maxX*scale;
 const widthLine=document.createElementNS('http://www.w3.org/2000/svg','line');
 widthLine.setAttribute('x1',wStart);
 widthLine.setAttribute('x2',wEnd);
 widthLine.setAttribute('y1',widthY);
 widthLine.setAttribute('y2',widthY);
 widthLine.setAttribute('stroke','black');
 svg.appendChild(widthLine);
 const tick1=document.createElementNS('http://www.w3.org/2000/svg','line');
 tick1.setAttribute('x1',wStart);
 tick1.setAttribute('x2',wStart);
 tick1.setAttribute('y1',widthY-4);
 tick1.setAttribute('y2',widthY+4);
 tick1.setAttribute('stroke','black');
 svg.appendChild(tick1);
 const tick2=document.createElementNS('http://www.w3.org/2000/svg','line');
 tick2.setAttribute('x1',wEnd);
 tick2.setAttribute('x2',wEnd);
 tick2.setAttribute('y1',widthY-4);
 tick2.setAttribute('y2',widthY+4);
 tick2.setAttribute('stroke','black');
 svg.appendChild(tick2);
const widthText=document.createElementNS('http://www.w3.org/2000/svg','text');
widthText.setAttribute('x',(wStart+wEnd)/2);
widthText.setAttribute('y',widthY-6);
widthText.setAttribute('font-size','10');
widthText.setAttribute('text-anchor','middle');
widthText.textContent=maxX.toFixed(2)+'"';
svg.appendChild(widthText);

 const tag=document.getElementById('ductbankTag').value.trim();
 if(tag){
   const tagText=document.createElementNS('http://www.w3.org/2000/svg','text');
   tagText.setAttribute('x',margin+maxX*scale/2);
   tagText.setAttribute('y',margin-4);
   tagText.setAttribute('font-size','14');
   tagText.setAttribute('text-anchor','middle');
   tagText.textContent=tag;
   svg.appendChild(tagText);
 }

 const heightX=margin+maxX*scale+15;
 const hStart=margin, hEnd=margin+maxY*scale;
 const heightLine=document.createElementNS('http://www.w3.org/2000/svg','line');
 heightLine.setAttribute('x1',heightX);
 heightLine.setAttribute('x2',heightX);
 heightLine.setAttribute('y1',hStart);
 heightLine.setAttribute('y2',hEnd);
 heightLine.setAttribute('stroke','black');
 svg.appendChild(heightLine);
 const hTick1=document.createElementNS('http://www.w3.org/2000/svg','line');
 hTick1.setAttribute('x1',heightX-4);
 hTick1.setAttribute('x2',heightX+4);
 hTick1.setAttribute('y1',hStart);
 hTick1.setAttribute('y2',hStart);
 hTick1.setAttribute('stroke','black');
 svg.appendChild(hTick1);
 const hTick2=document.createElementNS('http://www.w3.org/2000/svg','line');
 hTick2.setAttribute('x1',heightX-4);
 hTick2.setAttribute('x2',heightX+4);
 hTick2.setAttribute('y1',hEnd);
 hTick2.setAttribute('y2',hEnd);
 hTick2.setAttribute('stroke','black');
 svg.appendChild(hTick2);
 const heightText=document.createElementNS('http://www.w3.org/2000/svg','text');
 heightText.setAttribute('x',heightX+6);
 heightText.setAttribute('y',(hStart+hEnd)/2);
 heightText.setAttribute('font-size','10');
 heightText.setAttribute('text-anchor','start');
 heightText.setAttribute('dominant-baseline','middle');
 heightText.textContent=maxY.toFixed(2)+'"';
 svg.appendChild(heightText);

 conduits.forEach(c=>{
   const Rin=Math.sqrt(CONDUIT_SPECS[c.conduit_type][c.trade_size]/Math.PI);
   const R=Rin*scale;
   const cx=c.x*scale+R+margin;
   const cy=c.y*scale+R+margin;
   const data=fillMap[c.conduit_id];
   let color='green';
   if(data){
     const count=data.cables.length;
     const limit=count===1?53:count===2?31:40;
     if(data.fillPct>limit)color='red';else if(data.fillPct>0.8*limit)color='yellow';
   }
   const clip=document.createElementNS('http://www.w3.org/2000/svg','clipPath');
   const clipId=`clip-${c.conduit_id}`;
   clip.setAttribute('id',clipId);
   const clipCircle=document.createElementNS('http://www.w3.org/2000/svg','circle');
   clipCircle.setAttribute('cx',cx);clipCircle.setAttribute('cy',cy);clipCircle.setAttribute('r',R);
   clip.appendChild(clipCircle);
   defs.appendChild(clip);
   if(data){
     const placed=packCircles(data.cables.map(cb=>({tag:cb.tag,r:cb.diameter/2})),Rin);
    placed.forEach(p=>{
       const sc=document.createElementNS('http://www.w3.org/2000/svg','circle');
       sc.setAttribute('cx',cx+p.x*scale);
       sc.setAttribute('cy',cy+p.y*scale);
       sc.setAttribute('r',p.r*scale);
       sc.setAttribute('fill','lightblue');
       sc.setAttribute('stroke','black');
       sc.setAttribute('clip-path',`url(#${clipId})`);
       svg.appendChild(sc);
       if(p.tag){
         const fs=Math.max(6,Math.min(p.r*scale,(2*p.r*scale*0.8)/(p.tag.length*0.6)));
         const text=document.createElementNS('http://www.w3.org/2000/svg','text');
         text.setAttribute('x',cx+p.x*scale);
         text.setAttribute('y',cy+p.y*scale);
         text.setAttribute('font-size',fs);
         text.setAttribute('text-anchor','middle');
         text.setAttribute('dominant-baseline','middle');
         text.setAttribute('clip-path',`url(#${clipId})`);
         text.textContent=p.tag;
         svg.appendChild(text);
         const text2=document.createElementNS('http://www.w3.org/2000/svg','text');
         text2.setAttribute('x',cx+p.x*scale);
         text2.setAttribute('y',cy+p.y*scale+fs*0.8);
         text2.setAttribute('font-size',Math.max(6,fs*0.7));
         text2.setAttribute('text-anchor','middle');
         text2.setAttribute('dominant-baseline','hanging');
         text2.setAttribute('clip-path',`url(#${clipId})`);
         text2.textContent=(2*p.r).toFixed(2)+'"';
         svg.appendChild(text2);
       }
     });
   }
   const circle=document.createElementNS('http://www.w3.org/2000/svg','circle');
   circle.setAttribute('cx',cx);circle.setAttribute('cy',cy);circle.setAttribute('r',R);
   circle.setAttribute('fill',color);
   circle.setAttribute('fill-opacity','0.4');
   circle.setAttribute('stroke','black');
  if(data){
    const names=data.cables.map(c=>c.tag).join(', ');
    circle.setAttribute('title',`${c.conduit_id}: ${data.fillPct.toFixed(1)}% - ${names}`);
  }
  svg.appendChild(circle);
  const cidText=document.createElementNS('http://www.w3.org/2000/svg','text');
  cidText.setAttribute('x',cx);
  cidText.setAttribute('y',cy-R-22);
  cidText.setAttribute('font-size','10');
  cidText.setAttribute('text-anchor','middle');
  cidText.textContent=c.conduit_id;
  svg.appendChild(cidText);
  const typeText=document.createElementNS('http://www.w3.org/2000/svg','text');
  typeText.setAttribute('x',cx);
  typeText.setAttribute('y',cy-R-10);
  typeText.setAttribute('font-size','8');
  typeText.setAttribute('text-anchor','middle');
  typeText.textContent=`${c.conduit_type} ${c.trade_size}\"`;
  svg.appendChild(typeText);
});
svg.setAttribute('width',maxX*scale+2*margin+80);

svg.setAttribute('height',maxY*scale+2*margin+20);
}

function validateThermalInputs(){
  const warnings=[];
  const depthEl=document.getElementById('ductbankDepth');
  let depth=parseFloat(depthEl.value);
  if(isFinite(depth)){
    if(depth>120){
      warnings.push('Ductbank depth capped at 120 in (10 ft).');
      depthEl.value=120;
    }else if(depth<0){
      warnings.push('Ductbank depth cannot be negative.');
      depthEl.value=0;
    }
  }
  const hEl=document.getElementById('hSpacing');
  let h=parseFloat(hEl.value);
  if(isFinite(h)){
    if(h>24){warnings.push('Horiz spacing capped at 24 in.');hEl.value=24;}
    else if(h<1){warnings.push('Horiz spacing raised to 1 in.');hEl.value=1;}
  }
  const vEl=document.getElementById('vSpacing');
  let v=parseFloat(vEl.value);
  if(isFinite(v)){
    if(v>24){warnings.push('Vert spacing capped at 24 in.');vEl.value=24;}
    else if(v<1){warnings.push('Vert spacing raised to 1 in.');vEl.value=1;}
  }
  document.querySelectorAll('#cableTable tbody tr').forEach(tr=>{
    const loadCell=tr.children[6];
    if(!loadCell)return;
    const inp=loadCell.querySelector('input');
    if(!inp)return;
    let val=parseFloat(inp.value);
    const tagCell=tr.children[0];
    const tag=tagCell?tagCell.querySelector('input')?.value||'Cable':'Cable';
    if(isFinite(val)){
      if(val>2000){warnings.push(`${tag} load capped at 2000 A.`);inp.value=2000;}
      else if(val<0){warnings.push(`${tag} load cannot be negative.`);inp.value=0;}
    }
  });
 if(warnings.length)alert('Input warnings:\n'+warnings.join('\n'));
}

function solveDuctbankTemperatures(conduits,cables,params){
  const svg=document.getElementById('grid');
  const width=parseFloat(svg.getAttribute('width'))||svg.clientWidth;
  const height=parseFloat(svg.getAttribute('height'))||svg.clientHeight;
  const scale=40,margin=20;
  const step=4; // pixel step for solver grid
  const dx=(0.0254/scale)*step;
  const nx=Math.ceil(width/step);
  const ny=Math.ceil(height/step);
  const k=100/((params.soilResistivity)||90);
  const hConv=10; // W/(m^2*K)
  const Bi=hConv*dx/k;
  const earthT=params.earthTemp||20;
  const airT=isNaN(params.airTemp)?earthT:params.airTemp;

  const grid=new Array(ny).fill(0).map(()=>new Array(nx).fill(earthT));
  const newGrid=new Array(ny).fill(0).map(()=>new Array(nx).fill(earthT));
  const powerGrid=new Array(ny).fill(0).map(()=>new Array(nx).fill(0));
  const conduitCells={};

  const heatMap={};
  cables.forEach(c=>{
    const cd=conduits.find(d=>d.conduit_id===c.conduit_id);
    if(!cd)return;
    const Rin=Math.sqrt(CONDUIT_SPECS[cd.conduit_type][cd.trade_size]/Math.PI);
    const cx=(cd.x+Rin)*0.0254,cy=(cd.y+Rin)*0.0254;
    const Rdc=dcResistance(c.conductor_size,c.conductor_material,90);
    const current=parseFloat(c.est_load)||0;
    const power=current*current*Rdc;
    if(!heatMap[c.conduit_id]){
      heatMap[c.conduit_id]={cx,cy,r:Rin*0.0254,power:0};
    }
    heatMap[c.conduit_id].power+=power;
  });

  Object.keys(heatMap).forEach(cid=>{
    const h=heatMap[cid];
    const cxPx=Math.round((h.cx/0.0254*scale+margin)/step);
    const cyPx=Math.round((h.cy/0.0254*scale+margin)/step);
    const rPx=Math.max(1,Math.round((h.r/0.0254*scale)/step));
    const q=h.power/(Math.PI*h.r*h.r)*dx*dx/k;
    for(let j=Math.max(0,cyPx-rPx);j<=Math.min(ny-1,cyPx+rPx);j++){
      for(let i=Math.max(0,cxPx-rPx);i<=Math.min(nx-1,cxPx+rPx);i++){
        const dxp=i-cxPx,dyp=j-cyPx;
        if(dxp*dxp+dyp*dyp<=rPx*rPx){
          powerGrid[j][i]+=q;
          if(!conduitCells[cid])conduitCells[cid]=[];
          conduitCells[cid].push([j,i]);
        }
      }
    }
  });

  let diff=Infinity,iter=0,maxIter=500;
  while(diff>0.01&&iter<maxIter){
    diff=0;
    for(let j=0;j<ny;j++){
      for(let i=0;i<nx;i++){
        let val;
        if(j===ny-1||i===0||i===nx-1){
          val=earthT;
        }else if(j===0){
          val=(grid[j+1][i]+Bi*airT)/(1+Bi);
        }else{
          val=0.25*(grid[j][i-1]+grid[j][i+1]+grid[j-1][i]+grid[j+1][i]+powerGrid[j][i]);
        }
        newGrid[j][i]=val;
        diff=Math.max(diff,Math.abs(val-grid[j][i]));
      }
    }
    for(let j=0;j<ny;j++){
      for(let i=0;i<nx;i++)grid[j][i]=newGrid[j][i];
    }
    iter++;
  }

  const temps={};
  Object.keys(conduitCells).forEach(cid=>{
    const cells=conduitCells[cid];
    let sum=0;
    cells.forEach(([j,i])=>{sum+=grid[j][i];});
    temps[cid]=sum/cells.length;
  });
  return {grid,conduitTemps:temps};
}

function runFiniteThermalAnalysis(){
  drawGrid();
  const conduits=getAllConduits();
 const cables=getAllCables();
 const canvas=document.getElementById('tempCanvas');
const svg=document.getElementById('grid');
const width=parseFloat(svg.getAttribute('width')) || svg.clientWidth;
const height=parseFloat(svg.getAttribute('height')) || svg.clientHeight;
canvas.width=width;
canvas.height=height;
canvas.style.width = width + 'px';
canvas.style.height = height + 'px';
canvas.style.display=heatVisible?'block':'none';
const ctx=canvas.getContext('2d');
 ctx.clearRect(0,0,width,height);
 const scale=40,margin=20;
 const earthF=parseFloat(document.getElementById('earthTemp').value);
 const airF=parseFloat(document.getElementById('airTemp').value);
 const ambient=isNaN(earthF)?20:fToC(earthF);
 const params={
  soilResistivity:parseFloat(document.getElementById('soilResistivity').value)||90,
  moistureContent:parseFloat(document.getElementById('moistureContent').value)||0,
  heatSources:document.getElementById('heatSources').checked,
  hSpacing:parseFloat(document.getElementById('hSpacing').value)||3,
  vSpacing:parseFloat(document.getElementById('vSpacing').value)||4,
  concreteEncasement:document.getElementById('concreteEncasement').checked,
  ductbankDepth:parseFloat(document.getElementById('ductbankDepth').value)||0,
  earthTemp:ambient,
  airTemp:isNaN(airF)?NaN:fToC(airF)
 };

 const result=solveDuctbankTemperatures(conduits,cables,params);
 const grid=result.grid;
 const conduitTemps=result.conduitTemps;

 const step=4; // same as solver
 const img=ctx.createImageData(width,height);
 let maxT=-Infinity,maxPx=0,maxPy=0;
 for(let j=0;j<grid.length;j++){
   for(let i=0;i<grid[j].length;i++){
     const T=grid[j][i];
     if(T>maxT){maxT=T;maxPx=i*step;maxPy=j*step;}
     const r=Math.min(255,Math.max(0,Math.round(255*Math.min(1,(T-ambient)/30))));
     const b=255-r;
     for(let dy=0;dy<step;dy++){
       for(let dx=0;dx<step;dx++){
         const idx=((j*step+dy)*width+(i*step+dx))*4;
         img.data[idx]=r;
         img.data[idx+1]=0;
         img.data[idx+2]=b;
         img.data[idx+3]=200;
       }
     }
   }
 }
 ctx.putImageData(img,0,0);
 const maxTF=maxT*9/5+32;
 if(maxT>90){
   console.warn(`Maximum temperature ${maxT.toFixed(1)}\u00B0C exceeds 90\u00B0C rating.`);
 }
 ctx.beginPath();
 ctx.arc(maxPx,maxPy,5,0,Math.PI*2);
 ctx.fillStyle='yellow';
 ctx.fill();
 ctx.strokeStyle='red';
 ctx.stroke();
 ctx.font='12px sans-serif';
 ctx.fillStyle='black';
 ctx.fillText(maxTF.toFixed(1)+'\u00B0F',maxPx+8,maxPy-8);

 // draw temperature marker for each conduit
 window.conduitOverLimit={};
 conduits.forEach(cd=>{
   const Rin=Math.sqrt(CONDUIT_SPECS[cd.conduit_type][cd.trade_size]/Math.PI);
   const px=(cd.x+Rin)*scale+margin;
   const py=(cd.y+Rin)*scale+margin;
   const t=conduitTemps[cd.conduit_id]??ambient;
   const tf=t*9/5+32;
   const cb=cables.filter(c=>c.conduit_id===cd.conduit_id);
   let rating=0;
   cb.forEach(c=>{const ins=(c.insulation_type||'').toUpperCase();rating=Math.max(rating,INSULATION_TEMP_LIMIT[ins]||90);});
   const over=t>rating;
   window.conduitOverLimit[cd.conduit_id]={temp:t,over};
   if(over){
     console.warn(`Temperature at conduit ${cd.conduit_id} reaches ${t.toFixed(1)}\u00B0C > rating ${rating}\u00B0C`);
   }
   ctx.beginPath();
   ctx.arc(px,py,4,0,Math.PI*2);
   ctx.fillStyle=over?'red':'yellow';
   ctx.fill();
   ctx.strokeStyle='black';
   ctx.stroke();
   ctx.fillStyle='black';
   ctx.fillText(tf.toFixed(1)+'\u00B0F'+(over?' ⚠':''),px+6,py+4);
 });

 window.finiteAmpacity = {};
 cables.forEach(c => {
   const areaCM = sizeToArea(c.conductor_size);
   if(!areaCM){
     window.finiteAmpacity[c.tag] = 'N/A';
     return;
   }
   const cd = conduits.find(d => d.conduit_id === c.conduit_id);
   if(!cd){
     window.finiteAmpacity[c.tag] = 'N/A';
     return;
   }
   const T = conduitTemps[cd.conduit_id]??ambient;
   const Rdc = dcResistance(c.conductor_size,c.conductor_material,T);
   const current=parseFloat(c.est_load)||0;
   if(current<=0){
     window.finiteAmpacity[c.tag]='N/A';
     return;
   }
   const Rth = (T - ambient) / (current*current*Rdc);
   const amp = Math.sqrt((90 - ambient) / (Rdc * Rth));
   window.finiteAmpacity[c.tag] = isFinite(amp) ? amp.toFixed(0) : 'N/A';
 });
 updateAmpacityReport();
}

function importCSV(file,callback){
 const reader=new FileReader();
 reader.onload=e=>{const rows=e.target.result.trim().split(/\r?\n/).map(r=>r.split(','));const headers=rows.shift();const objs=rows.map(r=>{const o={};headers.forEach((h,i)=>o[h.trim()]=r[i]);return o;});callback(objs);};
 reader.readAsText(file);
}

document.getElementById('addConduit').addEventListener('click',()=>{addConduitRow();});
document.getElementById('addCable').addEventListener('click',()=>{addCableRow();});
document.getElementById('sampleConduits').addEventListener('click',()=>{
 document.querySelector('#conduitTable tbody').innerHTML='';
 SAMPLE_CONDUITS.forEach(addConduitRow);
 drawGrid();
 updateAmpacityReport();
 saveDuctbankSession();
});
document.getElementById('sampleCables').addEventListener('click',()=>{
 document.querySelector('#cableTable tbody').innerHTML='';
 SAMPLE_CABLES.forEach(addCableRow);
 drawGrid();
 updateAmpacityReport();
 saveDuctbankSession();
});

document.getElementById('importConduits').addEventListener('change',e=>{const f=e.target.files[0];if(f)importCSV(f,data=>{document.querySelector('#conduitTable tbody').innerHTML='';data.forEach(addConduitRow);drawGrid();updateAmpacityReport();saveDuctbankSession();});});
document.getElementById('importCables').addEventListener('change',e=>{const f=e.target.files[0];if(f)importCSV(f,data=>{document.querySelector('#cableTable tbody').innerHTML='';data.forEach(addCableRow);drawGrid();updateAmpacityReport();saveDuctbankSession();});});

document.getElementById('calc').addEventListener('click',()=>{drawGrid();updateAmpacityReport();});

['hSpacing','vSpacing'].forEach(id=>{
 document.getElementById(id).addEventListener('input',()=>{
  drawGrid();
  updateAmpacityReport();
 });
});

document.getElementById('exportBtn').addEventListener('click',()=>{
 const wb=XLSX.utils.book_new();
 const conduits=getAllConduits();
 const cables=getAllCables();
 const fill=fillResults();
 XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(conduits),'conduits');
 XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(cables),'cables');
 const compliance=Object.keys(fill).map(k=>{const f=fill[k];return{conduit_id:k,fill_pct:f.fillPct.toFixed(2),cable_count:f.cables.length};});
 XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(compliance),'fill');
 XLSX.writeFile(wb,'ductbank_data.xlsx');
});

function exportCSV(filename,headers,rows){
 const csv=[headers.join(',')];
 rows.forEach(r=>{csv.push(headers.map(h=>r[h]!==undefined?r[h]:'').join(','));});
 const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'});
 const url=URL.createObjectURL(blob);
 const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
}

function exportConduits(){
 const rows=getAllConduits();
 const headers=['conduit_id','conduit_type','trade_size','x','y'];
 exportCSV('ductbank_conduits.csv',headers,rows);
}

function exportCables(){
 const rows=getAllCables();
 const headers=['tag','cable_type','diameter','conductors','conductor_size','weight','est_load','conduit_id','conductor_material','insulation_type','voltage_rating','shielding_jacket'];
 exportCSV('ductbank_cables.csv',headers,rows);
}

function exportImage(){
 const svg=document.getElementById('grid');
 const serializer=new XMLSerializer();
 const source=serializer.serializeToString(svg);
 const img=new Image();
 img.onload=()=>{
   const canvas=document.createElement('canvas');
   canvas.width=img.width;
   canvas.height=img.height;
   const ctx=canvas.getContext('2d');
   ctx.drawImage(img,0,0);
   const url=canvas.toDataURL('image/png');
   const a=document.createElement('a');
   a.href=url;
   a.download='ductbank.png';
   document.body.appendChild(a);
   a.click();
   document.body.removeChild(a);
 };
img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent(source);
}

function deleteSavedData(){
 localStorage.removeItem('ductbankSession');
 document.querySelector('#conduitTable tbody').innerHTML='';
 document.querySelector('#cableTable tbody').innerHTML='';
 ['ductbankTag','ductbankDepth','earthTemp','airTemp','soilResistivity','moistureContent','hSpacing','vSpacing','topPad','bottomPad','leftPad','rightPad','perRow'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.value='';
 });
 ['concreteEncasement','heatSources'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.checked=false;
 });
 drawGrid();
 updateAmpacityReport();
}

document.getElementById('exportConduitsBtn').addEventListener('click',exportConduits);
document.getElementById('exportCablesBtn').addEventListener('click',exportCables);
document.getElementById('exportImgBtn').addEventListener('click',exportImage);
document.getElementById('thermalBtn').addEventListener('click',()=>{
  validateThermalInputs();
  runFiniteThermalAnalysis();
});
document.getElementById('heatToggleBtn').addEventListener('click',()=>{
 heatVisible=!heatVisible;
 const canvas=document.getElementById('tempCanvas');
 canvas.style.display=heatVisible?'block':'none';
});

document.getElementById('themeToggle').addEventListener('click',()=>{
 document.body.classList.toggle('dark-mode');
 const session=JSON.parse(localStorage.getItem('ctrSession')||'{}');
 session.darkMode=document.body.classList.contains('dark-mode');
 localStorage.setItem('ctrSession',JSON.stringify(session));
 saveDuctbankSession();
});
const stored=JSON.parse(localStorage.getItem('ctrSession')||'{}');
if(stored.darkMode)document.body.classList.add('dark-mode');

window.addEventListener('storage',e=>{if(e.key==='ctrSession'){const d=JSON.parse(e.newValue);if(d.darkMode)document.body.classList.add('dark-mode');else document.body.classList.remove('dark-mode');}});

document.getElementById('helpBtn').addEventListener('click',()=>{
 document.getElementById('settings-menu').style.display='none';
 document.getElementById('helpOverlay').style.display='flex';
});
document.getElementById('helpClose').addEventListener('click',()=>{
 document.getElementById('helpOverlay').style.display='none';
});
document.getElementById('deleteDataBtn').addEventListener('click',deleteSavedData);

document.getElementById('settings-btn').addEventListener('click',()=>{
 const menu=document.getElementById('settings-menu');
 menu.style.display=menu.style.display==='flex'?'none':'flex';
});
document.addEventListener('click',e=>{
 const menu=document.getElementById('settings-menu');
 if(!menu.contains(e.target)&&e.target!==document.getElementById('settings-btn')){
  menu.style.display='none';
 }
});

// keyboard navigation within conduit and cable tables
document.addEventListener('keydown',e=>{
 const selector='#conduitTable input, #conduitTable select, #conduitTable button, '+
 '#cableTable input, #cableTable select, #cableTable button';
 if(!e.target.matches(selector))return;
 const key=e.key;
   if(key!=='ArrowUp'&&key!=='ArrowDown'&&key!=='Enter')return;
 const cell=e.target.closest('td');
 const row=cell.parentElement;
 const index=Array.prototype.indexOf.call(row.children,cell);
 const targetRow=key==='ArrowUp'?row.previousElementSibling:row.nextElementSibling;
 if(targetRow){
  const focusable=targetRow.children[index].querySelector('input,select,button');
  if(focusable){
   e.preventDefault();
   focusable.focus();
   if((key==='Enter'||key==='ArrowUp'||key==='ArrowDown')&&typeof focusable.select==='function'){
     focusable.select();
   }
  }
 }
});

['ductbankTag','concreteEncasement','ductbankDepth','earthTemp','airTemp','soilResistivity','moistureContent','heatSources','hSpacing','vSpacing','topPad','bottomPad','leftPad','rightPad','perRow'].forEach(id=>{
 const el=document.getElementById(id);
 if(el){
  el.addEventListener('input',saveDuctbankSession);
  el.addEventListener('change',saveDuctbankSession);
 }
});
document.querySelector('#conduitTable').addEventListener('input',saveDuctbankSession);
document.querySelector('#cableTable').addEventListener('input',saveDuctbankSession);
window.addEventListener('beforeunload',saveDuctbankSession);
const conduitSearch=document.getElementById('conduit-search');
if(conduitSearch){
 conduitSearch.addEventListener('input',()=>{
  filterTable(document.getElementById('conduitTable'), conduitSearch.value);
 });
}
const cableSearch=document.getElementById('cable-search');
if(cableSearch){
 cableSearch.addEventListener('input',()=>{
  filterTable(document.getElementById('cableTable'), cableSearch.value);
 });
}
loadDuctbankSession();
</script>
</body>
</html>
