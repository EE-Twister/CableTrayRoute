<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Library Manager</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>Library Manager</h1>
  <section>
    <h2>Component Library</h2>
    <label>Version <input id="library-version" type="text" size="10"></label><br>
    <textarea id="component-text" rows="10" cols="80"></textarea><br>
    <textarea id="icon-text" rows="10" cols="80"></textarea><br>
    <input type="file" id="library-upload" accept="application/json"><br>
    <button id="component-save">Save</button>
    <button id="component-download">Download</button>
  </section>
  <section>
    <h2>Manufacturer Library</h2>
    <textarea id="manufacturer-text" rows="20" cols="80"></textarea><br>
    <button id="manufacturer-save">Save</button>
    <button id="manufacturer-download">Download</button>
  </section>
  <script type="module">
    import { getItem, setItem } from './dataStore.mjs';

    async function load() {
      const compArea = document.getElementById('component-text');
      const iconArea = document.getElementById('icon-text');
      const versionInput = document.getElementById('library-version');
      const manufArea = document.getElementById('manufacturer-text');

      const currentVersion = getItem('componentLibraryVersion', '');
      versionInput.value = currentVersion || '';
      let stored = currentVersion ? getItem('componentLibrary_' + currentVersion, null) : null;
      if (stored) {
        compArea.value = JSON.stringify({
          categories: stored.categories || [],
          components: stored.components || []
        }, null, 2);
        iconArea.value = JSON.stringify(stored.icons || {}, null, 2);
      } else {
        try {
          const res = await fetch('componentLibrary.json');
          const data = await res.json();
          compArea.value = JSON.stringify(data, null, 2);
        } catch {
          compArea.value = '[]';
        }
        iconArea.value = '{}';
      }

      try {
        const res2 = await fetch('manufacturerLibrary.json');
        const data2 = await res2.json();
        const stored2 = getItem('manufacturerDefaults', null);
        manufArea.value = JSON.stringify(stored2 || data2, null, 2);
      } catch {
        manufArea.value = '{}';
      }
    }

    function saveComponents() {
      const compArea = document.getElementById('component-text');
      const iconArea = document.getElementById('icon-text');
      const versionInput = document.getElementById('library-version');
      try {
        const data = JSON.parse(compArea.value);
        const icons = JSON.parse(iconArea.value);
        const version = versionInput.value.trim() || 'user';
        const components = Array.isArray(data) ? data : data.components || [];
        const categories = Array.isArray(data.categories) ? data.categories : [];
        setItem('componentLibraryVersion', version);
        setItem('componentLibrary_' + version, { components, categories, icons });
        alert('Saved');
      } catch {
        alert('Invalid JSON');
      }
    }

    function downloadComponents() {
      const compArea = document.getElementById('component-text');
      const iconArea = document.getElementById('icon-text');
      const versionInput = document.getElementById('library-version');
      try {
        const data = JSON.parse(compArea.value);
        const icons = JSON.parse(iconArea.value);
        const version = versionInput.value.trim() || 'user';
        const components = Array.isArray(data) ? data : data.components || [];
        const categories = Array.isArray(data.categories) ? data.categories : [];
        const blob = new Blob([
          JSON.stringify({ version, categories, components, icons }, null, 2)
        ], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `componentLibrary_${version}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
      } catch {
        alert('Invalid JSON');
      }
    }

    function handleUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const obj = JSON.parse(reader.result);
          const version = obj.version || '';
          const components = Array.isArray(obj.components)
            ? obj.components
            : Array.isArray(obj)
            ? obj
            : [];
          const categories = Array.isArray(obj.categories) ? obj.categories : [];
          document.getElementById('library-version').value = version;
          document.getElementById('component-text').value = JSON.stringify({
            categories,
            components
          }, null, 2);
          document.getElementById('icon-text').value = JSON.stringify(obj.icons || {}, null, 2);
        } catch {
          alert('Invalid file');
        }
      };
      reader.readAsText(file);
    }

    function save(id, key) {
      const area = document.getElementById(id);
      try {
        const json = JSON.parse(area.value);
        setItem(key, json);
        alert('Saved');
      } catch {
        alert('Invalid JSON');
      }
    }

    function download(id, filename) {
      const area = document.getElementById(id);
      const blob = new Blob([area.value], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    document.getElementById('component-save').addEventListener('click', saveComponents);
    document.getElementById('component-download').addEventListener('click', downloadComponents);
    document.getElementById('library-upload').addEventListener('change', handleUpload);
    document.getElementById('manufacturer-save').addEventListener('click', () => save('manufacturer-text', 'manufacturerDefaults'));
    document.getElementById('manufacturer-download').addEventListener('click', () => download('manufacturer-text', 'manufacturerLibrary.json'));

    load();
  </script>
</body>
</html>

