<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interactive table for organizing cable data and exporting schedules.">
  <title>Cable Schedule</title>
  <link rel="icon" href="icons/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="./cableschedule.js" type="module" defer></script>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <nav class="top-nav">
    <button id="nav-toggle" class="nav-toggle" aria-label="Toggle navigation" aria-controls="nav-links" aria-expanded="false" title="Toggle navigation">☰</button>
    <div id="nav-links" class="nav-links">
      <a href="index.html">Home</a>
      <a href="equipmentlist.html">Equipment List</a>
      <a href="loadlist.html">Load List</a>
      <a href="cableschedule.html" class="active" aria-current="page">Cable Schedule</a>
      <a href="panelschedule.html">Panel Schedule</a>
      <a href="racewayschedule.html">Raceway Schedule</a>
      <a href="ductbankroute.html">Ductbank</a>
      <a href="cabletrayfill.html">Tray Fill</a>
      <a href="conduitfill.html">Conduit Fill</a>
      <a href="optimalRoute.html">Optimal Route</a>
            <a href="oneline.html">One-Line</a>
<button id="settings-btn" class="settings-btn" aria-label="Settings" aria-expanded="false" title="Settings">⚙</button>
    </div>
  </nav>
  <div id="settings-menu" class="settings-menu">
    <label><input type="checkbox" id="dark-toggle"> Dark Mode</label>
    <label><input type="checkbox" id="compact-toggle" aria-label="Enable compact table mode"> Compact Mode</label>
    <label for="unit-select">Units
      <select id="unit-select">
        <option value="imperial">Imperial</option>
        <option value="metric">Metric</option>
      </select>
    </label>
    <button id="help-btn" class="btn" aria-expanded="false" title="Show help">Site Help</button>
    <button id="new-project-btn" class="btn" title="Start a new project">New Project</button>
    <button id="save-project-btn" class="btn" title="Save current project">Save Project</button>
    <button id="load-project-btn" class="btn" title="Load an existing project">Load Project</button>
    <button id="export-project-btn" class="btn" title="Export project data">Export Project</button>
    <button id="import-project-btn" class="btn" title="Import project data">Import Project</button>
    <input type="file" id="import-project-input" accept=".ctr.json" class="hidden" title="Select project file">
  </div>
  <div class="container">
    <main id="main-content" class="main-content">
      <header class="page-header">
        <h1>Cable Schedule</h1>
        <p>Centralized table for managing cable data.</p>
      </header>
      <details class="method-panel">
        <summary>Method &amp; Assumptions</summary>
        <p>Total length is aggregated as L_total = Σ L_segment.</p>
        <p>Variables:</p>
        <ul>
          <li>L_segment – length of individual route segment</li>
          <li>L_total – sum of all segments</li>
        </ul>
        <p>Citations: <a href="docs/templates.html">Template documentation</a></p>
        <p>Applicability: tabular organization only; no capacity limits.</p>
        <p>See also: <a href="docs/load_calculation_formulas.html">Load Calculation Formulas</a>, <a href="docs/cable_fill_rules.html">Cable Fill Rules</a>, <a href="docs/routing_assumptions.html">Routing Assumptions</a>.</p>
      </details>
      <section class="card">
        <div class="mb-1">
          <button id="save-schedule-btn" class="btn" title="Save schedule">Save Schedule</button>
          <button id="load-schedule-btn" class="btn" title="Load schedule">Load Schedule</button>
          <button id="load-sample-cables-btn" class="btn" title="Load sample cables">Load Sample Data</button>
          <button id="clear-filters-btn" class="btn" title="Clear filters">Clear Filters</button>
          <button id="export-xlsx-btn" class="btn" title="Export as Excel">Export XLSX</button>
          <input type="file" id="import-xlsx-input" accept=".xlsx" class="hidden" title="Import from Excel">
          <button id="import-xlsx-btn" class="btn" title="Import from Excel">Import XLSX</button>
          <button id="delete-all-btn" class="btn" title="Delete all rows">Delete All Rows</button>
          <label for="vd-limit" class="ml-1">VD Limit (%)</label>
          <input type="number" id="vd-limit" value="3" step="0.1" class="w-60">
        </div>
        <div class="overflow-x-auto">
          <table id="cableScheduleTable" class="sticky-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="mt-1">
          <button id="add-row-btn" class="btn primary-btn add-row-btn" title="Add cable">Add Cable</button>
        </div>
      </section>
      <nav class="step-nav">
        <a href="index.html">Previous</a>
        <a href="loadlist.html">Load List</a>
        <a href="panelschedule.html">Next</a>
      </nav>
      <pre id="console-log" class="console-log" aria-live="polite"></pre>
    </main>
  </div>
  <div id="help-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="help-title">
    <div class="modal-content">
      <button id="close-help-btn" class="close-btn" aria-label="Close Help" title="Close help">&times;</button>
      <h2 id="help-title">Cable Schedule Help</h2>
      <p>This table allows managing cable data. Use the import/export buttons to work with Excel files. Select one or more raceway IDs in the "Raceway(s)" column; options are pulled from the Raceway Schedule page.</p>
    </div>
  </div>
  <script type="module" src="projectManager.js"></script>
  <script>
    window.addEventListener('load', () => {
      if (window.__CableScheduleInitOK !== true) {
        const banner = document.createElement('div');
        banner.textContent = 'CableSchedule JS failed to load—check script paths for GitHub Pages.';
        banner.style.background = 'red';
        banner.style.color = 'white';
        banner.style.padding = '1em';
        banner.style.textAlign = 'center';
        banner.style.zIndex = '1000';
        document.body.prepend(banner);
      }
    });
  </script>
  <script>
(() => {
  "use strict";

  // ---------- CONFIG ----------
  const DATA_URLS = {
    sampleCables: "examples/sampleCables.json",
    conductorProps: "data/conductor_properties.json"
  };

  // If you know the table container, set a stricter selector here:
  const TABLE_SELECTOR_ORDER = [
    'table#cable-schedule',               // preferred
    'table[data-role="cable-schedule"]',  // fallback 1
    'main table',                         // fallback 2
    'table'                               // fallback 3
  ];

  // Optional: map human header text -> field keys in sampleCables
  // If not provided, the script will match by identical names (case-insensitive)
  const HEADER_TO_FIELD_MAP = {
    // "Cable Tag": "tag",
    // "From": "from",
    // "To": "to",
    // "Length (ft)": "length_ft",
    // "Size": "size",
    // "Conductor": "conductor",
    // "Voltage": "voltage",
    // "Phases": "phases",
    // "Neutral": "neutral",
    // "Ground": "ground",
    // ...
  };

  // ---------- UTIL ----------
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  async function safeFetchJson(url) {
    try {
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`${url} – HTTP ${res.status}`);
      return await res.json();
    } catch (e) {
      console.warn("Fetch failed:", url, e);
      return { __error__: e.message, __url__: url };
    }
  }

  function normalizeHeader(text) {
    return String(text).trim().toLowerCase();
  }

  function buildHeaderMap(table) {
    const map = new Map();
    const thead = $("thead", table) || table.createTHead();
    const row = $("tr", thead);
    if (!row) return map;
    const ths = $$("th,td", row);
    ths.forEach((th, idx) => {
      const label = normalizeHeader(th.textContent);
      if (label) map.set(label, idx);
    });
    return map;
  }

  function keyForHeader(headerText) {
    // Use explicit mapping first
    if (HEADER_TO_FIELD_MAP[headerText]) return HEADER_TO_FIELD_MAP[headerText];
    // Else try normalized match (strip punctuation, case-insensitive)
    return headerText;
  }

  function ensureTbody(table) {
    let tb = $("tbody", table);
    if (!tb) tb = table.appendChild(document.createElement("tbody"));
    return tb;
  }

  // Render a single JSON value into a DOM tree (for the Data Explorer)
  function renderJson(value, key=null) {
    const wrap = document.createElement("div");
    wrap.className = "cdr-json-node";
    const head = document.createElement("div");
    head.className = "cdr-json-head";

    const label = document.createElement("span");
    label.className = "cdr-key";
    if (key !== null) label.textContent = key + ": ";
    head.appendChild(label);

    const type = typeof value;
    if (value === null || type !== "object") {
      const val = document.createElement("span");
      val.className = "cdr-primitive";
      val.textContent = String(value);
      head.appendChild(val);
      wrap.appendChild(head);
      return wrap;
    }

    const isArray = Array.isArray(value);
    const summary = document.createElement("span");
    summary.className = "cdr-summary";
    summary.textContent = isArray ? `Array[${value.length}]` : "Object";
    head.appendChild(summary);

    const toggle = document.createElement("button");
    toggle.type = "button";
    toggle.className = "cdr-toggle";
    toggle.textContent = "▶";
    head.prepend(toggle);

    const body = document.createElement("div");
    body.className = "cdr-json-body";
    body.style.display = "none";

    toggle.addEventListener("click", () => {
      const open = body.style.display !== "none";
      body.style.display = open ? "none" : "block";
      toggle.textContent = open ? "▶" : "▼";
    });

    if (isArray) {
      value.forEach((item, i) => body.appendChild(renderJson(item, i)));
    } else {
      Object.keys(value).sort().forEach(k => body.appendChild(renderJson(value[k], k)));
    }

    wrap.appendChild(head);
    wrap.appendChild(body);
    return wrap;
  }

  function injectStyles() {
    if ($('#cdr-explorer-style')) return;
    const css = `
      #cdr-explorer-style{ }
      .cdr-fab {
        position: fixed; right: 16px; bottom: 16px; z-index: 9999;
        width: 48px; height: 48px; border-radius: 50%;
        border: none; cursor: pointer; font-size: 22px;
        box-shadow: 0 4px 14px rgba(0,0,0,.25);
        background: #0ea5e9; color: #fff;
      }
      .cdr-panel {
        position: fixed; top: 0; right: 0; height: 100vh; width: min(560px, 90vw);
        background: #0b1020; color: #cbd5e1; z-index: 9998;
        transform: translateX(102%); transition: transform .25s ease-in-out;
        border-left: 1px solid #1e293b; display: flex; flex-direction: column;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      }
      .cdr-panel.open { transform: translateX(0); }
      .cdr-panel header {
        display:flex; gap:8px; align-items:center; padding:10px 12px; border-bottom:1px solid #1e293b;
      }
      .cdr-panel header h3 { margin:0; font-size:16px; font-weight:600; color:#e2e8f0; flex: 1; }
      .cdr-btn {
        background:#1f2937; color:#e5e7eb; border:1px solid #374151; border-radius:6px;
        padding:6px 10px; cursor:pointer; font-size:13px;
      }
      .cdr-btn:hover { background:#374151; }
      .cdr-search { flex: 1; max-width: 40%; }
      .cdr-body { padding:10px 12px; overflow:auto; flex:1; }
      .cdr-json-node { margin-left: 10px; }
      .cdr-json-head { display:flex; align-items:center; gap:8px; white-space:nowrap; }
      .cdr-key { color:#60a5fa; }
      .cdr-summary { color:#94a3b8; font-style:italic; }
      .cdr-primitive { color:#f8fafc; }
      .cdr-toggle {
        border:none; background:transparent; color:#93c5fd; cursor:pointer; font-size:13px;
      }
      .cdr-pill { font-size:12px; padding:2px 6px; border:1px solid #334155; border-radius:999px; color:#cbd5e1;}
      .cdr-footer { padding:8px 12px; border-top:1px solid #1e293b; display:flex; gap:8px; align-items:center; }
      .cdr-muted { color:#94a3b8; font-size:12px; }
    `;
    const style = document.createElement('style');
    style.id = 'cdr-explorer-style';
    style.textContent = css;
    document.head.appendChild(style);
  }

  function createExplorer() {
    injectStyles();

    const fab = document.createElement('button');
    fab.className = 'cdr-fab';
    fab.title = 'Open Data Explorer';
    fab.textContent = '🗂';
    document.body.appendChild(fab);

    const panel = document.createElement('aside');
    panel.className = 'cdr-panel';
    panel.innerHTML = `
      <header>
        <h3>Data Explorer</h3>
        <button class="cdr-btn" data-tab="sample">Sample Cables</button>
        <button class="cdr-btn" data-tab="props">Conductor Props</button>
        <input class="cdr-btn cdr-search" placeholder="filter keys… (regex ok)"/>
        <button class="cdr-btn" data-action="close">Close</button>
      </header>
      <div class="cdr-body"></div>
      <div class="cdr-footer">
        <span class="cdr-pill" id="cdr-status">idle</span>
        <span class="cdr-muted">Read-only viewer. Your table is untouched.</span>
      </div>
    `;
    document.body.appendChild(panel);

    const body = panel.querySelector('.cdr-body');
    const status = $('#cdr-status', panel);
    const search = panel.querySelector('.cdr-search');

    let currentTab = 'sample';
    let datasets = { sample: null, props: null };

    function open() { panel.classList.add('open'); }
    function close() { panel.classList.remove('open'); }
    fab.addEventListener('click', open);
    panel.querySelector('[data-action="close"]').addEventListener('click', close);

    panel.querySelector('[data-tab="sample"]').addEventListener('click', () => { currentTab = 'sample'; render(); });
    panel.querySelector('[data-tab="props"]').addEventListener('click', () => { currentTab = 'props'; render(); });

    function filterJson(value, pattern) {
      if (!pattern) return value;
      const re = new RegExp(pattern, 'i');
      const walk = (v) => {
        if (v === null || typeof v !== 'object') return v;
        if (Array.isArray(v)) {
          const arr = v.map(walk).filter(x => x !== undefined);
          return arr.length ? arr : undefined;
        }
        const out = {};
        let kept = false;
        for (const k of Object.keys(v)) {
          const child = walk(v[k]);
          if (child !== undefined || re.test(k)) { out[k] = (child === undefined ? v[k] : child); kept = true; }
        }
        return kept ? out : undefined;
      };
      const res = walk(value);
      return res === undefined ? (Array.isArray(value) ? [] : {}) : res;
    }

    function render() {
      body.innerHTML = '';
      const data = currentTab === 'sample' ? datasets.sample : datasets.props;
      status.textContent = data ? 'loaded' : 'loading…';
      const pattern = (search.value || '').trim();
      const toRender = pattern ? filterJson(data, pattern) : data;
      body.appendChild(renderJson(toRender, currentTab));
    }

    async function load(sampleData, propsData) {
      datasets.sample = sampleData;
      datasets.props = propsData;
      render();
    }

    return { open, load };
  }

  function findExistingTable() {
    for (const sel of TABLE_SELECTOR_ORDER) {
      const t = $(sel);
      if (t) return t;
    }
    return null;
  }

  function populateExistingTable(table, rowsArray) {
    if (!table || !rowsArray || !rowsArray.length) return 0;
    const headerMap = buildHeaderMap(table);
    const tbody = ensureTbody(table);
    let appended = 0;

    // Build headerText -> index map (original casing)
    const headerTextByIdx = new Map();
    $$("thead tr th, thead tr td", table).forEach((th, idx) => {
      headerTextByIdx.set(idx, th.textContent.trim());
    });

    rowsArray.forEach(rowObj => {
      const tr = document.createElement("tr");
      let anyCell = false;
      const maxIdx = Math.max( ...Array.from(headerMap.values()) );
      for (let col = 0; col <= maxIdx; col++) {
        const thText = (headerTextByIdx.get(col) || '').trim();
        const fieldKey =
          HEADER_TO_FIELD_MAP[thText] ||
          Object.keys(rowObj).find(k => normalizeHeader(k) === normalizeHeader(thText));
        const td = document.createElement("td");
        if (fieldKey && fieldKey in rowObj) {
          let val = rowObj[fieldKey];
          if (typeof val === "object") val = JSON.stringify(val);
          td.textContent = val ?? "";
          anyCell = true;
        } else {
          td.textContent = ""; // keep the column but don’t invent data
        }
        tr.appendChild(td);
      }
      if (anyCell) {
        tbody.appendChild(tr);
        appended++;
      }
    });
    return appended;
  }

  async function init() {
    // Create explorer UI
    const explorer = createExplorer();

    // Load datasets
    const [sample, props] = await Promise.all([
      safeFetchJson(DATA_URLS.sampleCables),
      safeFetchJson(DATA_URLS.conductorProps)
    ]);

    // Share globally for easy debugging (optional)
    window.CableData = { sample, props };

    // Feed explorer (shows ALL data without touching table)
    explorer.load(sample, props);

    function populateTable() {
      const table = findExistingTable();
      if (table && Array.isArray(sample)) {
        const appended = populateExistingTable(table, sample);
        console.info(`[CableDataViewer] appended ${appended} row(s) to existing table.`);
        return appended;
      } else if (table && sample && Array.isArray(sample.rows)) {
        const appended = populateExistingTable(table, sample.rows);
        console.info(`[CableDataViewer] appended ${appended} row(s) from sample.rows.`);
        return appended;
      } else {
        console.info("[CableDataViewer] No compatible table found or sample format not array. Table untouched.");
        return 0;
      }
    }

    if (!populateTable()) {
      window.addEventListener('cableschedule-ready', populateTable, { once: true });
    }

    // Open the explorer automatically on first load so you can see everything
    // (comment the next line if you prefer it closed by default)
    // explorer.open();
  }

  // Run once DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>

</body>
</html>
