<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Interactive table for organizing cable data and exporting schedules.">
  <title>Cable Schedule</title>
  <link rel="icon" href="icons/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
  <script src="dist/cableschedule.js" defer></script>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <nav class="top-nav">
    <button class="nav-toggle" aria-label="Toggle navigation">☰</button>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="cableschedule.html" class="active" aria-current="page">Cable Schedule</a>
      <a href="racewayschedule.html">Raceway Schedule</a>
      <a href="ductbankroute.html">Ductbank</a>
      <a href="cabletrayfill.html">Tray Fill</a>
      <a href="conduitfill.html">Conduit Fill</a>
      <a href="optimalRoute.html">Optimal Route</a>
      <button id="settings-btn" class="settings-btn" aria-label="Settings" aria-expanded="false">⚙</button>
    </div>
  </nav>
  <div id="settings-menu" class="settings-menu">
    <label><input type="checkbox" id="dark-toggle"> Dark Mode</label>
    <label><input type="checkbox" id="compact-toggle" aria-label="Enable compact table mode"> Compact Mode</label>
    <label for="unit-select">Units
      <select id="unit-select">
        <option value="imperial">Imperial</option>
        <option value="metric">Metric</option>
      </select>
    </label>
    <button id="help-btn" aria-expanded="false">Site Help</button>
    <button id="export-project-btn">Export Project</button>
    <button id="import-project-btn">Import Project</button>
    <input type="file" id="import-project-input" accept=".ctr.json" style="display:none;">
  </div>
  <div class="container">
    <main id="main-content" class="main-content">
      <header class="page-header">
        <h1>Cable Schedule</h1>
        <p>Centralized table for managing cable data.</p>
      </header>
      <section class="card">
        <div style="margin-bottom:10px;">
          <button id="save-schedule-btn">Save Schedule</button>
          <button id="load-schedule-btn">Load Schedule</button>
          <button id="load-sample-cables-btn">Load Sample Data</button>
          <button id="clear-filters-btn">Clear Filters</button>
          <button id="export-xlsx-btn">Export XLSX</button>
          <input type="file" id="import-xlsx-input" accept=".xlsx" style="display:none;">
          <button id="import-xlsx-btn">Import XLSX</button>
          <button id="delete-all-btn">Delete All Rows</button>
        </div>
        <div style="overflow-x:auto;">
          <table id="cableScheduleTable" class="sticky-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
        <div style="margin-top:10px;">
          <button id="add-row-btn" class="primary-btn add-row-btn">Add Cable</button>
        </div>
      </section>
      <nav class="step-nav">
        <a href="index.html">Previous</a>
        <a href="racewayschedule.html">Next</a>
      </nav>
    </main>
  </div>
  <div id="help-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="help-title">
    <div class="modal-content">
      <button id="close-help-btn" class="close-btn" aria-label="Close Help">&times;</button>
      <h2 id="help-title">Cable Schedule Help</h2>
      <p>This table allows managing cable data. Use the import/export buttons to work with Excel files. Select one or more raceway IDs in the "Raceway(s)" column; options are pulled from the Raceway Schedule page.</p>
    </div>
  </div>
<script>
window.addEventListener('DOMContentLoaded',()=>{
initSettings();
initDarkMode();
initCompactMode();
initHelpModal('help-btn','help-modal','close-help-btn');
initNavToggle();
let saved=true;
const markSaved=()=>{saved=true;};
const markUnsaved=()=>{saved=false;};
window.addEventListener('beforeunload',e=>{if(!saved){e.preventDefault();e.returnValue='';}});
const INSULATION_TEMP_LIMIT={THHN:90,XLPE:90,PVC:75,XHHW:90,'XHHW-2':90,'THWN-2':90,THW:75,THWN:75,TW:60,UF:60};
const conductorSizes=['#22 AWG','#20 AWG','#18 AWG','#16 AWG','#14 AWG','#12 AWG','#10 AWG','#8 AWG','#6 AWG','#4 AWG','#2 AWG','#1 AWG','1/0 AWG','2/0 AWG','3/0 AWG','4/0 AWG','250 kcmil','350 kcmil','500 kcmil','750 kcmil','1000 kcmil'];
const cableTypes=['Power','Control','Signal'];
const conductorMaterials=['Copper','Aluminum'];
const insulationRatings=['60','75','90'];
  const shieldingOptions=['','Lead','Copper Tape'];

  function getRacewayOptions(){
    const ids=new Set();
    try{(JSON.parse(localStorage.getItem(TableUtils.STORAGE_KEYS.traySchedule))||[]).forEach(t=>{if(t.tray_id) ids.add(t.tray_id);});}catch(e){}
    try{(JSON.parse(localStorage.getItem(TableUtils.STORAGE_KEYS.conduitSchedule))||[]).forEach(c=>{
      const id=c.tray_id||(c.ductbank_id&&c.conduit_id?`${c.ductbank_id}-${c.conduit_id}`:c.conduit_id);
      if(id) ids.add(id);
    });}catch(e){}
    try{(JSON.parse(localStorage.getItem(TableUtils.STORAGE_KEYS.ductbankSchedule))||[]).forEach(db=>{
      const dbId=db.ductbank_id||db.id||db.tag;
      (db.conduits||[]).forEach(c=>{
        const id=c.tray_id||(dbId&&c.conduit_id?`${dbId}-${c.conduit_id}`:c.conduit_id);
        if(id) ids.add(id);
      });
    });}catch(e){}
    return Array.from(ids);
  }

const columns=[
  {key:'tag',label:'Tag',type:'text',group:'Identification',tooltip:'Unique identifier for the cable'},
  {key:'service_description',label:'Service Description',type:'text',group:'Identification',tooltip:'Description of the cable\'s purpose'},
  {key:'from_tag',label:'From Tag',type:'text',group:'Routing / Termination',tooltip:'Starting equipment or location tag'},
  {key:'to_tag',label:'To Tag',type:'text',group:'Routing / Termination',tooltip:'Ending equipment or location tag'},
  {key:'start_x',label:'Start X',type:'number',group:'Routing / Termination',tooltip:'X-coordinate of cable start'},
  {key:'start_y',label:'Start Y',type:'number',group:'Routing / Termination',tooltip:'Y-coordinate of cable start'},
  {key:'start_z',label:'Start Z',type:'number',group:'Routing / Termination',tooltip:'Z-coordinate of cable start'},
  {key:'end_x',label:'End X',type:'number',group:'Routing / Termination',tooltip:'X-coordinate of cable end'},
  {key:'end_y',label:'End Y',type:'number',group:'Routing / Termination',tooltip:'Y-coordinate of cable end'},
  {key:'end_z',label:'End Z',type:'number',group:'Routing / Termination',tooltip:'Z-coordinate of cable end'},
  {key:'zone',label:'Cable Zone',type:'number',group:'Routing / Termination',tooltip:'Routing zone or area number'},
  {key:'raceway_ids',label:'Raceway(s)',type:'select',multiple:true,size:5,options:()=>getRacewayOptions(),group:'Routing / Termination',tooltip:'Select raceway IDs from Raceway Schedule'},
  {key:'manual_path',label:'Manual Path',type:'text',datalist:()=>getRacewayOptions(),group:'Routing / Termination',tooltip:'Tray IDs separated by > to override route'},
  {key:'circuit_group',label:'Circuit Group',type:'number',group:'Routing / Termination',tooltip:'Circuit grouping number'},
  {key:'allowed_cable_group',label:'Allowed Group',type:'text',group:'Routing / Termination',tooltip:'Permitted cable grouping identifier'},
  {key:'cable_type',label:'Cable Type',type:'select',options:cableTypes,group:'Cable Construction & Specs',tooltip:'Category such as Power, Control, or Signal'},
  {key:'conductors',label:'Conductors',type:'number',group:'Cable Construction & Specs',tooltip:'Number of conductors within the cable'},
  {key:'conductor_size',label:'Conductor Size',type:'select',options:conductorSizes,group:'Cable Construction & Specs',tooltip:'Size of each conductor'},
  {key:'conductor_material',label:'Conductor Material',type:'select',options:conductorMaterials,group:'Cable Construction & Specs',tooltip:'Material of the conductors'},
  {key:'insulation_type',label:'Insulation Type',type:'select',options:Object.keys(INSULATION_TEMP_LIMIT),group:'Cable Construction & Specs',tooltip:'Insulation material type'},
  {key:'insulation_rating',label:'Insul Rating (°C)',type:'select',options:insulationRatings,group:'Cable Construction & Specs',tooltip:'Maximum temperature rating of insulation'},
  {key:'insulation_thickness',label:'Insul Thick (in)',type:'number',group:'Cable Construction & Specs',tooltip:'Insulation thickness in inches'},
  {key:'cable_od',label:'Cable O.D. (in)',type:'number',group:'Cable Construction & Specs',tooltip:'Outside diameter of the cable in inches'},
  {key:'shielding_jacket',label:'Shielding/Jacket',type:'select',options:shieldingOptions,group:'Cable Construction & Specs',tooltip:'Shielding or outer jacket type'},
  {key:'cable_rating',label:'Cable Rating (V)',type:'number',group:'Electrical Characteristics',tooltip:'Maximum voltage rating'},
  {key:'operating_voltage',label:'Operating Voltage (V)',type:'number',group:'Electrical Characteristics',tooltip:'Nominal operating voltage'},
  {key:'est_load',label:'Est Load (A)',type:'number',group:'Electrical Characteristics',tooltip:'Estimated operating current'},
  {key:'duty_cycle',label:'Duty Cycle (%)',type:'number',group:'Electrical Characteristics',tooltip:'Duty cycle percentage'},
  {key:'length',label:'Length (ft)',type:'number',group:'Electrical Characteristics',tooltip:'Length of cable run'},
  {key:'notes',label:'Notes',type:'text',group:'Notes',tooltip:'Additional comments or notes'}
];

const cableTable=TableUtils.createTable({
  tableId:'cableScheduleTable',
  storageKey:TableUtils.STORAGE_KEYS.cableSchedule,
  addRowBtnId:'add-row-btn',
  saveBtnId:'save-schedule-btn',
  loadBtnId:'load-schedule-btn',
  clearFiltersBtnId:'clear-filters-btn',
  exportBtnId:'export-xlsx-btn',
  importInputId:'import-xlsx-input',
  importBtnId:'import-xlsx-btn',
  deleteAllBtnId:'delete-all-btn',
  columns,
  onChange:markUnsaved,
  onSave:markSaved
});

document.getElementById('load-sample-cables-btn').addEventListener('click',async()=>{
  try{
    const res=await fetch('examples/sample_cables.json');
    const data=await res.json();
    cableTable.deleteAll();
    data.forEach(row=>cableTable.addRow(row));
    cableTable.save();
    markSaved();
  }catch(e){console.error('Failed to load sample cables',e);}
});

function getCableSchedule(){
  cableTable.save();
  return cableTable.getData();
}
window.getCableSchedule=getCableSchedule;
});
</script>
</body>
</html>
